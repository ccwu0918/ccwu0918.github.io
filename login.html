<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿç·šä¸Šæ¸¬é©—ç™»å…¥ç³»çµ±</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­å®š Tailwind CSS ä½¿ç”¨ Inter å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- ä¸»è¦æ‡‰ç”¨ç¨‹å¼å®¹å™¨ -->
    <div id="app-container" class="w-full max-w-lg bg-white shadow-2xl rounded-xl p-8 space-y-6 border border-indigo-100 transition-all duration-300">
        <h1 class="text-3xl font-extrabold text-center text-indigo-700">
            å­¸ç”Ÿæ¸¬é©—èªè­‰å…¥å£
        </h1>
        
        <!-- ç³»çµ±è¨Šæ¯é¡¯ç¤ºå€ -->
        <div id="message-box" class="hidden p-3 text-sm rounded-lg transition-all duration-300"></div>

        <!-- Firebase è¨­å®šå€å¡Š -->
        <div id="config-section" class="border border-gray-200 rounded-lg p-4 space-y-3">
            <button id="toggle-config-btn" class="w-full flex justify-between items-center text-left text-sm font-semibold text-gray-700 hover:text-indigo-600 transition-colors">
                <span>Firebase é…ç½®è¨­å®š (å‚™ç”¨)</span>
                <svg id="config-arrow" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="config-form-container" class="hidden space-y-3">
                <textarea id="firebase-config-input" rows="5" class="w-full p-2 border border-gray-300 rounded-md text-xs font-mono focus:ring-indigo-500 focus:border-indigo-500" placeholder='{"apiKey": "YOUR_API_KEY", "authDomain": "YOUR_AUTH_DOMAIN", "projectId": "YOUR_PROJECT_ID", ...}'></textarea>
                <button id="save-config-btn" class="w-full px-4 py-2 text-sm font-medium rounded-lg text-white bg-green-500 hover:bg-green-600 transition duration-150 ease-in-out">
                    å„²å­˜é…ç½®åˆ°ç€è¦½å™¨
                </button>
                <p class="text-xs text-gray-500">
                    æ³¨æ„ï¼šæ­¤é…ç½®åƒ…ä½œç‚ºå…¨åŸŸè®Šæ•¸ (`firebase_config`) ä¸å­˜åœ¨æ™‚çš„å‚™ç”¨ã€‚
                </p>
            </div>
        </div>

        <!-- ç™»å…¥ç‹€æ…‹é¡¯ç¤ºå€ -->
        <div id="auth-status-container" class="space-y-4">
            <!-- ç™»å…¥æŒ‰éˆ• -->
            <button id="google-sign-in-btn" class="hidden flex items-center justify-center w-full px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 transition duration-150 ease-in-out">
                <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>é€é Google Education å¸³è™Ÿç™»å…¥</span>
            </button>

            <!-- å·²ç™»å…¥è³‡è¨Š -->
            <div id="user-info-card" class="hidden space-y-4">
                <div class="bg-green-50 border-l-4 border-green-500 text-green-700 p-4 rounded-lg">
                    <p class="font-bold">ğŸ‰ èªè­‰æˆåŠŸï¼</p>
                    <p>æ‚¨å·²æº–å‚™å¥½é–‹å§‹æ¸¬é©—ã€‚</p>
                </div>
                
                <div class="bg-gray-100 p-4 rounded-lg space-y-2">
                    <h2 class="text-lg font-semibold text-gray-800 border-b pb-1">æˆç¸¾ç´€éŒ„è³‡è¨Š</h2>
                    <div class="flex justify-between text-sm text-gray-600">
                        <span class="font-medium">å­¸ç”Ÿåç¨±:</span>
                        <span id="display-name" class="truncate max-w-[60%]"></span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-600">
                        <span class="font-medium">ç™»å…¥å¸³è™Ÿ (Email):</span>
                        <span id="display-email" class="truncate max-w-[60%]"></span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-600">
                        <span class="font-medium">å­¸ç”Ÿ ID (æˆç¸¾ä¸»éµ):</span>
                        <span id="display-uid" class="truncate max-w-[60%] font-mono text-xs text-indigo-600"></span>
                    </div>
                </div>
                
                <button id="sign-out-btn" class="w-full px-6 py-3 text-sm font-medium rounded-lg text-red-600 border border-red-300 bg-white hover:bg-red-50 transition duration-150 ease-in-out">
                    ç™»å‡º
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK åŒ¯å…¥ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // å…¨åŸŸè®Šæ•¸æª¢æŸ¥èˆ‡ä½¿ç”¨
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, auth, db;
        
        // ********* ä¿®æ­£ 1: ç¡¬ç·¨ç¢¼ Firebase é…ç½®ä½œç‚ºé è¨­å€¼ *********
        const DEFAULT_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCs54DFYaBJn3B1pPrtYhWcDY7HVwuVJnY",
            authDomain: "aiquiz-7c15c.firebaseapp.com",
            projectId: "aiquiz-7c15c",
            storageBucket: "aiquiz-7c15c.firebasestorage.app",
            messagingSenderId: "504770628758",
            appId: "1:504770628758:web:347706dd78d7a2f6f406b7",
            measurementId: "G-3FNYN6XJNW"
        };
        let firebaseConfig = {};
        // ************************************************************

        let currentStudentEmail = null; 

        // DOM å…ƒç´ å¿«å–
        const msgBox = document.getElementById('message-box');
        const googleSignInBtn = document.getElementById('google-sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const userInfoCard = document.getElementById('user-info-card');
        const loadingSpinner = document.getElementById('loading-spinner');
        const configInput = document.getElementById('firebase-config-input');
        const saveConfigBtn = document.getElementById('save-config-btn');
        const toggleConfigBtn = document.getElementById('toggle-config-btn');
        const configFormContainer = document.getElementById('config-form-container');
        const configArrow = document.getElementById('config-arrow');

        // --- UI è¼”åŠ©å‡½å¼ ---
        function showMessage(text, isError = false) {
            msgBox.textContent = text;
            msgBox.className = `p-3 text-sm rounded-lg ${isError ? 'bg-red-100 text-red-700' : 'bg-indigo-50 text-indigo-700'}`;
            msgBox.classList.remove('hidden');
        }

        function toggleLoading(isLoading) {
            googleSignInBtn.disabled = isLoading;
            if (signOutBtn) signOutBtn.disabled = isLoading;
            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
            } else {
                loadingSpinner.classList.add('hidden');
            }
        }

        function updateUI(user) {
            const loggedIn = user && !user.isAnonymous;
            
            googleSignInBtn.classList.toggle('hidden', loggedIn);
            userInfoCard.classList.toggle('hidden', !loggedIn);
            
            if (loggedIn) {
                // å„ªå…ˆä½¿ç”¨ user.emailï¼Œå¦å‰‡ä½¿ç”¨å…¨å±€å„²å­˜çš„ emailï¼Œæœ€å¾Œæ‰æ˜¯ 'ç„¡é›»å­éƒµä»¶'
                const displayEmail = user.email || currentStudentEmail || 'ç„¡é›»å­éƒµä»¶';

                document.getElementById('display-name').textContent = user.displayName || 'ç„¡åç¨±';
                document.getElementById('display-email').textContent = displayEmail;
                document.getElementById('display-uid').textContent = user.uid;
            } else {
                // å¦‚æœæ˜¯åŒ¿åæˆ–æœªç™»å…¥ï¼Œé¡¯ç¤ºç™»å…¥æŒ‰éˆ•
                googleSignInBtn.classList.remove('hidden');
                googleSignInBtn.textContent = 'é€é Google Education å¸³è™Ÿç™»å…¥';
                currentStudentEmail = null; // ç™»å‡ºæ™‚é‡ç½® email 
            }
        }
        
        // --- Firebase é…ç½®ç®¡ç† ---
        function loadConfig() {
            // ********* ä¿®æ­£ 2: æª¢æŸ¥æ–°çš„å…¨åŸŸè®Šæ•¸åç¨± `firebase_config` *********
            if (typeof firebase_config !== 'undefined') {
                try {
                    firebaseConfig = JSON.parse(firebase_config);
                    console.log("ä½¿ç”¨å…¨åŸŸè®Šæ•¸ firebase_config é…ç½®ã€‚");
                    configInput.value = JSON.stringify(firebaseConfig, null, 2);
                    return true;
                } catch (e) {
                    console.warn("è§£æå…¨åŸŸ firebase_config å¤±æ•—:", e);
                }
            }
            // ********************************************************************

            const savedConfig = sessionStorage.getItem('firebaseConfig');
            if (savedConfig) {
                try {
                    firebaseConfig = JSON.parse(savedConfig);
                    console.log("ä½¿ç”¨ sessionStorage å„²å­˜çš„ Firebase é…ç½®ã€‚");
                    configInput.value = JSON.stringify(firebaseConfig, null, 2);
                    return true;
                } catch (e) {
                    console.error("è§£æ sessionStorage é…ç½®å¤±æ•—:", e);
                    sessionStorage.removeItem('firebaseConfig');
                }
            }
            
            // å¦‚æœæ²’æœ‰å…¨åŸŸè®Šæ•¸å’Œ sessionStorage å„²å­˜ï¼Œä½¿ç”¨ç¡¬ç·¨ç¢¼çš„ DEFAULT_FIREBASE_CONFIG
            firebaseConfig = DEFAULT_FIREBASE_CONFIG;
            configInput.value = JSON.stringify(firebaseConfig, null, 2);
            console.log("ä½¿ç”¨é è¨­ç¡¬ç·¨ç¢¼çš„ Firebase é…ç½®ã€‚");
            return true;
        }

        function formatJsonInput() {
            try {
                const configText = configInput.value.trim();
                if (!configText) return;
                const config = JSON.parse(configText);
                configInput.value = JSON.stringify(config, null, 2);
                return true;
            } catch (error) {
                return false;
            }
        }

        function saveConfig() {
            formatJsonInput();
            try {
                const configText = configInput.value.trim();
                if (configText === '{}' || configText === JSON.stringify(DEFAULT_FIREBASE_CONFIG, null, 2) || configText === '') {
                    // å¦‚æœè¼¸å…¥æ˜¯ç©ºæˆ–èˆ‡é è¨­é…ç½®ç›¸åŒï¼Œå‰‡ä¸åš sessionStorage å„²å­˜ï¼Œä½†ä»éœ€è¨­å®š firebaseConfig
                    sessionStorage.removeItem('firebaseConfig');
                    firebaseConfig = DEFAULT_FIREBASE_CONFIG;
                    showMessage("é…ç½®å·²é‡ç½®æˆ–èˆ‡é è¨­å€¼ç›¸åŒï¼Œå·²ä½¿ç”¨é è¨­é…ç½®ã€‚", false);
                    return;
                }
                
                const config = JSON.parse(configText);
                if (!config.apiKey || !config.projectId) {
                    showMessage("å„²å­˜å¤±æ•—ï¼šFirebase é…ç½®æ‡‰åŒ…å« 'apiKey' å’Œ 'projectId' ç­‰å¿…è¦æ¬„ä½ã€‚", true);
                    return;
                }
                sessionStorage.setItem('firebaseConfig', configText);
                firebaseConfig = config;
                showMessage("Firebase é…ç½®å·²æˆåŠŸå„²å­˜åˆ°ç€è¦½å™¨ã€‚è«‹é‡æ–°æ•´ç†é é¢ä»¥åˆå§‹åŒ–æœå‹™ã€‚", false);
            } catch (error) {
                showMessage("å„²å­˜å¤±æ•—ï¼šè«‹ç¢ºä¿è¼¸å…¥**æœ‰æ•ˆçš„ JSON æ ¼å¼**ï¼å¸¸è¦‹éŒ¯èª¤åŒ…æ‹¬ï¼šç¼ºå°‘é›™å¼•è™Ÿã€å°¾éš¨é€—è™Ÿæˆ–ä½¿ç”¨å–®å¼•è™Ÿç­‰ã€‚", true);
                console.error("å„²å­˜é…ç½®éŒ¯èª¤:", error);
            }
        }

        // --- Firebase æœå‹™åˆå§‹åŒ– (ç„¡è®Šå‹•) ---
        function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
                showMessage("âš ï¸ è­¦å‘Šï¼šFirebase é…ç½®éºå¤±ã€‚è«‹åœ¨ä¸Šæ–¹å€å¡Šè¼¸å…¥é…ç½®å¾Œå„²å­˜ã€‚", true);
                return;
            }
            
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                setPersistence(auth, browserSessionPersistence);
                
                initialAuth();

                onAuthStateChanged(auth, (user) => {
                    updateUI(user);
                    if (user && !user.isAnonymous) {
                        showMessage(`æ­¡è¿å›ä¾†, ${user.displayName || 'å­¸ç”Ÿ'}ï¼`, false);
                    }
                });

            } catch (error) {
                showMessage(`Firebase åˆå§‹åŒ–å¤±æ•—: ${error.message}`, true);
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
            }
        }

        // ********* ä¿®æ­£ 3: ä¿®è¨‚ initialAuth å‡½æ•¸ä»¥è™•ç† Custom Token å¤±æ•—æ™‚çš„ Fallback *********
        async function initialAuth() {
            if (!auth) return;
            
            // 1. å˜—è©¦ä½¿ç”¨è‡ªå®šç¾© Token ç™»å…¥ (å¦‚æœå­˜åœ¨)
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("ä½¿ç”¨è‡ªå®šç¾© Token ç™»å…¥æˆåŠŸã€‚");
                    return; // æˆåŠŸå°±ç›´æ¥è¿”å›
                } catch (error) {
                    // å¿½ç•¥ auth/custom-token-mismatch éŒ¯èª¤ï¼Œå› ç‚ºé€™æ˜¯é æœŸä¸­å°ˆæ¡ˆä¸åŒ¹é…çš„è¡Œç‚ºã€‚
                    console.warn("åˆå§‹èªè­‰å¤±æ•— (è‡ªå®šç¾© Token ç„¡æ•ˆï¼Œå°‡å˜—è©¦åŒ¿åç™»å…¥):", error.message);
                    // ç¹¼çºŒåŸ·è¡ŒåŒ¿åç™»å…¥ä½œç‚º fallback
                }
            }
            
            // 2. åŸ·è¡ŒåŒ¿åç™»å…¥
            try {
                await signInAnonymously(auth);
                console.log("ä½¿ç”¨åŒ¿åæ–¹å¼ç™»å…¥æˆåŠŸã€‚");
            } catch (error) {
                console.error("åŒ¿åç™»å…¥å¤±æ•—:", error);
                showMessage("éŒ¯èª¤ï¼šç„¡æ³•å®Œæˆåˆå§‹åŒ¿åç™»å…¥ã€‚", true);
            }
        }
        // *****************************************************************************************


        // --- Firestore é‚è¼¯ ---
        const getStudentDocPath = (uid) => 
            `artifacts/${appId}/public/data/students/${uid}`;

        async function saveStudentData(userCredential, emailToSave) {
            if (!db) return;
            
            const { uid, displayName } = userCredential;
            const studentDocRef = doc(db, getStudentDocPath(uid));
            
            try {
                const docSnap = await getDoc(studentDocRef);
                
                const studentData = {
                    userId: uid,
                    displayName: displayName || 'æœªçŸ¥å­¸ç”Ÿ',
                    email: emailToSave || '', // ä½¿ç”¨å‚³å…¥çš„ Email
                    lastLoginAt: new Date().toISOString(),
                };

                if (!docSnap.exists()) {
                    studentData.createdAt = new Date().toISOString();
                    await setDoc(studentDocRef, studentData);
                    showMessage(`æ–°å­¸ç”Ÿè³‡æ–™å·²æ–°å¢: ${displayName} (${uid})`);
                } else {
                    await setDoc(studentDocRef, { 
                        lastLoginAt: studentData.lastLoginAt,
                        email: emailToSave // ç¢ºä¿ Email è³‡è¨Šä¹Ÿè¢«æ›´æ–°
                    }, { merge: true });
                    showMessage(`å­¸ç”Ÿè³‡æ–™å·²æ›´æ–°: ${displayName} (${uid})`);
                }
            } catch (error) {
                showMessage("è³‡æ–™ä¿å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–é€£ç·šã€‚", true);
                console.error("å¯«å…¥å­¸ç”Ÿè³‡æ–™åˆ° Firestore å¤±æ•—:", error);
            }
        }

        // --- èªè­‰äº‹ä»¶è™•ç† ---
        async function handleGoogleSignIn() {
            if (!auth) {
                showMessage("èªè­‰æœå‹™å°šæœªåˆå§‹åŒ–ã€‚", true);
                return;
            }
            
            toggleLoading(true);
            showMessage('æ­£åœ¨é€£æ¥ Google...');

            try {
                const provider = new GoogleAuthProvider();
                
                // ********* ä¿®æ­£ï¼šæ˜ç¢ºè¦æ±‚ Email å’Œ Profile æ¬Šé™ *********
                provider.addScope('email'); 
                provider.addScope('profile');
                // ******************************************************

                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                // **ä¿®æ­£ï¼šå¾ result ä¸­æå–æœ€å¯é çš„ Email**
                let retrievedEmail = user.email || (result.additionalUserInfo.profile ? result.additionalUserInfo.profile.email : '');
                currentStudentEmail = retrievedEmail; // æ›´æ–°å…¨å±€è®Šæ•¸ç”¨æ–¼ UI é¡¯ç¤º (ä½œç‚º user.email çš„ fallback)

                await saveStudentData(user, retrievedEmail); // å‚³éæœ€å¯é çš„ Email
                
                // Manually trigger UI update with the user object, which will now use the global fallback
                updateUI(user);
                
            } catch (error) {
                console.error("Google ç™»å…¥å¤±æ•—:", error);
                
                let errorMessage = 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡è©¦ã€‚'; // Fallback message
                
                if (error.code) {
                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = "ç™»å…¥è¦–çª—å·²è¢«é—œé–‰æˆ–å½ˆå‡ºå¼è¦–çª—è¢«é˜»æ“‹ã€‚";
                    } else if (error.code === 'auth/cancelled-popup-request') {
                        errorMessage = "ç™»å…¥å˜—è©¦è¢«å–æ¶ˆã€‚";
                    } else if (error.code === 'auth/unauthorized-domain') {
                        // ä¿®æ­£ï¼šæä¾›æ›´æ˜ç¢ºçš„ä¿®å¾©æŒ‡å—
                        errorMessage = "èªè­‰éŒ¯èª¤ [auth/unauthorized-domain]: æ­¤ç¶²åŸŸæœªæˆæ¬Šã€‚è«‹å‹™å¿…å°‡æ‚¨ç›®å‰é é¢æ‰€åœ¨çš„ç¶²åŸŸåŠ å…¥ Firebase Console -> Authentication -> Settings -> **Authorized domains** æ¸…å–®ä¸­ï¼";
                    } else if (error.code === 'auth/operation-not-allowed') {
                        errorMessage = "Firebase è¨­å®šéŒ¯èª¤ï¼šGoogle ç™»å…¥æ–¹å¼æœªåœ¨ Firebase Console ä¸­å•Ÿç”¨ã€‚";
                    } else {
                        errorMessage = `èªè­‰éŒ¯èª¤ [${error.code}]: ${error.message}`;
                    }
                } else if (error.message && error.message.includes('A Firebase project ID is required')) {
                    errorMessage = "Firebase é…ç½®éŒ¯èª¤ï¼šè«‹æª¢æŸ¥ Project ID æˆ– API Key æ˜¯å¦æ­£ç¢ºã€‚";
                }

                showMessage(errorMessage, true);
            } finally {
                toggleLoading(false);
            }
        }
        
        async function handleSignOut() {
            if (!auth) return;
            toggleLoading(true);
            try {
                await signOut(auth);
                await initialAuth(); 
                showMessage('æ‚¨å·²æˆåŠŸç™»å‡ºã€‚', false);
            } catch (error) {
                console.error("ç™»å‡ºå¤±æ•—:", error);
                showMessage("ç™»å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚", true);
            } finally {
                toggleLoading(false);
            }
        }

        // --- åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ (ç„¡è®Šå‹•) ---
        window.onload = function() {
            loadConfig();
            initializeFirebase();

            googleSignInBtn.addEventListener('click', handleGoogleSignIn);
            if (signOutBtn) signOutBtn.addEventListener('click', handleSignOut);
            
            saveConfigBtn.addEventListener('click', saveConfig);
            toggleConfigBtn.addEventListener('click', () => {
                const isHidden = configFormContainer.classList.toggle('hidden');
                configArrow.classList.toggle('rotate-180', !isHidden);
                if (!isHidden) {
                     formatJsonInput();
                }
            });

            configInput.addEventListener('blur', formatJsonInput);
        };
    </script>
</body>
</html>
