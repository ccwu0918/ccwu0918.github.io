<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿç·šä¸Šæ¸¬é©—ç™»å…¥ç³»çµ±</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­å®š Tailwind CSS ä½¿ç”¨ Inter å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- ä¸»è¦æ‡‰ç”¨ç¨‹å¼å®¹å™¨ -->
    <div id="app-container" class="w-full max-w-lg bg-white shadow-2xl rounded-xl p-8 space-y-6 border border-indigo-100 transition-all duration-300">
        <h1 class="text-3xl font-extrabold text-center text-indigo-700">
            å­¸ç”Ÿæ¸¬é©—èªè­‰å…¥å£
        </h1>
        
        <!-- ç³»çµ±è¨Šæ¯é¡¯ç¤ºå€ -->
        <div id="message-box" class="hidden p-3 text-sm rounded-lg transition-all duration-300"></div>

        <!-- ç™»å…¥ç‹€æ…‹é¡¯ç¤ºå€ -->
        <div id="auth-status-container" class="space-y-4">
            <!-- ç™»å…¥æŒ‰éˆ• -->
            <button id="google-sign-in-btn" class="hidden flex items-center justify-center w-full px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 transition duration-150 ease-in-out">
                <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>é€é Google Education å¸³è™Ÿç™»å…¥</span>
            </button>

            <!-- å·²ç™»å…¥è³‡è¨Š -->
            <div id="user-info-card" class="hidden space-y-4">
                <div class="bg-green-50 border-l-4 border-green-500 text-green-700 p-4 rounded-lg">
                    <p class="font-bold">ğŸ‰ èªè­‰æˆåŠŸï¼</p>
                    <p>æ‚¨å·²æº–å‚™å¥½é–‹å§‹æ¸¬é©—ã€‚</p>
                </div>
                
                <div class="bg-gray-100 p-4 rounded-lg space-y-2">
                    <h2 class="text-lg font-semibold text-gray-800 border-b pb-1">æˆç¸¾ç´€éŒ„è³‡è¨Š</h2>
                    <div class="flex justify-between text-sm text-gray-600">
                        <span class="font-medium">å­¸ç”Ÿåç¨±:</span>
                        <span id="display-name" class="truncate max-w-[60%]"></span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-600">
                        <span class="font-medium">ç™»å…¥å¸³è™Ÿ (Email):</span>
                        <span id="display-email" class="truncate max-w-[60%]"></span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-600">
                        <span class="font-medium">å­¸ç”Ÿ ID (æˆç¸¾ä¸»éµ):</span>
                        <span id="display-uid" class="truncate max-w-[60%] font-mono text-xs text-indigo-600"></span>
                    </div>
                </div>
                
                <button id="sign-out-btn" class="w-full px-6 py-3 text-sm font-medium rounded-lg text-red-600 border border-red-300 bg-white hover:bg-red-50 transition duration-150 ease-in-out">
                    ç™»å‡º
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK åŒ¯å…¥ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // å…¨åŸŸè®Šæ•¸æª¢æŸ¥èˆ‡ä½¿ç”¨
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // ********* ç¡¬ç·¨ç¢¼çš„é è¨­ Firebase é…ç½® *********
        let firebaseConfig = {
            apiKey: "AIzaSyCs54DFYaBJn3B1pPrtYhWcDY7HVwuVJnY",
            authDomain: "aiquiz-7c15c.firebaseapp.com",
            projectId: "aiquiz-7c15c",
            storageBucket: "aiquiz-7c15c.firebasestorage.app",
            messagingSenderId: "504770628758",
            appId: "1:504770628758:web:347706dd78d7a2f6f406b7",
            measurementId: "G-3FNYN6XJNW"
        };
        // ********************************************

        let app, auth, db;

        // DOM å…ƒç´ å¿«å–
        const msgBox = document.getElementById('message-box');
        const googleSignInBtn = document.getElementById('google-sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const userInfoCard = document.getElementById('user-info-card');
        const loadingSpinner = document.getElementById('loading-spinner');

        // --- UI è¼”åŠ©å‡½å¼ (èˆ‡å‰ä¸€ç‰ˆæœ¬ç›¸åŒ) ---
        function showMessage(text, isError = false) {
            msgBox.textContent = text;
            msgBox.className = `p-3 text-sm rounded-lg ${isError ? 'bg-red-100 text-red-700' : 'bg-indigo-50 text-indigo-700'}`;
            msgBox.classList.remove('hidden');
        }

        function toggleLoading(isLoading) {
            googleSignInBtn.disabled = isLoading;
            if (signOutBtn) signOutBtn.disabled = isLoading;
            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
            } else {
                loadingSpinner.classList.add('hidden');
            }
        }

        function updateUI(user) {
            const loggedIn = user && !user.isAnonymous;
            
            googleSignInBtn.classList.toggle('hidden', loggedIn);
            userInfoCard.classList.toggle('hidden', !loggedIn);
            
            if (loggedIn) {
                document.getElementById('display-name').textContent = user.displayName || 'ç„¡åç¨±';
                document.getElementById('display-email').textContent = user.email || 'ç„¡é›»å­éƒµä»¶';
                document.getElementById('display-uid').textContent = user.uid;
            } else {
                googleSignInBtn.classList.remove('hidden');
                googleSignInBtn.textContent = 'é€é Google Education å¸³è™Ÿç™»å…¥';
            }
        }
        
        // --- Firebase æœå‹™åˆå§‹åŒ– ---
        function initializeFirebase(config) {
            if (!config || !config.apiKey) {
                showMessage("âš ï¸ è­¦å‘Šï¼šFirebase é…ç½®éºå¤±æˆ–ä¸å®Œæ•´ã€‚", true);
                return;
            }
            
            try {
                // è¦†å¯«é è¨­é…ç½®ï¼Œç¢ºä¿ä½¿ç”¨æœ€æ–°æˆ–è¼‰å…¥çš„é…ç½®
                firebaseConfig = config; 
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                setPersistence(auth, browserSessionPersistence);
                initialAuth();

                onAuthStateChanged(auth, (user) => {
                    updateUI(user);
                    if (user && !user.isAnonymous) {
                        showMessage(`æ­¡è¿å›ä¾†, ${user.displayName || 'å­¸ç”Ÿ'}ï¼`, false);
                    }
                });

            } catch (error) {
                showMessage(`Firebase åˆå§‹åŒ–å¤±æ•—: ${error.message}`, true);
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
            }
        }

        async function initialAuth() {
            if (!auth) return;
            try {
                // *** ä¿®æ­£: ç”±æ–¼æˆ‘å€‘ä½¿ç”¨çš„æ˜¯è‡ªå®šç¾©/ç¡¬ç·¨ç¢¼çš„é…ç½®ï¼ŒCanvas ç’°å¢ƒçš„ Token ç„¡æ•ˆï¼Œæ•…ç›´æ¥ä½¿ç”¨åŒ¿åç™»å…¥ã€‚ ***
                await signInAnonymously(auth);
                console.log("ä½¿ç”¨åŒ¿åæ–¹å¼ç™»å…¥æˆåŠŸã€‚");
            } catch (error) {
                console.error("åˆå§‹èªè­‰å¤±æ•—:", error);
            }
        }

        // --- Firestore é‚è¼¯ (èˆ‡å‰ä¸€ç‰ˆæœ¬ç›¸åŒ) ---
        const getStudentDocPath = (uid) => 
            `artifacts/${appId}/public/data/students/${uid}`;

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error("è§£æ JWT å¤±æ•—:", e);
                return null;
            }
        };


        async function saveStudentData(userCredential, correctedEmail) {
            if (!db) return;
            
            const finalEmail = correctedEmail || userCredential.email || '';
            const { uid, displayName } = userCredential;
            
            const studentDocRef = doc(db, getStudentDocPath(uid));
            
            try {
                const docSnap = await getDoc(studentDocRef);
                
                const studentData = {
                    userId: uid,
                    displayName: displayName || 'æœªçŸ¥å­¸ç”Ÿ',
                    email: finalEmail,
                    lastLoginAt: new Date().toISOString(),
                };

                if (!docSnap.exists()) {
                    studentData.createdAt = new Date().toISOString();
                    await setDoc(studentDocRef, studentData);
                    showMessage(`æ–°å­¸ç”Ÿè³‡æ–™å·²æ–°å¢: ${displayName} (${uid})`);
                } else {
                    await setDoc(studentDocRef, { 
                        email: finalEmail,
                        lastLoginAt: studentData.lastLoginAt 
                    }, { merge: true });
                    showMessage(`å­¸ç”Ÿè³‡æ–™å·²æ›´æ–°: ${displayName} (${uid})`);
                }
            } catch (error) {
                showMessage("è³‡æ–™ä¿å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–é€£ç·šã€‚", true);
                console.error("å¯«å…¥å­¸ç”Ÿè³‡æ–™åˆ° Firestore å¤±æ•—:", error);
            }
        }

        // --- èªè­‰äº‹ä»¶è™•ç† (èˆ‡å‰ä¸€ç‰ˆæœ¬ç›¸åŒ) ---
        async function handleGoogleSignIn() {
            if (!auth) {
                showMessage("èªè­‰æœå‹™å°šæœªåˆå§‹åŒ–ã€‚", true);
                return;
            }
            
            toggleLoading(true);
            showMessage('æ­£åœ¨é€£æ¥ Google...');

            try {
                const provider = new GoogleAuthProvider();
                provider.addScope('email'); 
                
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                let correctedEmail = null;
                
                // è§£æ ID Token å˜—è©¦ç²å– Email
                const idToken = await user.getIdToken();
                const payload = parseJwt(idToken);
                
                if (payload && payload.email) {
                    correctedEmail = payload.email;
                    if (!user.email) {
                        console.log(`å¾ ID Token å–å¾— Email: ${correctedEmail}`);
                        user.email = correctedEmail; // æš«æ™‚ä¿®æ”¹ user ç‰©ä»¶ç”¨æ–¼ UI
                    }
                }

                await saveStudentData(user, correctedEmail);
                
            } catch (error) {
                console.error("Google ç™»å…¥å¤±æ•—:", error);
                
                let errorMessage = 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡è©¦ã€‚'; 
                
                if (error.code) {
                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = "ç™»å…¥è¦–çª—å·²è¢«é—œé–‰æˆ–å½ˆå‡ºå¼è¦–çª—è¢«é˜»æ“‹ã€‚";
                    } else if (error.code === 'auth/unauthorized-domain') {
                        errorMessage = "èªè­‰éŒ¯èª¤ [auth/unauthorized-domain]: æ­¤ç¶²åŸŸæœªæˆæ¬Šã€‚è«‹å‹™å¿…å°‡æ‚¨ç›®å‰é é¢æ‰€åœ¨çš„ç¶²åŸŸåŠ å…¥ Firebase Console -> Authentication -> Settings -> Authorized domains æ¸…å–®ä¸­ï¼";
                    } else if (error.code === 'auth/operation-not-allowed') {
                        errorMessage = "Firebase è¨­å®šéŒ¯èª¤ï¼šGoogle ç™»å…¥æ–¹å¼æœªåœ¨ Firebase Console ä¸­å•Ÿç”¨ã€‚";
                    } else {
                        errorMessage = `èªè­‰éŒ¯èª¤ [${error.code}]: ${error.message}`;
                    }
                } else if (error.message && error.message.includes('A Firebase project ID is required')) {
                    errorMessage = "Firebase é…ç½®éŒ¯èª¤ï¼šè«‹æª¢æŸ¥ Project ID æˆ– API Key æ˜¯å¦æ­£ç¢ºã€‚";
                }

                showMessage(errorMessage, true);
            } finally {
                toggleLoading(false);
            }
        }
        
        async function handleSignOut() {
            if (!auth) return;
            toggleLoading(true);
            try {
                await signOut(auth);
                await initialAuth(); 
                showMessage('æ‚¨å·²æˆåŠŸç™»å‡ºã€‚', false);
            } catch (error) {
                console.error("ç™»å‡ºå¤±æ•—:", error);
                showMessage("ç™»å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚", true);
            } finally {
                toggleLoading(false);
            }
        }


        // --- åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ (ç¬¦åˆæ‚¨çš„è¦æ±‚) ---
        const initApp = async () => {
            // ç”±æ–¼æ²’æœ‰å¤–éƒ¨ manualConfigï¼Œç›´æ¥è·³éç¬¬ä¸€å€‹ if åˆ¤æ–·ã€‚

            const urlParams = new URLSearchParams(window.location.search);
            const encryptedConfig = urlParams.get('config');
            
            if (encryptedConfig) {
                try {
                    // è§£ç¢¼ Base64
                    const decoded = atob(encryptedConfig);
                    const configObj = JSON.parse(decoded);
                    
                    // å„²å­˜åˆ° localStorage
                    localStorage.setItem('firebase_config', JSON.stringify(configObj));
                    
                    // æ¸…ç† URLï¼Œä¿ç•™ student mode
                    const cleanUrl = window.location.pathname + (urlParams.has('mode') ? '?mode=student' : '');
                    window.history.replaceState({}, document.title, cleanUrl);
                    
                    // ä½¿ç”¨æ–°çš„é…ç½®åˆå§‹åŒ–
                    console.log("å¾ URL è¼‰å…¥æ–°é…ç½®ä¸¦å„²å­˜ã€‚");
                    initializeFirebase(configObj);
                    return;

                } catch (e) { 
                    console.error("Config decode failed or JSON parse error", e); 
                }
            }

            const storedConfig = localStorage.getItem('firebase_config');
            if (storedConfig) {
                try {
                    const config = JSON.parse(storedConfig);
                    if (config && config.apiKey) {
                        // ä½¿ç”¨å„²å­˜çš„é…ç½®åˆå§‹åŒ–
                        console.log("å¾ localStorage è¼‰å…¥é…ç½®ã€‚");
                        initializeFirebase(config);
                        return;
                    }
                } catch (e) { 
                    console.error("Stored config parse failed, removing.", e);
                    localStorage.removeItem('firebase_config'); 
                }
            }

            // æœ€å¾Œä½¿ç”¨ç¡¬ç·¨ç¢¼çš„é è¨­é…ç½®
            console.log("ä½¿ç”¨ç¡¬ç·¨ç¢¼çš„é è¨­é…ç½®ã€‚");
            initializeFirebase(firebaseConfig);
        };

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        window.onload = function() {
            initApp();
            
            // è¨­å®šäº‹ä»¶ç›£è½å™¨
            googleSignInBtn.addEventListener('click', handleGoogleSignIn);
            if (signOutBtn) signOutBtn.addEventListener('click', handleSignOut);
        };
    </script>
</body>
</html>
