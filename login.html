<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿç·šä¸Šæ¸¬é©—ç™»å…¥ç³»çµ±</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­å®š Tailwind CSS ä½¿ç”¨ Inter å­—é«” -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <!-- ä¸»è¦æ‡‰ç”¨ç¨‹å¼å®¹å™¨ -->
    <div id="app-container" class="w-full max-w-lg bg-white shadow-2xl rounded-xl p-8 space-y-6 border border-indigo-100 transition-all duration-300">
        <h1 class="text-3xl font-extrabold text-center text-indigo-700">
            å­¸ç”Ÿæ¸¬é©—èªè­‰å…¥å£
        </h1>
        
        <!-- ç³»çµ±è¨Šæ¯é¡¯ç¤ºå€ -->
        <div id="message-box" class="hidden p-3 text-sm rounded-lg transition-all duration-300"></div>

        <!-- Firebase è¨­å®šå€å¡Š -->
        <div id="config-section" class="border border-gray-200 rounded-lg p-4 space-y-3">
            <button id="toggle-config-btn" class="w-full flex justify-between items-center text-left text-sm font-semibold text-gray-700 hover:text-indigo-600 transition-colors">
                <span>Firebase é…ç½®è¨­å®š (å‚™ç”¨)</span>
                <svg id="config-arrow" class="w-4 h-4 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="config-form-container" class="hidden space-y-3">
                <textarea id="firebase-config-input" rows="5" class="w-full p-2 border border-gray-300 rounded-md text-xs font-mono focus:ring-indigo-500 focus:border-indigo-500" placeholder='{"apiKey": "YOUR_API_KEY", "authDomain": "YOUR_AUTH_DOMAIN", "projectId": "YOUR_PROJECT_ID", ...}'></textarea>
                <button id="save-config-btn" class="w-full px-4 py-2 text-sm font-medium rounded-lg text-white bg-green-500 hover:bg-green-600 transition duration-150 ease-in-out">
                    å„²å­˜é…ç½®åˆ°ç€è¦½å™¨
                </button>
                <p class="text-xs text-gray-500">
                    æ³¨æ„ï¼šæ­¤é…ç½®åƒ…ä½œç‚ºå…¨åŸŸè®Šæ•¸ (`__firebase_config`) ä¸å­˜åœ¨æ™‚çš„å‚™ç”¨ã€‚
                </p>
            </div>
        </div>

        <!-- ç™»å…¥ç‹€æ…‹é¡¯ç¤ºå€ -->
        <div id="auth-status-container" class="space-y-4">
            <!-- ç™»å…¥æŒ‰éˆ• -->
            <button id="google-sign-in-btn" class="hidden flex items-center justify-center w-full px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 transition duration-150 ease-in-out">
                <svg id="loading-spinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>é€é Google Education å¸³è™Ÿç™»å…¥</span>
            </button>

            <!-- å·²ç™»å…¥è³‡è¨Š -->
            <div id="user-info-card" class="hidden space-y-4">
                <div class="bg-green-50 border-l-4 border-green-500 text-green-700 p-4 rounded-lg">
                    <p class="font-bold">ğŸ‰ èªè­‰æˆåŠŸï¼</p>
                    <p>æ‚¨å·²æº–å‚™å¥½é–‹å§‹æ¸¬é©—ã€‚</p>
                </div>
                
                <div class="bg-gray-100 p-4 rounded-lg space-y-2">
                    <h2 class="text-lg font-semibold text-gray-800 border-b pb-1">æˆç¸¾ç´€éŒ„è³‡è¨Š</h2>
                    <div class="flex justify-between text-sm text-gray-600">
                        <span class="font-medium">å­¸ç”Ÿåç¨±:</span>
                        <span id="display-name" class="truncate max-w-[60%]"></span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-600">
                        <span class="font-medium">ç™»å…¥å¸³è™Ÿ (Email):</span>
                        <span id="display-email" class="truncate max-w-[60%]"></span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-600">
                        <span class="font-medium">å­¸ç”Ÿ ID (æˆç¸¾ä¸»éµ):</span>
                        <span id="display-uid" class="truncate max-w-[60%] font-mono text-xs text-indigo-600"></span>
                    </div>
                </div>
                
                <button id="sign-out-btn" class="w-full px-6 py-3 text-sm font-medium rounded-lg text-red-600 border border-red-300 bg-white hover:bg-red-50 transition duration-150 ease-in-out">
                    ç™»å‡º
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK åŒ¯å…¥ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // å…¨åŸŸè®Šæ•¸æª¢æŸ¥èˆ‡ä½¿ç”¨
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app, auth, db;
        let firebaseConfig = {};

        // DOM å…ƒç´ å¿«å–
        const msgBox = document.getElementById('message-box');
        const googleSignInBtn = document.getElementById('google-sign-in-btn');
        const signOutBtn = document.getElementById('sign-out-btn');
        const userInfoCard = document.getElementById('user-info-card');
        const loadingSpinner = document.getElementById('loading-spinner');
        const configInput = document.getElementById('firebase-config-input');
        const saveConfigBtn = document.getElementById('save-config-btn');
        const toggleConfigBtn = document.getElementById('toggle-config-btn');
        const configFormContainer = document.getElementById('config-form-container');
        const configArrow = document.getElementById('config-arrow');

        // --- UI è¼”åŠ©å‡½å¼ ---
        function showMessage(text, isError = false) {
            msgBox.textContent = text;
            msgBox.className = `p-3 text-sm rounded-lg ${isError ? 'bg-red-100 text-red-700' : 'bg-indigo-50 text-indigo-700'}`;
            msgBox.classList.remove('hidden');
        }

        function toggleLoading(isLoading) {
            googleSignInBtn.disabled = isLoading;
            if (signOutBtn) signOutBtn.disabled = isLoading;
            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
            } else {
                loadingSpinner.classList.add('hidden');
            }
        }

        function updateUI(user) {
            const loggedIn = user && !user.isAnonymous;
            
            googleSignInBtn.classList.toggle('hidden', loggedIn);
            userInfoCard.classList.toggle('hidden', !loggedIn);
            
            if (loggedIn) {
                // ä¿®æ­£ï¼šæª¢æŸ¥ user.emailï¼Œå¦‚æœç‚ºç©ºå‰‡é¡¯ç¤º 'ç„¡é›»å­éƒµä»¶'
                document.getElementById('display-name').textContent = user.displayName || 'ç„¡åç¨±';
                document.getElementById('display-email').textContent = user.email || 'ç„¡é›»å­éƒµä»¶';
                document.getElementById('display-uid').textContent = user.uid;
            } else {
                // å¦‚æœæ˜¯åŒ¿åæˆ–æœªç™»å…¥ï¼Œé¡¯ç¤ºç™»å…¥æŒ‰éˆ•
                googleSignInBtn.classList.remove('hidden');
                googleSignInBtn.textContent = 'é€é Google Education å¸³è™Ÿç™»å…¥';
            }
        }
        
        // --- Firebase é…ç½®ç®¡ç† (èˆ‡å‰ä¸€ç‰ˆæœ¬ç›¸åŒ) ---
        function loadConfig() {
            if (typeof __firebase_config !== 'undefined') {
                try {
                    firebaseConfig = JSON.parse(__firebase_config);
                    console.log("ä½¿ç”¨å…¨åŸŸè®Šæ•¸ Firebase é…ç½®ã€‚");
                    configInput.value = JSON.stringify(firebaseConfig, null, 2);
                    return true;
                } catch (e) {
                    console.warn("è§£æå…¨åŸŸ __firebase_config å¤±æ•—:", e);
                }
            }
            const savedConfig = sessionStorage.getItem('firebaseConfig');
            if (savedConfig) {
                try {
                    firebaseConfig = JSON.parse(savedConfig);
                    console.log("ä½¿ç”¨ sessionStorage å„²å­˜çš„ Firebase é…ç½®ã€‚");
                    configInput.value = JSON.stringify(firebaseConfig, null, 2);
                    return true;
                } catch (e) {
                    console.error("è§£æ sessionStorage é…ç½®å¤±æ•—:", e);
                    sessionStorage.removeItem('firebaseConfig');
                }
            }
            configInput.value = JSON.stringify({}, null, 2);
            return false;
        }

        function formatJsonInput() {
            try {
                const configText = configInput.value.trim();
                if (!configText) return; 
                const config = JSON.parse(configText);
                configInput.value = JSON.stringify(config, null, 2);
                return true;
            } catch (error) {
                return false;
            }
        }

        function saveConfig() {
            formatJsonInput();

            try {
                const configText = configInput.value.trim();
                if (configText === '{}' || configText === '') {
                    sessionStorage.removeItem('firebaseConfig');
                    firebaseConfig = {};
                    showMessage("é…ç½®å·²æ¸…é™¤ã€‚è«‹è¼¸å…¥æœ‰æ•ˆçš„é…ç½®å¾Œå†å˜—è©¦ç™»å…¥ã€‚", true);
                    return;
                }

                const config = JSON.parse(configText);
                
                if (!config.apiKey || !config.projectId) {
                    showMessage("å„²å­˜å¤±æ•—ï¼šFirebase é…ç½®æ‡‰åŒ…å« 'apiKey' å’Œ 'projectId' ç­‰å¿…è¦æ¬„ä½ã€‚", true);
                    return;
                }

                sessionStorage.setItem('firebaseConfig', configText);
                firebaseConfig = config;
                showMessage("Firebase é…ç½®å·²æˆåŠŸå„²å­˜åˆ°ç€è¦½å™¨ã€‚è«‹é‡æ–°æ•´ç†é é¢ä»¥åˆå§‹åŒ–æœå‹™ã€‚", false);
            } catch (error) {
                showMessage("å„²å­˜å¤±æ•—ï¼šè«‹ç¢ºä¿è¼¸å…¥**æœ‰æ•ˆçš„ JSON æ ¼å¼**ï¼å¸¸è¦‹éŒ¯èª¤åŒ…æ‹¬ï¼šç¼ºå°‘é›™å¼•è™Ÿã€å°¾éš¨é€—è™Ÿæˆ–ä½¿ç”¨å–®å¼•è™Ÿç­‰ã€‚", true);
                console.error("å„²å­˜é…ç½®éŒ¯èª¤:", error);
            }
        }

        // --- Firebase æœå‹™åˆå§‹åŒ– (èˆ‡å‰ä¸€ç‰ˆæœ¬ç›¸åŒ) ---
        function initializeFirebase() {
            if (Object.keys(firebaseConfig).length === 0) {
                showMessage("âš ï¸ è­¦å‘Šï¼šFirebase é…ç½®éºå¤±ã€‚è«‹åœ¨ä¸Šæ–¹å€å¡Šè¼¸å…¥é…ç½®å¾Œå„²å­˜ã€‚", true);
                return;
            }
            
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                setPersistence(auth, browserSessionPersistence);
                initialAuth();

                onAuthStateChanged(auth, (user) => {
                    updateUI(user);
                    if (user && !user.isAnonymous) {
                        showMessage(`æ­¡è¿å›ä¾†, ${user.displayName || 'å­¸ç”Ÿ'}ï¼`, false);
                    }
                });

            } catch (error) {
                showMessage(`Firebase åˆå§‹åŒ–å¤±æ•—: ${error.message}`, true);
                console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
            }
        }

        async function initialAuth() {
            if (!auth) return;
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("ä½¿ç”¨è‡ªå®šç¾© Token ç™»å…¥æˆåŠŸã€‚");
                } else {
                    await signInAnonymously(auth);
                    console.log("ä½¿ç”¨åŒ¿åæ–¹å¼ç™»å…¥æˆåŠŸã€‚");
                }
            } catch (error) {
                console.error("åˆå§‹èªè­‰å¤±æ•—:", error);
            }
        }

        // --- Firestore é‚è¼¯ (ä½¿ç”¨ä¿®æ­£å¾Œçš„ email å€¼) ---
        const getStudentDocPath = (uid) => 
            `artifacts/${appId}/public/data/students/${uid}`;

        async function saveStudentData(userCredential, correctedEmail) {
            if (!db) return;
            
            // ä½¿ç”¨ä¿®æ­£å¾Œçš„ Emailï¼Œå¦‚æœ correctedEmail å­˜åœ¨ï¼Œå‰‡è¦†è“‹ userCredential.email
            const finalEmail = correctedEmail || userCredential.email || '';
            const { uid, displayName } = userCredential;
            
            const studentDocRef = doc(db, getStudentDocPath(uid));
            
            try {
                const docSnap = await getDoc(studentDocRef);
                
                const studentData = {
                    userId: uid,
                    displayName: displayName || 'æœªçŸ¥å­¸ç”Ÿ',
                    email: finalEmail, // ä½¿ç”¨æœ€çµ‚ç¢ºå®šçš„ Email
                    lastLoginAt: new Date().toISOString(),
                };

                if (!docSnap.exists()) {
                    studentData.createdAt = new Date().toISOString();
                    await setDoc(studentDocRef, studentData);
                    showMessage(`æ–°å­¸ç”Ÿè³‡æ–™å·²æ–°å¢: ${displayName} (${uid})`);
                } else {
                    await setDoc(studentDocRef, { 
                        email: finalEmail, // ç¢ºä¿ Email è³‡è¨Šä¹Ÿè¢«æ›´æ–°
                        lastLoginAt: studentData.lastLoginAt 
                    }, { merge: true });
                    showMessage(`å­¸ç”Ÿè³‡æ–™å·²æ›´æ–°: ${displayName} (${uid})`);
                }
            } catch (error) {
                showMessage("è³‡æ–™ä¿å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™æˆ–é€£ç·šã€‚", true);
                console.error("å¯«å…¥å­¸ç”Ÿè³‡æ–™åˆ° Firestore å¤±æ•—:", error);
            }
        }

        // --- JWT Token è§£æè¼”åŠ©å‡½å¼ ---
        function parseJwt(token) {
            try {
                // JWT æ ¼å¼ç‚º header.payload.signature
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                // ä½¿ç”¨ atob è§£ç¢¼ base64
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(jsonPayload);
            } catch (e) {
                console.error("è§£æ JWT å¤±æ•—:", e);
                return null;
            }
        };


        // --- èªè­‰äº‹ä»¶è™•ç† (åŠ å…¥ ID Token è§£æ) ---
        async function handleGoogleSignIn() {
            if (!auth) {
                showMessage("èªè­‰æœå‹™å°šæœªåˆå§‹åŒ–ã€‚", true);
                return;
            }
            
            toggleLoading(true);
            showMessage('æ­£åœ¨é€£æ¥ Google...');

            try {
                const provider = new GoogleAuthProvider();
                provider.addScope('email'); 
                
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                let correctedEmail = null;
                
                // **** æ–°å¢æ­¥é©Ÿï¼šè§£æ ID Token å˜—è©¦ç²å– Email ****
                const idToken = await user.getIdToken();
                const payload = parseJwt(idToken);
                
                if (payload && payload.email) {
                    correctedEmail = payload.email;
                    // å¦‚æœ user.email æ˜¯ç©ºçš„ï¼Œä½† ID Token è£¡æœ‰ Emailï¼Œå‰‡æ‰‹å‹•æ›´æ–° Auth ç‹€æ…‹ä»¥ä¾¿ UI é¡¯ç¤º
                    if (!user.email) {
                        // é›–ç„¶ä¸èƒ½ç›´æ¥ä¿®æ”¹ Firebase user ç‰©ä»¶ï¼Œä½†æˆ‘å€‘å¯ä»¥è¨˜éŒ„ä¸¦ç”¨æ–¼ UI/DB æ›´æ–°
                        console.log(`å¾ ID Token å–å¾— Email: ${correctedEmail}`);
                        user.email = correctedEmail; // æš«æ™‚ä¿®æ”¹ user ç‰©ä»¶ç”¨æ–¼ UI
                    }
                }
                // ********************************************

                // å°‡ä½¿ç”¨è€…è³‡è¨Šå’Œè§£æåˆ°çš„ Email å‚³éçµ¦å„²å­˜å‡½å¼
                await saveStudentData(user, correctedEmail);
                
            } catch (error) {
                console.error("Google ç™»å…¥å¤±æ•—:", error);
                
                let errorMessage = 'ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–é‡è©¦ã€‚'; 
                
                if (error.code) {
                    if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage = "ç™»å…¥è¦–çª—å·²è¢«é—œé–‰æˆ–å½ˆå‡ºå¼è¦–çª—è¢«é˜»æ“‹ã€‚";
                    } else if (error.code === 'auth/unauthorized-domain') {
                        errorMessage = "èªè­‰éŒ¯èª¤ [auth/unauthorized-domain]: æ­¤ç¶²åŸŸæœªæˆæ¬Šã€‚è«‹å‹™å¿…å°‡æ‚¨ç›®å‰é é¢æ‰€åœ¨çš„ç¶²åŸŸåŠ å…¥ Firebase Console -> Authentication -> Settings -> Authorized domains æ¸…å–®ä¸­ï¼";
                    } else if (error.code === 'auth/operation-not-allowed') {
                        errorMessage = "Firebase è¨­å®šéŒ¯èª¤ï¼šGoogle ç™»å…¥æ–¹å¼æœªåœ¨ Firebase Console ä¸­å•Ÿç”¨ã€‚";
                    } else {
                        errorMessage = `èªè­‰éŒ¯èª¤ [${error.code}]: ${error.message}`;
                    }
                } else if (error.message && error.message.includes('A Firebase project ID is required')) {
                    errorMessage = "Firebase é…ç½®éŒ¯èª¤ï¼šè«‹æª¢æŸ¥ Project ID æˆ– API Key æ˜¯å¦æ­£ç¢ºã€‚";
                }

                showMessage(errorMessage, true);
            } finally {
                toggleLoading(false);
            }
        }
        
        async function handleSignOut() {
            if (!auth) return;
            toggleLoading(true);
            try {
                await signOut(auth);
                await initialAuth(); 
                showMessage('æ‚¨å·²æˆåŠŸç™»å‡ºã€‚', false);
            } catch (error) {
                console.error("ç™»å‡ºå¤±æ•—:", error);
                showMessage("ç™»å‡ºå¤±æ•—ï¼Œè«‹é‡è©¦ã€‚", true);
            } finally {
                toggleLoading(false);
            }
        }

        // --- åˆå§‹åŒ–æ‡‰ç”¨ç¨‹å¼ ---
        window.onload = function() {
            loadConfig();
            initializeFirebase();

            googleSignInBtn.addEventListener('click', handleGoogleSignIn);
            if (signOutBtn) signOutBtn.addEventListener('click', handleSignOut);
            
            saveConfigBtn.addEventListener('click', saveConfig);
            toggleConfigBtn.addEventListener('click', () => {
                const isHidden = configFormContainer.classList.toggle('hidden');
                configArrow.classList.toggle('rotate-180', !isHidden);
                if (!isHidden) {
                     formatJsonInput();
                }
            });

            configInput.addEventListener('blur', formatJsonInput);
        };
    </script>
</body>
</html>
