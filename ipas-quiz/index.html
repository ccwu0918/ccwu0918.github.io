<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 應用規劃師測驗系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
      // --- 設定區 ---
      // 已更新為指定的新部署 URL
      const GOOGLE_APP_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxZWGw2prlLtfku-hapGbdFQsVxlZF_rTJhu6jJRDheBOCwGOt4T982HfFTpPclxhkzvQ/exec";
      
      const CONFIG = {
        PASS_THRESHOLD: 70, // 通過分數
        QUESTION_COUNT: 25  // 每次測驗題數
      };

      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: { sans: ['"Noto Sans TC"', 'sans-serif'] },
            colors: {
              primary: { DEFAULT: '#3B82F6', dark: '#2563EB' },
              darkbg: '#0F172A',
              card: '#1E293B',
            }
          }
        }
      }
    </script>
    <style>
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #64748b; }
      .loader { border-top-color: #3B82F6; animation: spinner 1.5s linear infinite; }
      @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800 dark:bg-darkbg dark:text-gray-100 transition-colors duration-300 min-h-screen font-sans">

    <!-- Navbar -->
    <nav class="w-full p-4 bg-white dark:bg-card shadow-md fixed top-0 z-50 transition-colors duration-300">
      <div class="max-w-4xl mx-auto flex justify-between items-center">
        <div class="flex items-center gap-2">
          <i class="ph ph-robot text-3xl text-primary"></i>
          <h1 class="text-xl font-bold tracking-wide" id="navTitle">AI 應用規劃師</h1>
        </div>
        <div class="flex items-center gap-4">
          <button onclick="toggleLang()" class="flex items-center gap-1 px-3 py-1 rounded-full border border-gray-300 dark:border-gray-600 hover:bg-gray-200 dark:hover:bg-gray-700 transition">
            <i class="ph ph-translate text-lg"></i>
            <span id="langLabel" class="text-sm font-medium">中文</span>
          </button>
          <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition text-yellow-500 dark:text-blue-400">
            <i id="themeIcon" class="ph ph-moon-stars text-2xl"></i>
          </button>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-3xl mx-auto mt-24 p-4 mb-10">
      
      <!-- Loading Overlay -->
      <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden flex justify-center items-center">
        <div class="bg-white dark:bg-card p-6 rounded-xl shadow-2xl flex flex-col items-center">
          <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
          <p class="text-lg font-medium animate-pulse">Processing...</p>
        </div>
      </div>

      <!-- STEP 1: LOGIN -->
      <div id="stepLogin" class="animate-fade-in">
        <div class="bg-white dark:bg-card p-8 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700">
          <h2 class="text-2xl font-bold mb-6 text-center border-b pb-4 dark:border-gray-700" id="loginTitle">考生登入</h2>
          <form onsubmit="handleStartQuiz(event)" class="space-y-6">
            <div>
              <label class="block text-sm font-medium mb-2" id="labelStudentId">學號 ID</label>
              <input type="text" id="studentId" required class="w-full px-4 py-3 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary focus:outline-none transition" placeholder="e.g., s110312345">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2" id="labelName">姓名</label>
              <input type="text" id="studentName" required class="w-full px-4 py-3 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary focus:outline-none transition" placeholder="e.g., 王小明">
            </div>
            <div>
              <label class="block text-sm font-medium mb-2" id="labelChapter">選擇章節</label>
              <select id="chapterSelect" required class="w-full px-4 py-3 rounded-lg bg-gray-50 dark:bg-gray-900 border border-gray-300 dark:border-gray-600 focus:ring-2 focus:ring-primary focus:outline-none transition appearance-none">
                <option value="" disabled selected>Loading chapters...</option>
              </select>
            </div>
            <button type="submit" class="w-full bg-primary hover:bg-primary-dark text-white font-bold py-3 rounded-lg shadow-lg hover:shadow-xl transition transform hover:-translate-y-0.5" id="btnStart">開始測驗</button>
          </form>
        </div>
      </div>

      <!-- STEP 2: QUIZ -->
      <div id="stepQuiz" class="hidden">
        <div class="flex justify-between items-center mb-4 text-sm font-medium text-gray-500 dark:text-gray-400">
          <span id="quizInfoName">Student: ...</span>
          <span id="quizProgress">Question 1 / 25</span>
        </div>
        <form id="quizForm" onsubmit="handleSubmitQuiz(event)">
          <div id="questionsContainer" class="space-y-6"></div>
          <div class="mt-8">
            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-lg shadow-lg text-lg transition" id="btnSubmit">提交答案</button>
          </div>
        </form>
      </div>

      <!-- STEP 3: RESULT -->
      <div id="stepResult" class="hidden">
        <div class="bg-white dark:bg-card p-8 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 text-center mb-8">
          <div id="resultIcon" class="text-6xl mb-4"></div>
          <h2 class="text-3xl font-bold mb-2" id="resultTitle">測驗結果</h2>
          <div class="text-5xl font-black text-primary mb-4">
            <span id="scoreValue">0</span> <span class="text-2xl text-gray-500">/ 100</span>
          </div>
          <p id="passStatus" class="text-xl font-bold px-4 py-2 rounded-lg inline-block"></p>
          <div class="mt-6 flex justify-center gap-4">
            <button onclick="location.reload()" class="flex items-center gap-2 px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition">
              <i class="ph ph-arrow-counter-clockwise"></i> <span id="btnRetry">重新測驗</span>
            </button>
          </div>
        </div>
        <div id="reviewContainer" class="space-y-4"></div>
      </div>
    </main>

    <script>
      // ==========================================
      // BACKEND CONNECTION HANDLER
      // ==========================================
      const Backend = {
        _useFetch: typeof google === 'undefined',
        
        call: function(funcName, params = {}) {
          console.log(`[Backend] Calling ${funcName}`, params);
          
          if (!this._useFetch) {
            this._useFetch = true; 
            return this.call(funcName, params);
          } else {
            if (!GOOGLE_APP_SCRIPT_URL) {
              return Promise.reject("GOOGLE_APP_SCRIPT_URL not configured.");
            }

            const payload = { 
              action: funcName,
              ...params
            };

            return fetch(GOOGLE_APP_SCRIPT_URL, {
              method: 'POST',
              headers: { "Content-Type": "text/plain;charset=utf-8" },
              body: JSON.stringify(payload),
              redirect: "follow"
            })
            .then(async res => {
                const text = await res.text();
                let json;
                try {
                    json = JSON.parse(text);
                } catch (e) {
                    console.error("[Backend Raw Response]", text);
                    if (text.includes("script function not found")) {
                        throw new Error("部署錯誤：請確認後端已建立新版本。");
                    } else if (text.includes("Google Drive") || text.includes("Sign in")) {
                        throw new Error("權限錯誤：請確認部署權限設為「所有人」。");
                    } else {
                        const cleanText = text.replace(/<[^>]*>?/gm, '').substring(0, 100);
                        throw new Error(`後端回應異常: ${cleanText}...`);
                    }
                }
                
                if(json.error) throw new Error(json.error + (json.details ? `: ${json.details}` : ''));
                return json; 
            });
          }
        }
      };

      // ==========================================
      // MAIN APP LOGIC
      // ==========================================
      let currentLang = 'zh-TW';
      let isDark = true;
      let quizData = [];
      let studentInfo = {};
      const i18n = {
        'zh-TW': {
          title: 'AI 應用規劃師', loginTitle: '考生登入', lblId: '學號 ID', lblName: '姓名', lblChapter: '選擇章節',
          btnStart: '開始測驗', btnSubmit: '提交答案', btnRetry: '重新測驗', loading: '載入中...',
          pass: '恭喜通過！', fail: '未通過，請再接再厲', qPrefix: '第', qSuffix: '題',
          yourAns: '您的答案', correctAns: '正確答案', explanation: '解析', selectChapter: '請選擇章節',
          alertIncomplete: '您還有題目未完成，請作答完畢再提交！',
          loadFail: '載入失敗 (請見錯誤訊息)'
        },
        'en': {
          title: 'AI Planner Quiz', loginTitle: 'Student Login', lblId: 'Student ID', lblName: 'Name', lblChapter: 'Select Chapter',
          btnStart: 'Start Quiz', btnSubmit: 'Submit Answers', btnRetry: 'Retry Quiz', loading: 'Loading...',
          pass: 'PASSED!', fail: 'FAILED', qPrefix: 'Q', qSuffix: '',
          yourAns: 'Your Answer', correctAns: 'Correct Answer', explanation: 'Explanation', selectChapter: 'Select a chapter',
          alertIncomplete: 'You have incomplete questions. Please answer all before submitting.',
          loadFail: 'Load Failed (See Error)'
        }
      };

      window.onload = function() {
        if (localStorage.getItem('theme') === 'light') isDark = false;
        applyTheme();
        loadInitData();
        updateUIText();
      };

      function toggleTheme() {
        isDark = !isDark;
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        applyTheme();
      }

      function applyTheme() {
        const icon = document.getElementById('themeIcon');
        if (isDark) {
          document.documentElement.classList.add('dark');
          icon.classList.remove('ph-sun'); icon.classList.add('ph-moon-stars');
        } else {
          document.documentElement.classList.remove('dark');
          icon.classList.remove('ph-moon-stars'); icon.classList.add('ph-sun');
        }
      }

      function toggleLang() {
        currentLang = currentLang === 'zh-TW' ? 'en' : 'zh-TW';
        document.getElementById('langLabel').innerText = currentLang === 'zh-TW' ? '中文' : 'EN';
        updateUIText();
        loadInitData();
      }

      function updateUIText() {
        const t = i18n[currentLang];
        document.getElementById('navTitle').innerText = t.title;
        document.getElementById('loginTitle').innerText = t.loginTitle;
        document.getElementById('labelStudentId').innerText = t.lblId;
        document.getElementById('labelName').innerText = t.lblName;
        document.getElementById('labelChapter').innerText = t.lblChapter;
        document.getElementById('btnStart').innerText = t.btnStart;
        document.getElementById('btnSubmit').innerText = t.btnSubmit;
        document.getElementById('btnRetry').innerText = t.btnRetry;
      }

      function showLoading(show) {
        const el = document.getElementById('loadingOverlay');
        show ? el.classList.remove('hidden') : el.classList.add('hidden');
      }

      function handleError(err) {
        showLoading(false);
        const msg = (err && err.message) ? err.message : String(err);
        alert('系統錯誤：\n' + msg);
        console.error(err);
      }

      // --- Data Fetching ---
      function loadInitData() {
        showLoading(true);
        Backend.call('getChapters')
          .then(data => {
            showLoading(false);
            const select = document.getElementById('chapterSelect');
            select.innerHTML = `<option value="" disabled selected>${i18n[currentLang].selectChapter}</option>`;
            
            if (data.chapters && data.chapters.length > 0) {
              data.chapters.forEach(ch => {
                const name = currentLang === 'zh-TW' ? ch.nameZh : (ch.nameEn || ch.nameZh);
                const option = document.createElement('option');
                option.value = ch.id;
                option.text = `${ch.id} - ${name}`;
                select.appendChild(option);
              });
            } else {
               const option = document.createElement('option');
               option.text = "No chapters found";
               option.disabled = true;
               select.appendChild(option);
            }
          })
          .catch(err => {
            handleError(err);
            const select = document.getElementById('chapterSelect');
            select.innerHTML = `<option disabled selected>${i18n[currentLang].loadFail}</option>`;
          });
      }

      function handleStartQuiz(e) {
        e.preventDefault();
        studentInfo = {
          id: document.getElementById('studentId').value,
          name: document.getElementById('studentName').value,
          chapterId: document.getElementById('chapterSelect').value
        };
        if(!studentInfo.chapterId) return alert('Please select a chapter');

        showLoading(true);
        const langCode = currentLang === 'zh-TW' ? 'zh' : 'en';
        Backend.call('getQuestions', { 
            chapterId: studentInfo.chapterId, 
            lang: langCode,
            count: CONFIG.QUESTION_COUNT 
        })
          .then(data => {
            if(data.error) throw new Error(data.error);
            renderQuiz(data.questions);
          })
          .catch(handleError);
      }

      function renderQuiz(questions) {
        showLoading(false);
        quizData = questions.map(q => {
          let opts = [...q.options]; 
          let correctText = q.answer;
          // 嘗試對應 A/B/C/D 到實際文字
          const letterMap = { 'A': 0, 'B': 1, 'C': 2, 'D': 3 };
          if (q.answer && q.answer.length === 1 && letterMap.hasOwnProperty(q.answer)) {
             if(q.options[letterMap[q.answer]] !== undefined) {
               correctText = q.options[letterMap[q.answer]];
             }
          }

          // 隨機打亂
          for (let i = opts.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [opts[i], opts[j]] = [opts[j], opts[i]];
          }

          return {
            ...q,
            shuffledOptions: opts,
            correctText: correctText
          };
        });

        document.getElementById('stepLogin').classList.add('hidden');
        document.getElementById('stepQuiz').classList.remove('hidden');
        document.getElementById('quizInfoName').innerText = `${studentInfo.id} ${studentInfo.name}`;
        document.getElementById('quizProgress').innerText = `Total: ${questions.length}`;

        const container = document.getElementById('questionsContainer');
        container.innerHTML = '';
        const t = i18n[currentLang];

        quizData.forEach((q, index) => {
          const qEl = document.createElement('div');
          qEl.className = "bg-white dark:bg-card p-6 rounded-xl shadow border border-gray-200 dark:border-gray-700";
          
          let optionsHtml = '';
          q.shuffledOptions.forEach(opt => {
            const optText = opt || '';
            optionsHtml += `
              <label class="flex items-start gap-3 p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition">
                <input type="radio" name="q_${q.id}" value="${optText.replace(/"/g, '&quot;')}" class="mt-1 w-5 h-5 text-primary bg-gray-100 border-gray-300 focus:ring-primary dark:bg-gray-700 dark:border-gray-600">
                <span class="text-base leading-relaxed text-gray-700 dark:text-gray-300">${optText}</span>
              </label>
            `;
          });
          
          qEl.innerHTML = `
            <div class="flex gap-2 mb-4">
              <span class="bg-primary text-white text-xs font-bold px-2 py-1 rounded h-fit whitespace-nowrap">${t.qPrefix}${index + 1}${t.qSuffix}</span>
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">${q.text}</h3>
            </div>
            <div class="space-y-1">${optionsHtml}</div>
          `;
          container.appendChild(qEl);
        });
        window.scrollTo(0,0);
      }

      // ===========================================
      // [FIX] 改寫為更穩健的提交邏輯
      // ===========================================
      function handleSubmitQuiz(e) {
        e.preventDefault();
        console.log("Submit button clicked - Processing...");

        try {
            if (!quizData || quizData.length === 0) {
                throw new Error("題庫資料異常，請重新載入頁面");
            }

            let correctCount = 0;
            let isComplete = true;
            const answersDetails = [];

            // 使用傳統迴圈，方便偵錯
            for (let i = 0; i < quizData.length; i++) {
                const q = quizData[i];
                // 減少 Log 數量，僅顯示未完成的
                // console.log(`Checking question ${q.id}...`);

                // [FIX] 使用 getElementsByName，完全避免特殊字元 (如小數點、空格) 造成的選擇器崩潰
                const radios = document.getElementsByName("q_" + q.id);
                let userVal = null;
                
                for (let j = 0; j < radios.length; j++) {
                    if (radios[j].checked) {
                        userVal = radios[j].value;
                        break;
                    }
                }

                if (userVal === null) {
                    console.log(`Question ${q.id} is incomplete.`);
                    isComplete = false;
                } else {
                    const isCorrect = String(userVal).trim() === String(q.correctText).trim();
                    if (isCorrect) correctCount++;
                    
                    answersDetails.push({
                      id: q.id,
                      isCorrect: isCorrect,
                      userSelected: userVal,
                      correctAnswer: q.correctText,
                      explanation: q.explanation
                    });
                }
            }

            if (!isComplete) {
                console.log("Form incomplete. Showing alert.");
                return alert(i18n[currentLang].alertIncomplete);
            }

            // [RESTORED] 確認視窗：已將註解取消，提交前會詢問使用者
            if (!confirm('確認提交答案？(Submit Answers?)')) return;

            showLoading(true);

            const score = Math.round((correctCount / quizData.length) * 100);
            const isPassed = score >= CONFIG.PASS_THRESHOLD;

            const payload = {
              studentId: studentInfo.id,
              name: studentInfo.name,
              chapterId: studentInfo.chapterId,
              score: score,
              passed: isPassed
            };

            console.log("Sending payload to backend...", payload);

            Backend.call('submitResult', payload)
              .then(data => {
                console.log("Backend response:", data);
                if(data.success) {
                    showResults({
                        score: score,
                        isPassed: isPassed,
                        details: answersDetails
                    });
                } else {
                    throw new Error('Submission failed (Backend returned false)');
                }
              })
              .catch(err => {
                console.error("Backend Call Failed:", err);
                handleError(err);
              });

        } catch (err) {
            console.error("handleSubmitQuiz Critical Error:", err);
            alert("提交過程發生嚴重錯誤: " + err.message);
        }
      }

      function showResults(result) {
        showLoading(false);
        document.getElementById('stepQuiz').classList.add('hidden');
        document.getElementById('stepResult').classList.remove('hidden');
        const t = i18n[currentLang];
        
        document.getElementById('scoreValue').innerText = result.score;
        const passEl = document.getElementById('passStatus');
        const iconEl = document.getElementById('resultIcon');
        
        if (result.isPassed) {
          passEl.innerText = t.pass;
          passEl.className = "text-xl font-bold px-4 py-2 rounded-lg inline-block bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300";
          iconEl.innerHTML = '<i class="ph ph-check-circle text-green-500"></i>';
        } else {
          passEl.innerText = t.fail;
          passEl.className = "text-xl font-bold px-4 py-2 rounded-lg inline-block bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300";
          iconEl.innerHTML = '<i class="ph ph-x-circle text-red-500"></i>';
        }

        const container = document.getElementById('reviewContainer');
        container.innerHTML = '';

        result.details.forEach(item => {
          const originalQ = quizData.find(q => String(q.id) === String(item.id));
          
          const el = document.createElement('div');
          el.className = `p-6 rounded-xl border ${item.isCorrect 
            ? 'bg-green-50 dark:bg-opacity-10 border-green-200 dark:border-green-800' 
            : 'bg-red-50 dark:bg-opacity-10 border-red-200 dark:border-red-800'}`;
            
          const icon = item.isCorrect 
            ? '<i class="ph ph-check text-green-600 text-xl"></i>' 
            : '<i class="ph ph-x text-red-600 text-xl"></i>';

          const explanationHtml = !item.isCorrect 
            ? `<div class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-700">
                 <p class="text-sm font-bold text-gray-500 mb-1">${t.explanation}</p>
                 <p class="text-gray-700 dark:text-gray-300 text-sm leading-relaxed">${item.explanation || 'No explanation provided.'}</p>
               </div>` 
            : '';

          el.innerHTML = `
            <div class="flex gap-3">
              <div class="mt-1">${icon}</div>
              <div class="w-full">
                <p class="font-medium text-gray-900 dark:text-white mb-3 text-lg">${originalQ ? originalQ.text : 'Question'}</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div class="${item.isCorrect ? 'text-green-700 dark:text-green-400' : 'text-red-700 dark:text-red-400'}">
                    <span class="font-bold block text-xs opacity-70 mb-1">${t.yourAns}</span>
                    ${item.userSelected}
                  </div>
                  ${!item.isCorrect ? `
                  <div class="text-green-700 dark:text-green-400">
                     <span class="font-bold block text-xs opacity-70 mb-1">${t.correctAns}</span>
                     ${item.correctAnswer}
                  </div>` : ''}
                </div>
                ${explanationHtml}
              </div>
            </div>
          `;
          container.appendChild(el);
        });
        window.scrollTo(0,0);
      }
    </script>
  </body>
</html>
