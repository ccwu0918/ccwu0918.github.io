<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NquMeta NFT Minting DApp</title>
    
    <!-- 1. è¼‰å…¥å¿…è¦çš„å‡½å¼åº« -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.11.1/ethers.umd.min.js"></script>

    <style>
        /* --- åŸºç¤æ¨£å¼ --- */
        body {
            margin: 0; padding: 0; background-color: #0f172a; color: #e2e8f0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; padding-top: 50px; padding-bottom: 50px;
        }

        .app-container { width: 100%; max-width: 520px; padding: 20px; }

        .card {
            background: #1e293b; border-radius: 20px; padding: 40px 30px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5); border: 1px solid #334155;
            text-align: center; margin-bottom: 20px; position: relative;
            overflow: hidden;
        }

        header h1 {
            margin: 0; background: linear-gradient(to right, #60a5fa, #a78bfa);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            font-size: 2.5rem; font-weight: 800;
        }

        .subtitle { color: #94a3b8; margin-top: 5px; font-size: 0.9rem; }

        /* --- ç‹€æ…‹èˆ‡çµ±è¨ˆ --- */
        .stats-container {
            display: flex; justify-content: space-between; margin: 30px 0;
            background: #0f172a; padding: 15px; border-radius: 12px;
        }
        .stat-box { display: flex; flex-direction: column; }
        .label { font-size: 0.8rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; }
        .value { font-size: 1.2rem; font-weight: bold; color: #f1f5f9; }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        button { cursor: pointer; transition: all 0.2s; font-weight: 600; border: none; }
        
        .connect-btn {
            width: 100%; padding: 15px; background: #3b82f6; color: white;
            border-radius: 12px; font-size: 1rem;
        }
        .connect-btn:hover { background: #2563eb; }

        .address-display {
            background: #334155; display: inline-block; padding: 5px 12px;
            border-radius: 20px; font-size: 0.9rem; color: #cbd5e1; margin-bottom: 20px;
        }

        .mint-btn {
            width: 100%; padding: 16px; background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white; border-radius: 12px; font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }
        .mint-btn:disabled { background: #475569; box-shadow: none; cursor: wait; }
        .mint-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6); }

        .quantity-selector { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .quantity-selector button {
            width: 40px; height: 40px; border-radius: 50%; border: 2px solid #475569;
            background: transparent; color: white; font-size: 1.2rem;
        }
        .quantity-selector button:disabled { opacity: 0.3; cursor: not-allowed; }
        .quantity-selector span { font-size: 1.5rem; font-weight: bold; }

        .status-message { margin-top: 20px; min-height: 24px; font-size: 0.9rem; }
        .error-text { color: #ef4444; }
        .info-text { color: #10b981; }

        /* --- Admin Panel --- */
        .admin-panel {
            background: #312e81; /* æ·±ç´«è‰²èƒŒæ™¯å€éš” */
            border: 1px solid #6366f1;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 25px;
            text-align: left;
        }
        .admin-title { font-size: 0.9rem; color: #a5b4fc; font-weight: bold; margin-bottom: 10px; display: flex; align-items: center; gap: 5px; }
        .admin-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .admin-btn {
            padding: 8px 12px; border-radius: 8px; font-size: 0.85rem; color: white;
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .admin-btn:hover { background: rgba(255, 255, 255, 0.2); }
        .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 5px; }
        .status-on { background-color: #4ade80; box-shadow: 0 0 5px #4ade80; }
        .status-off { background-color: #ef4444; }

        /* --- NFT Grid --- */
        .nft-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px; margin-top: 20px;
        }
        .nft-card {
            background: #0f172a; border: 1px solid #334155; border-radius: 12px;
            padding: 10px; text-align: center; transition: transform 0.2s;
            display: flex; flex-direction: column; align-items: center;
        }
        .nft-card:hover { transform: translateY(-3px); border-color: #6366f1; }
        
        /* åœ–ç‰‡å®¹å™¨ */
        .nft-image-box {
            width: 100%; aspect-ratio: 1; border-radius: 8px; overflow: hidden;
            background: #1e293b; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .nft-image { width: 100%; height: 100%; object-fit: cover; }
        .nft-placeholder { font-size: 2rem; }
        
        .nft-id { font-size: 1rem; font-weight: bold; color: #a78bfa; margin-bottom: 5px; }
        
        .transfer-input {
            width: 90%; padding: 6px; margin-bottom: 6px; border-radius: 4px;
            border: 1px solid #475569; background: #1e293b; color: white; font-size: 0.75rem;
        }
        .transfer-btn {
            width: 100%; padding: 6px; font-size: 0.75rem; background: #ef4444;
            color: white; border-radius: 4px;
        }
        .transfer-btn:hover { background: #dc2626; }
        
        .section-title {
            text-align: left; margin-top: 30px; margin-bottom: 15px;
            font-size: 1.2rem; border-bottom: 1px solid #334155; padding-bottom: 10px; color: #f1f5f9;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const ethers = window.ethers;

        // âš ï¸ è«‹æ›¿æ›æˆæ‚¨åœ¨ Remix éƒ¨ç½²å¾Œçš„åˆç´„åœ°å€
        // âš ï¸ åˆç´„åœ°å€ "0x0FfFF4a1Ef4857047b717419702228DC92FFf09A"
        const CONTRACT_ADDRESS = "0xB2061d8eDc4D6792Be6aed586034CeAa54D9A3eF";

        // âš ï¸ æ›´æ–° ABI
        const CONTRACT_ABI = [
            // åŸºæœ¬åŠŸèƒ½
            "function mintNquMeta(uint256 tokenQuantity) public payable",
            "function totalSupply() view returns (uint256)",
            "function MAX_SUPPLY() view returns (uint256)",
            "function ownerOf(uint256 tokenId) view returns (address)",
            "function safeTransferFrom(address from, address to, uint256 tokenId)",
            // Metadata
            "function tokenURI(uint256 tokenId) view returns (string)",
            // ç‹€æ…‹è®Šæ•¸ (Getters)
            "function _isSaleActive() view returns (bool)",
            "function _revealed() view returns (bool)",
            // ç®¡ç†å“¡åŠŸèƒ½
            "function owner() view returns (address)",
            "function flipSaleActive() public",
            "function flipReveal() public"
        ];

        function App() {
            const [account, setAccount] = useState(null);
            const [isOwner, setIsOwner] = useState(false); // æ˜¯å¦ç‚ºåˆç´„æ“æœ‰è€…
            const [isConnecting, setIsConnecting] = useState(false);
            const [isMinting, setIsMinting] = useState(false);
            
            // åˆç´„æ•¸æ“š
            const [supply, setSupply] = useState(0);
            const [quantity, setQuantity] = useState(1);
            const [isSaleActive, setIsSaleActive] = useState(false);
            const [isRevealed, setIsRevealed] = useState(false);
            
            // UI ç‹€æ…‹
            const [status, setStatus] = useState("");
            const [error, setError] = useState("");
            const [userNFTs, setUserNFTs] = useState([]);
            const [transferringId, setTransferringId] = useState(null);
            const [isAdminAction, setIsAdminAction] = useState(false);

            useEffect(() => {
                checkIfWalletIsConnected();
                if (window.ethereum) {
                    window.ethereum.on('accountsChanged', handleAccountsChanged);
                }
                return () => {
                    if (window.ethereum) {
                        window.ethereum.removeListener('accountsChanged', handleAccountsChanged);
                    }
                };
            }, []);

            const handleAccountsChanged = (accounts) => {
                if (accounts.length > 0) {
                    setAccount(accounts[0]);
                    fetchContractData(accounts[0]);
                } else {
                    setAccount(null);
                    setIsOwner(false);
                    setStatus("è«‹é€£æ¥éŒ¢åŒ…");
                    setUserNFTs([]);
                }
            };

            const checkIfWalletIsConnected = async () => {
                if (window.location.protocol === 'file:') return;
                if (window.ethereum) {
                    try {
                        const provider = new ethers.BrowserProvider(window.ethereum);
                        const accounts = await provider.listAccounts();
                        if (accounts.length > 0) {
                            setAccount(accounts[0].address);
                            fetchContractData(accounts[0].address);
                        }
                    } catch (err) {
                        console.error(err);
                    }
                }
            };

            const connectWallet = async () => {
                if (window.location.protocol === 'file:') {
                    setError("âš ï¸ è«‹ä½¿ç”¨ Local Server åŸ·è¡Œã€‚");
                    return;
                }
                if (typeof window.ethereum === 'undefined') {
                    setError("æœªåµæ¸¬åˆ° MetaMaskã€‚");
                    return;
                }
                setIsConnecting(true);
                try {
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const accounts = await provider.send("eth_requestAccounts", []);
                    if (accounts && accounts.length > 0) {
                        setAccount(accounts[0]);
                        setError("");
                        setStatus("éŒ¢åŒ…é€£æ¥æˆåŠŸ ğŸŸ¢");
                        await fetchContractData(accounts[0]);
                    }
                } catch (err) {
                    console.error(err);
                    setError("é€£æ¥å¤±æ•—");
                } finally {
                    setIsConnecting(false);
                }
            };

            // æ ¸å¿ƒï¼šè®€å–åˆç´„æ•¸æ“š
            const fetchContractData = async (currentAccount) => {
                if (!window.ethereum) return;
                try {
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);

                    // 1. è®€å–ç‹€æ…‹
                    const total = await contract.totalSupply();
                    const saleActive = await contract._isSaleActive();
                    const revealed = await contract._revealed();
                    const contractOwner = await contract.owner();

                    setSupply(total.toString());
                    setIsSaleActive(saleActive);
                    setIsRevealed(revealed);
                    
                    // 2. åˆ¤æ–·æ¬Šé™
                    if (currentAccount && contractOwner.toLowerCase() === currentAccount.toLowerCase()) {
                        setIsOwner(true);
                    } else {
                        setIsOwner(false);
                    }

                    // 3. æ›´æ–°ç‹€æ…‹é¡¯ç¤º
                    if (!saleActive) setStatus("âš ï¸ è²©å”®æš«åœä¸­ (Paused)");
                    else setStatus("ğŸŸ¢ è²©å”®é€²è¡Œä¸­ (Active)");

                    // 4. è®€å–ä½¿ç”¨è€…çš„ NFT
                    if (currentAccount) {
                        const ownedIds = [];
                        const maxSupply = 10; // ç¯„ä¾‹ç‚º10
                        for (let i = 1; i <= maxSupply; i++) {
                            try {
                                const owner = await contract.ownerOf(i);
                                if (owner.toLowerCase() === currentAccount.toLowerCase()) {
                                    ownedIds.push(i);
                                }
                            } catch (e) {}
                        }
                        setUserNFTs(ownedIds);
                    }

                } catch (err) {
                    console.error("æ•¸æ“šè®€å–éŒ¯èª¤:", err);
                }
            };

            // ç®¡ç†å“¡ï¼šåˆ‡æ›è²©å”®ç‹€æ…‹
            const toggleSale = async () => {
                if (!isOwner) return;
                setIsAdminAction(true);
                try {
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const signer = await provider.getSigner();
                    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    const tx = await contract.flipSaleActive();
                    setStatus("æ­£åœ¨åˆ‡æ›è²©å”®ç‹€æ…‹...");
                    await tx.wait();
                    setStatus("âœ… è²©å”®ç‹€æ…‹å·²æ›´æ–°");
                    fetchContractData(account);
                } catch (err) {
                    console.error(err);
                    alert("æ“ä½œå¤±æ•—: " + (err.reason || "æœªçŸ¥éŒ¯èª¤"));
                } finally { setIsAdminAction(false); }
            };

            // ç®¡ç†å“¡ï¼šåˆ‡æ›ç›²ç›’ç‹€æ…‹
            const toggleReveal = async () => {
                if (!isOwner) return;
                setIsAdminAction(true);
                try {
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const signer = await provider.getSigner();
                    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    const tx = await contract.flipReveal();
                    setStatus("æ­£åœ¨åˆ‡æ›ç›²ç›’ç‹€æ…‹...");
                    await tx.wait();
                    setStatus("âœ… ç›²ç›’ç‹€æ…‹å·²æ›´æ–°");
                    fetchContractData(account);
                } catch (err) {
                    console.error(err);
                    alert("æ“ä½œå¤±æ•—: " + (err.reason || "æœªçŸ¥éŒ¯èª¤"));
                } finally { setIsAdminAction(false); }
            };

            const mintNFT = async () => {
                if (!account) return;
                setIsMinting(true);
                setError("");
                setStatus("ç­‰å¾…ç¢ºèªä¸­... ğŸ¦Š");

                try {
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const signer = await provider.getSigner();
                    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    const pricePerToken = ethers.parseEther("0.0001");
                    const totalPrice = pricePerToken * BigInt(quantity);
                    const tx = await contract.mintNquMeta(quantity, { value: totalPrice });
                    setStatus("äº¤æ˜“ç™¼é€æˆåŠŸï¼å€å¡Šç¢ºèªä¸­... ğŸ§±");
                    await tx.wait(1);
                    setStatus(`ğŸ‰ é‘„é€ æˆåŠŸï¼`);
                    fetchContractData(account);
                } catch (err) {
                    console.error(err);
                    setError(err.reason ? `åˆç´„éŒ¯èª¤: ${err.reason}` : "äº¤æ˜“å¤±æ•—");
                } finally { setIsMinting(false); }
            };

            const handleTransfer = async (tokenId, toAddress) => {
                if (!ethers.isAddress(toAddress)) return alert("ç„¡æ•ˆåœ°å€");
                if (!confirm(`ç¢ºå®šè½‰é€ #${tokenId} çµ¦ ${toAddress}?`)) return;
                setTransferringId(tokenId);
                try {
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const signer = await provider.getSigner();
                    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    const tx = await contract.safeTransferFrom(account, toAddress, tokenId);
                    setStatus("è½‰é€ä¸­...");
                    await tx.wait();
                    setStatus(`âœ… #${tokenId} è½‰é€æˆåŠŸ`);
                    fetchContractData(account);
                } catch (err) {
                    alert("è½‰é€å¤±æ•—");
                } finally { setTransferringId(null); }
            };

            return (
                <div className="app-container">
                    <div className="card">
                        <header>
                            <h1>ğŸ’ NquMeta NFT</h1>
                            <p className="subtitle">ERC721A Gas Optimized Collection</p>
                        </header>

                        {/* --- Admin Panel (åªå° Owner é¡¯ç¤º) --- */}
                        {account && isOwner && (
                            <div className="admin-panel">
                                <div className="admin-title">ğŸ”´ ç®¡ç†å“¡æ§åˆ¶å° (Admin Dashboard)</div>
                                <div className="admin-controls">
                                    <button className="admin-btn" onClick={toggleSale} disabled={isAdminAction}>
                                        <span className={`status-indicator ${isSaleActive ? 'status-on' : 'status-off'}`}></span>
                                        {isSaleActive ? "é—œé–‰è²©å”®" : "é–‹å•Ÿè²©å”®"}
                                    </button>
                                    <button className="admin-btn" onClick={toggleReveal} disabled={isAdminAction}>
                                        <span className={`status-indicator ${isRevealed ? 'status-on' : 'status-off'}`}></span>
                                        {isRevealed ? "éš±è—ç›²ç›’" : "é–‹å•Ÿç›²ç›’"}
                                    </button>
                                </div>
                            </div>
                        )}

                        <div className="stats-container">
                            <div className="stat-box">
                                <span className="label">å·²é‘„é€ </span>
                                <span className="value">{supply} / 10</span>
                            </div>
                            <div className="stat-box">
                                <span className="label">ç‹€æ…‹</span>
                                <span className="value" style={{color: isSaleActive ? '#4ade80' : '#ef4444'}}>
                                    {isSaleActive ? "é€²è¡Œä¸­" : "æš«åœ"}
                                </span>
                            </div>
                        </div>

                        {!account ? (
                            <button className="connect-btn" onClick={connectWallet} disabled={isConnecting}>
                                {isConnecting ? "é€£æ¥ä¸­..." : "é€£æ¥éŒ¢åŒ…"}
                            </button>
                        ) : (
                            <div>
                                <div className="quantity-selector">
                                    <button onClick={() => setQuantity(Math.max(1, quantity - 1))} disabled={isMinting}>-</button>
                                    <span>{quantity}</span>
                                    <button onClick={() => setQuantity(Math.min(5, quantity + 1))} disabled={isMinting}>+</button>
                                </div>
                                <button className="mint-btn" onClick={mintNFT} disabled={isMinting || !isSaleActive}>
                                    {isMinting ? "é‘„é€ ä¸­..." : (isSaleActive ? `ç«‹å³é‘„é€  ${quantity} å€‹ (0.0001 ETH)` : "ç›®å‰ç„¡æ³•é‘„é€ ")}
                                </button>

                                {userNFTs.length > 0 && (
                                    <div>
                                        <h3 className="section-title">ğŸ–¼ï¸ æˆ‘çš„æ”¶è— ({userNFTs.length})</h3>
                                        <div className="nft-grid">
                                            {userNFTs.map(id => (
                                                <NFTCard 
                                                    key={id} 
                                                    tokenId={id} 
                                                    onTransfer={handleTransfer} 
                                                    isTransferring={transferringId === id}
                                                    isRevealed={isRevealed}
                                                />
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        <div className="status-message">
                            {error && <p className="error-text">{error}</p>}
                            {status && <p className="info-text">{status}</p>}
                        </div>
                    </div>
                </div>
            );
        }

        // --- å­å…ƒä»¶ï¼šNFT å¡ç‰‡ (å« Metadata è®€å–) ---
        function NFTCard({ tokenId, onTransfer, isTransferring, isRevealed }) {
            const [toAddress, setToAddress] = useState("");
            const [metaImage, setMetaImage] = useState(null);
            const [loadingMeta, setLoadingMeta] = useState(false);

            useEffect(() => {
                if (isRevealed) {
                    fetchMetadata();
                } else {
                    setMetaImage(null); // ç›²ç›’ç‹€æ…‹
                }
            }, [isRevealed, tokenId]);

            const fetchMetadata = async () => {
                setLoadingMeta(true);
                try {
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
                    
                    // å–å¾— tokenURI (å¦‚ ipfs://Qm.../1.json)
                    const uri = await contract.tokenURI(tokenId);
                    
                    if (uri) {
                        // è½‰æ› IPFS å”è­°
                        const httpUri = uri.replace("ipfs://", "https://ipfs.io/ipfs/");
                        const response = await fetch(httpUri);
                        const metadata = await response.json();
                        
                        if (metadata.image) {
                            setMetaImage(metadata.image.replace("ipfs://", "https://ipfs.io/ipfs/"));
                        }
                    }
                } catch (err) {
                    console.error("Metadata error:", err);
                } finally {
                    setLoadingMeta(false);
                }
            };

            return (
                <div className="nft-card">
                    <div className="nft-image-box">
                        {!isRevealed ? (
                            <span className="nft-placeholder">ğŸ</span>
                        ) : (
                            loadingMeta ? (
                                <span style={{fontSize: "0.8rem", color: "#64748b"}}>Loading...</span>
                            ) : (
                                metaImage ? <img src={metaImage} className="nft-image" alt={`NFT #${tokenId}`} /> : <span className="nft-placeholder">ğŸ–¼ï¸</span>
                            )
                        )}
                    </div>
                    
                    <span className="nft-id">#{tokenId}</span>
                    <span style={{fontSize: "0.75rem", color: "#64748b", marginBottom: "8px"}}>
                        {isRevealed ? "å·²é–‹å•Ÿ" : "æœªé–‹å•Ÿ"}
                    </span>
                    
                    <input 
                        type="text" placeholder="æ¥æ”¶åœ°å€ 0x..." className="transfer-input"
                        value={toAddress} onChange={(e) => setToAddress(e.target.value)}
                        disabled={isTransferring}
                    />
                    <button 
                        className="transfer-btn"
                        disabled={isTransferring || !toAddress}
                        onClick={() => onTransfer(tokenId, toAddress)}
                    >
                        {isTransferring ? "..." : "è½‰è´ˆ"}
                    </button>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
