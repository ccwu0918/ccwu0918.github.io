<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NQU Web3 å»ä¸­å¿ƒåŒ–éŠ€è¡Œ</title>
    <!-- 1. Ethers.js v6 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <!-- 2. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 3. FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 4. QRCode.js (ç”Ÿæˆ QR Code) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- 5. HTML5-QRCode (æƒæ QR Code) -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', sans-serif; }
        /* å‹•ç•«æ•ˆæœ */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        
        /* éš±è— Input type=number çš„ä¸Šä¸‹ç®­é ­ */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
    </style>
</head>
<body>

<!-- é ‚éƒ¨å°èˆª -->
<nav class="bg-blue-600 text-white p-4 shadow-lg sticky top-0 z-40">
    <div class="container mx-auto flex justify-between items-center">
        <div class="flex items-center gap-2">
            <i class="fa-solid fa-building-columns text-2xl"></i>
            <h1 class="text-xl font-bold hidden md:block">NQU Web3 å»ä¸­å¿ƒåŒ–éŠ€è¡Œ</h1>
            <h1 class="text-xl font-bold md:hidden">NQU Bank</h1>
        </div>

        <div class="flex gap-3 items-center">
            <!-- æœªé€£ç·š -->
            <button id="btnConnect" onclick="connectWallet()" class="bg-white text-blue-600 hover:bg-blue-50 px-5 py-2.5 rounded-lg font-bold transition shadow-md flex items-center gap-2">
                <i class="fa-solid fa-wallet"></i> é€£æ¥éŒ¢åŒ…
            </button>

            <!-- å·²é€£ç·š -->
            <div id="connectedActions" class="hidden flex items-center gap-3 animate-fade-in">
                <div id="roleTags" class="flex gap-2"></div>
                <!-- ç¸®ç•¥åœ°å€ -->
                <div class="hidden md:flex bg-blue-700 bg-opacity-50 px-3 py-2 rounded-lg items-center gap-2 border border-blue-500">
                    <i class="fa-regular fa-id-card text-blue-200"></i>
                    <span id="navWalletAddress" class="font-mono text-sm font-semibold">0x...</span>
                </div>
                <!-- ç‹€æ…‹æ¨™ç±¤ -->
                <div class="bg-blue-400 bg-opacity-30 text-blue-100 px-4 py-2 rounded-lg font-bold flex items-center gap-2 border border-blue-400 select-none">
                    <i class="fa-solid fa-check"></i> éŒ¢åŒ…å·²é€£æ¥
                </div>
                <!-- æ–·é–‹é€£ç·š -->
                <button onclick="disconnect()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-bold transition shadow-sm flex items-center gap-2">
                    <i class="fa-solid fa-right-from-bracket"></i> æ–·é–‹é€£ç·š
                </button>
            </div>
        </div>
    </div>
</nav>

<div class="container mx-auto p-6 max-w-6xl relative">
    
    <!-- 1. é ‚éƒ¨è³‡è¨Š -->
    <div class="card bg-white p-4 rounded-xl shadow-sm mb-6 flex flex-col md:flex-row justify-between items-center border border-gray-200 gap-4">
        <div class="w-full">
            <label class="text-xs text-gray-500 font-bold uppercase">æ™ºèƒ½åˆç´„åœ°å€</label>
            <div class="flex gap-2 mt-1">
                <code class="bg-gray-100 p-2 rounded text-sm w-full break-all font-mono text-gray-600" id="contractAddressDisplay">Loading...</code>
                <a href="#" target="_blank" class="text-blue-600 hover:text-blue-800 text-sm flex items-center whitespace-nowrap"><i class="fa-solid fa-arrow-up-right-from-square mr-1"></i> æŸ¥çœ‹</a>
            </div>
        </div>
    </div>

    <!-- 2. è³‡ç”¢çœ‹æ¿ (èª¿æ•´ç‚ºä¸‰æ¬„ï¼Œæ”¾ç½® QR Code) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <!-- éŠ€è¡Œå„²å‚™ -->
        <div class="bg-gradient-to-br from-blue-600 to-blue-700 text-white rounded-xl p-6 shadow-lg relative overflow-hidden">
            <div class="absolute top-0 right-0 -mr-4 -mt-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl"></div>
            <h3 class="font-semibold text-blue-100 mb-2 flex items-center gap-2">
                <i class="fa-solid fa-vault"></i> éŠ€è¡Œç¸½å„²å‚™é‡‘
            </h3>
            <div class="text-4xl font-bold mb-4 tracking-tight"><span id="totalDeposit">0.00</span> <span class="text-xl token-symbol opacity-80">NQU</span></div>
            <div class="flex justify-between items-end border-t border-blue-500 pt-4 mt-2">
                <div><p class="text-xs text-blue-200">ç›®å‰è²»ç‡</p><p class="font-bold text-lg" id="currentFeeRate">--%</p></div>
                <div class="text-right"><p class="text-xs text-blue-200">éŠ€è¡Œç‹€æ…‹</p><p class="font-bold" id="systemStatus">æª¢æŸ¥ä¸­...</p></div>
            </div>
        </div>

        <!-- ç”¨æˆ¶é¤˜é¡ -->
        <div class="bg-white rounded-xl p-6 shadow-md border border-gray-100 relative">
            <h3 class="font-semibold text-gray-500 mb-2 flex items-center gap-2">
                <i class="fa-solid fa-sack-dollar"></i> æ‚¨çš„å­˜æ¬¾é¤˜é¡
            </h3>
            <div class="text-4xl font-bold text-gray-800 mb-4 tracking-tight"><span id="myBalance">0.00</span> <span class="text-xl text-gray-500 token-symbol">NQU</span></div>
            <div class="flex justify-between items-end border-t border-gray-100 pt-4 mt-2">
                <div><p class="text-xs text-gray-400">éŒ¢åŒ…é¤˜é¡</p><p class="font-bold text-gray-600 font-mono" id="walletBalance">0.00</p></div>
                <div class="text-right"><p class="text-xs text-gray-400">æˆæ¬Šç‹€æ…‹</p><p class="font-bold text-green-600" id="allowanceText">Checking...</p></div>
            </div>
        </div>

        <!-- 3. æ”¶æ¬¾ QR Code é¡¯ç¤ºå€ (èª¿æ•´è‡³æ­¤ï¼Œèˆ‡ä¸‹æ–¹è½‰å¸³å°é½Š) -->
        <div id="receiveSection" class="hidden bg-white p-6 rounded-xl shadow-md border border-gray-200 relative text-center animate-fade-in flex flex-col justify-center items-center">
            <h3 class="text-lg font-bold text-gray-800 mb-2">
                <i class="fa-solid fa-qrcode text-blue-500 mr-2"></i> æˆ‘çš„æ”¶æ¬¾ç¢¼
            </h3>
            <p class="text-xs text-gray-500 mb-3">è®“å°æ–¹æƒææ­¤æ¢ç¢¼ä»¥è½‰å¸³çµ¦æ‚¨</p>
            
            <!-- QR Code å®¹å™¨ -->
            <div id="qrcode" class="flex justify-center mb-3 p-2 border-2 border-dashed border-gray-300 rounded-lg inline-block"></div>
            
            <p class="font-mono text-xs text-gray-600 bg-gray-100 p-2 rounded break-all w-full text-center" id="displayQrAddress">...</p>
        </div>
    </div>

    <!-- 4. ç”¨æˆ¶åŠŸèƒ½å€ (ä¸‰æ¬„) -->
    <div id="userActions" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
        
        <!-- A. å­˜æ¬¾å¡ç‰‡ -->
        <div class="bg-white rounded-xl p-6 shadow-md border-t-4 border-green-500 hover:shadow-lg transition">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600"><i class="fa-solid fa-plus"></i></div>
                å­˜æ¬¾ (Deposit)
            </h3>
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">é‡‘é¡ (<span class="token-symbol">NQU</span>)</label>
                <!-- å¢æ¸›æŒ‰éˆ•ç¾¤çµ„ -->
                <div class="flex items-center border border-gray-200 rounded-lg bg-gray-50 overflow-hidden focus-within:ring-2 focus-within:ring-green-500">
                    <button onclick="adjustAmount('depositInput', -1)" class="px-4 py-3 bg-gray-100 hover:bg-gray-200 border-r border-gray-200 text-gray-600 font-bold active:bg-gray-300 transition">-</button>
                    <input type="number" id="depositInput" class="w-full p-3 bg-transparent text-center outline-none font-bold text-gray-700" placeholder="0.1">
                    <button onclick="adjustAmount('depositInput', 1)" class="px-4 py-3 bg-gray-100 hover:bg-gray-200 border-l border-gray-200 text-gray-600 font-bold active:bg-gray-300 transition">+</button>
                </div>
            </div>
            
            <div id="approveContainer" class="hidden mb-3 animate-fade-in">
                <button onclick="approveToken()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg transition flex justify-center items-center gap-2">
                    <i class="fa-solid fa-file-signature"></i> æ­¥é©Ÿ 1: æˆæ¬Šä»£å¹£
                </button>
                <p class="text-xs text-center text-gray-400 mt-1">é¦–æ¬¡å­˜æ¬¾éœ€å…ˆæˆæ¬Š</p>
            </div>
            
            <button id="btnDeposit" onclick="deposit()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition shadow-green-200 shadow-lg flex justify-center items-center gap-2">
                <i class="fa-solid fa-download"></i> å­˜å…¥è³‡é‡‘
            </button>
        </div>

        <!-- B. ææ¬¾å¡ç‰‡ -->
        <div class="bg-white rounded-xl p-6 shadow-md border-t-4 border-red-500 hover:shadow-lg transition">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-red-100 flex items-center justify-center text-red-600"><i class="fa-solid fa-minus"></i></div>
                ææ¬¾ (Withdraw)
            </h3>
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">é‡‘é¡ (<span class="token-symbol">NQU</span>)</label>
                <!-- å¢æ¸›æŒ‰éˆ•ç¾¤çµ„ -->
                <div class="flex items-center border border-gray-200 rounded-lg bg-gray-50 overflow-hidden focus-within:ring-2 focus-within:ring-red-500">
                    <button onclick="adjustAmount('withdrawInput', -1)" class="px-4 py-3 bg-gray-100 hover:bg-gray-200 border-r border-gray-200 text-gray-600 font-bold active:bg-gray-300 transition">-</button>
                    <input type="number" id="withdrawInput" class="w-full p-3 bg-transparent text-center outline-none font-bold text-gray-700" placeholder="0.1">
                    <button onclick="adjustAmount('withdrawInput', 1)" class="px-4 py-3 bg-gray-100 hover:bg-gray-200 border-l border-gray-200 text-gray-600 font-bold active:bg-gray-300 transition">+</button>
                </div>
            </div>
            <button onclick="withdraw()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition shadow-red-200 shadow-lg flex justify-center items-center gap-2">
                <i class="fa-solid fa-upload"></i> æå–è³‡é‡‘
            </button>
        </div>

        <!-- C. è½‰å¸³å¡ç‰‡ (å«æƒæèˆ‡èª¿æ•´) -->
        <div class="bg-white rounded-xl p-6 shadow-md border-t-4 border-purple-500 hover:shadow-lg transition flex flex-col h-full">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600"><i class="fa-solid fa-arrow-right-arrow-left"></i></div>
                å…§éƒ¨è½‰å¸³ (Transfer)
            </h3>
            
            <div class="mb-3">
                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">æ”¶æ¬¾äººåœ°å€</label>
                <div class="flex gap-2">
                    <input type="text" id="transferTo" class="w-full p-3 border border-gray-200 bg-gray-50 rounded-lg focus:ring-2 focus:ring-purple-500 focus:outline-none text-sm font-mono" placeholder="0x...">
                    <!-- æƒææŒ‰éˆ• -->
                    <button onclick="toggleScanner()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-3 rounded-lg transition" title="æƒæ QR Code">
                        <i class="fa-solid fa-qrcode text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-1 uppercase">é‡‘é¡ (<span class="token-symbol">NQU</span>)</label>
                <!-- å¢æ¸›æŒ‰éˆ•ç¾¤çµ„ -->
                <div class="flex items-center border border-gray-200 rounded-lg bg-gray-50 overflow-hidden focus-within:ring-2 focus-within:ring-purple-500">
                    <button onclick="adjustAmount('transferAmount', -1)" class="px-4 py-3 bg-gray-100 hover:bg-gray-200 border-r border-gray-200 text-gray-600 font-bold active:bg-gray-300 transition">-</button>
                    <input type="number" id="transferAmount" class="w-full p-3 bg-transparent text-center outline-none font-bold text-gray-700" placeholder="0.1">
                    <button onclick="adjustAmount('transferAmount', 1)" class="px-4 py-3 bg-gray-100 hover:bg-gray-200 border-l border-gray-200 text-gray-600 font-bold active:bg-gray-300 transition">+</button>
                </div>
            </div>

            <button onclick="transfer()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition shadow-purple-200 shadow-lg flex justify-center items-center gap-2 mt-auto">
                <i class="fa-solid fa-paper-plane"></i> è½‰å¸³çµ¦ä»–äºº
            </button>
        </div>
    </div>

    <!-- 5. äº¤æ˜“æ—¥èªŒå€ -->
    <div id="statusLog" class="hidden bg-gray-800 text-green-400 p-4 rounded-lg font-mono text-sm mb-12 shadow-inner border-l-4 border-green-500">
        <div class="flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
            <span id="logText">System Ready...</span>
        </div>
    </div>

    <!-- ==================================================== -->
    <!--           QR Code æƒæå™¨ Modal (é è¨­éš±è—)            -->
    <!-- ==================================================== -->
    <div id="scannerModal" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex flex-col justify-center items-center">
        <div class="bg-white p-4 rounded-xl w-full max-w-md relative">
            <h3 class="text-lg font-bold text-center mb-4">æƒæéŒ¢åŒ…åœ°å€</h3>
            <!-- æƒæå€åŸŸ -->
            <div id="reader" style="width: 100%;"></div>
            
            <button onclick="toggleScanner()" class="mt-4 w-full bg-red-500 text-white py-2 rounded-lg font-bold">
                é—œé–‰æƒæå™¨
            </button>
        </div>
    </div>

    <!-- ==================================================== -->
    <!--               ç®¡ç†å“¡å¾Œå° (Admin Panel)               -->
    <!-- ==================================================== -->
    <div id="adminPanel" class="hidden animate-fade-in pb-20">
        <div class="flex items-center gap-2 mb-4">
            <h2 class="text-2xl font-bold text-gray-800">ğŸ›¡ï¸ ç®¡ç†å“¡æ§åˆ¶å°</h2>
            <span class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-bold shadow-sm">Admin Access</span>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- A. è²»ç‡æ™‚é–“é– -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h4 class="font-bold text-gray-700 mb-3 border-b pb-2"><i class="fa-regular fa-clock mr-2"></i> è²»ç‡æ™‚é–“é–</h4>
                <div class="mb-4 bg-gray-50 p-3 rounded text-center"><p class="text-xs text-gray-500">ç‹€æ…‹</p><p id="timelockStatus" class="font-bold text-orange-500">ç„¡å¾…è™•ç†æ›´æ–°</p></div>
                <div id="queueSection">
                    <input type="number" id="newFeeRate" placeholder="æ–°è²»ç‡ (100=1%)" class="w-full p-2 border rounded mb-2 text-sm bg-gray-50">
                    <button onclick="queueFeeRate()" class="w-full bg-gray-700 text-white py-2 rounded text-sm hover:bg-gray-800">1. å…¬å‘Šæ–°è²»ç‡</button>
                </div>
                <div id="executeSection" class="hidden mt-2">
                     <button onclick="executeFeeRate()" class="w-full bg-green-600 text-white py-2 rounded text-sm hover:bg-green-700">2. åŸ·è¡Œæ›´æ–°</button>
                </div>
            </div>
            <!-- B. é»‘åå–® -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h4 class="font-bold text-gray-700 mb-3 border-b pb-2"><i class="fa-solid fa-ban text-red-400 mr-2"></i> é»‘åå–®ç®¡ç†</h4>
                <input type="text" id="blacklistAddr" placeholder="0x..." class="w-full p-2 border rounded mb-2 text-sm bg-gray-50 font-mono">
                <div class="flex gap-2">
                    <button onclick="setBlacklist(true)" class="flex-1 bg-red-600 text-white py-2 rounded text-sm hover:bg-red-700">åŠ å…¥é»‘åå–®</button>
                    <button onclick="setBlacklist(false)" class="flex-1 bg-gray-500 text-white py-2 rounded text-sm hover:bg-gray-600">ç§»é™¤</button>
                </div>
            </div>
            <!-- C. ç³»çµ±æ§åˆ¶ -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h4 class="font-bold text-gray-700 mb-3 border-b pb-2"><i class="fa-solid fa-sliders text-blue-400 mr-2"></i> ç³»çµ±æ§åˆ¶</h4>
                <div class="mb-4 flex gap-2">
                    <input type="text" id="vipAddr" placeholder="VIPåœ°å€..." class="w-full p-2 border rounded text-sm bg-gray-50 font-mono">
                    <button onclick="setVIP(true)" class="bg-yellow-500 text-white px-3 rounded text-sm"><i class="fa-solid fa-crown"></i></button>
                </div>
                <div class="flex gap-2">
                    <button onclick="setPaused(true)" class="flex-1 bg-red-50 text-red-600 border border-red-200 py-2 rounded text-sm font-bold">æš«åœ</button>
                    <button onclick="setPaused(false)" class="flex-1 bg-green-50 text-green-600 border border-green-200 py-2 rounded text-sm font-bold">æ¢å¾©</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ================= CONFIG =================
    const CONTRACT_ADDRESS = "0xF84f73632200836C09F9f7FF5df8745E81d84ebc"; 

    // ABI
    const BANK_ABI = [
        "function authorizedToken() public view returns (address)",
        "function admin() public view returns (address)",
        "function feeRate() public view returns (uint256)",
        "function totalDeposit() public view returns (uint256)",
        "function accumulatedFees() public view returns (uint256)",
        "function paused() public view returns (bool)",
        "function isShutdown() public view returns (bool)",
        "function isVIP(address) public view returns (bool)",
        "function isBlacklisted(address) public view returns (bool)",
        "function balances(address) public view returns (uint256)",
        "function pendingFeeRate() public view returns (uint256)",
        "function feeRateEffectiveTime() public view returns (uint256)",
        "function deposit(uint256 amount) external",
        "function withdraw(uint256 amount) external",
        "function transfer(address to, uint256 amount) external",
        "function queueFeeRateUpdate(uint256 newRate) external",
        "function executeFeeRateUpdate() external",
        "function setBlacklist(address user, bool status) external",
        "function setPaused(bool state) external",
        "function setVIP(address user, bool status) external",
        "function triggerShutdown() external",
        "function batchRefund(address[] users) external",
        "function adminClaimFees() external"
    ];
    const ERC20_ABI = [
        "function approve(address spender, uint256 amount) external returns (bool)",
        "function allowance(address owner, address spender) external view returns (uint256)",
        "function decimals() external view returns (uint8)",
        "function symbol() external view returns (string)",
        "function balanceOf(address account) external view returns (uint256)"
    ];

    let provider, signer, bankContract, tokenContract;
    let userAddress, tokenDecimals = 18, tokenSymbol = "ETH";
    let html5QrcodeScanner = null;

    document.getElementById("contractAddressDisplay").innerText = CONTRACT_ADDRESS;

    // 1. é€£æ¥éŒ¢åŒ…
    async function connectWallet() {
        if (!window.ethereum) return alert("è«‹å®‰è£ MetaMask");
        try {
            provider = new ethers.BrowserProvider(window.ethereum);
            signer = await provider.getSigner();
            userAddress = await signer.getAddress();

            bankContract = new ethers.Contract(CONTRACT_ADDRESS, BANK_ABI, signer);
            const tokenAddr = await bankContract.authorizedToken();
            tokenContract = new ethers.Contract(tokenAddr, ERC20_ABI, signer);
            
            try { 
                tokenDecimals = await tokenContract.decimals(); 
                tokenSymbol = await tokenContract.symbol();
            } catch(e) {}

            document.querySelectorAll(".token-symbol").forEach(el => el.innerText = tokenSymbol);
            updateNavbarState(true);
            generateMyQRCode(userAddress); // ç”Ÿæˆæ”¶æ¬¾ç¢¼
            await loadData();
            log("éŒ¢åŒ…é€£ç·šæˆåŠŸï¼", "text-green-400");

        } catch (err) {
            console.error(err);
            alert("é€£ç·šå¤±æ•—: " + err.message);
        }
    }

    function disconnect() {
        updateNavbarState(false);
        userAddress = null;
        document.getElementById("myBalance").innerText = "0.00";
        document.getElementById("walletBalance").innerText = "0.00";
        document.getElementById("adminPanel").classList.add("hidden");
        document.getElementById("receiveSection").classList.add("hidden"); // éš±è—æ”¶æ¬¾ç¢¼
        log("å·²æ–·é–‹é€£ç·š", "text-gray-400");
    }

    function updateNavbarState(isConnected) {
        if (isConnected) {
            document.getElementById("btnConnect").classList.add("hidden");
            document.getElementById("connectedActions").classList.remove("hidden");
            const shortAddr = userAddress.substring(0, 6) + "..." + userAddress.substring(38);
            document.getElementById("navWalletAddress").innerText = shortAddr;
        } else {
            document.getElementById("btnConnect").classList.remove("hidden");
            document.getElementById("connectedActions").classList.add("hidden");
        }
    }

    async function loadData() {
        if (!bankContract) return;
        
        // è®€å–éŠ€è¡Œå…¨åŸŸæ•¸æ“š
        const totalDep = await bankContract.totalDeposit();
        const feeRate = await bankContract.feeRate();
        const isPaused = await bankContract.paused();
        const isShutdown = await bankContract.isShutdown();
        
        document.getElementById("totalDeposit").innerText = ethers.formatUnits(totalDep, tokenDecimals);
        document.getElementById("currentFeeRate").innerText = (Number(feeRate) / 100) + "%";

        let statusHtml = '<span class="text-green-400 font-bold">â— æ­£å¸¸ç‡Ÿé‹</span>';
        if (isPaused) statusHtml = '<span class="text-red-400 font-bold">â— ç³»çµ±æš«åœ</span>';
        if (isShutdown) statusHtml = '<span class="text-red-600 font-bold">â˜¢ï¸ æ¸…ç®—ä¸­</span>';
        document.getElementById("systemStatus").innerHTML = statusHtml;

        // è®€å–å€‹äººé¤˜é¡
        const myBal = await bankContract.balances(userAddress);
        const walletBal = await tokenContract.balanceOf(userAddress);
        document.getElementById("myBalance").innerText = ethers.formatUnits(myBal, tokenDecimals);
        document.getElementById("walletBalance").innerText = parseFloat(ethers.formatUnits(walletBal, tokenDecimals)).toFixed(4);

        await checkRoles();
        
        // æˆæ¬Šæª¢æŸ¥
        const allowance = await tokenContract.allowance(userAddress, CONTRACT_ADDRESS);
        if (allowance == 0) {
            document.getElementById("allowanceText").innerText = "æœªæˆæ¬Š";
            document.getElementById("allowanceText").className = "font-bold text-red-500";
            document.getElementById("approveContainer").classList.remove("hidden");
            document.getElementById("btnDeposit").disabled = true;
            document.getElementById("btnDeposit").classList.add("opacity-50");
        } else {
            document.getElementById("allowanceText").innerText = "å·²æˆæ¬Š";
            document.getElementById("allowanceText").className = "font-bold text-green-500";
            document.getElementById("approveContainer").classList.add("hidden");
            document.getElementById("btnDeposit").disabled = false;
            document.getElementById("btnDeposit").classList.remove("opacity-50");
        }
    }

    async function checkRoles() {
        const adminAddr = await bankContract.admin();
        const isVIP = await bankContract.isVIP(userAddress);
        const isBlacklisted = await bankContract.isBlacklisted(userAddress);
        const tagsDiv = document.getElementById("roleTags");
        tagsDiv.innerHTML = "";

        if (userAddress.toLowerCase() === adminAddr.toLowerCase()) {
            tagsDiv.innerHTML += `<span class="bg-red-500 text-white px-2 py-1 rounded text-xs font-bold">Admin</span>`;
            document.getElementById("adminPanel").classList.remove("hidden");
        }
        if (isVIP) tagsDiv.innerHTML += `<span class="bg-yellow-500 text-white px-2 py-1 rounded text-xs font-bold">VIP</span>`;
        if (isBlacklisted) {
            tagsDiv.innerHTML += `<span class="bg-black text-white px-2 py-1 rounded text-xs font-bold">Blacklisted</span>`;
            document.getElementById("userActions").classList.add("opacity-50", "pointer-events-none");
        } else {
            document.getElementById("userActions").classList.remove("opacity-50", "pointer-events-none");
        }
    }

    // ================= åŠŸèƒ½å¢å¼·ï¼š+/- é‡‘é¡èª¿æ•´ =================
    function adjustAmount(inputId, delta) {
        const input = document.getElementById(inputId);
        let currentValue = parseFloat(input.value) || 0;
        let newValue = currentValue + delta;
        if (newValue < 0) newValue = 0;
        // è™•ç†æµ®é»æ•¸ç²¾åº¦å•é¡Œ
        input.value = Math.round(newValue * 10000) / 10000;
    }

    // ================= åŠŸèƒ½å¢å¼·ï¼šç”Ÿæˆ QR Code =================
    function generateMyQRCode(address) {
        const container = document.getElementById("qrcode");
        container.innerHTML = ""; // æ¸…ç©ºèˆŠçš„
        
        new QRCode(container, {
            text: address,
            width: 150,
            height: 150,
            colorDark : "#000000",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });
        
        document.getElementById("displayQrAddress").innerText = address;
        document.getElementById("receiveSection").classList.remove("hidden");
    }

    // ================= åŠŸèƒ½å¢å¼·ï¼šæƒæ QR Code =================
    function toggleScanner() {
        const modal = document.getElementById("scannerModal");
        if (modal.classList.contains("hidden")) {
            // é–‹å•Ÿæƒæå™¨
            modal.classList.remove("hidden");
            html5QrcodeScanner = new Html5Qrcode("reader");
            
            html5QrcodeScanner.start(
                { facingMode: "environment" }, // å¾Œç½®é¡é ­
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText, decodedResult) => {
                    // æƒææˆåŠŸå›èª¿
                    if(ethers.isAddress(decodedText)) {
                        document.getElementById("transferTo").value = decodedText;
                        toggleScanner(); // é—œé–‰æƒæå™¨
                        log("åœ°å€æƒææˆåŠŸï¼");
                    } else {
                        alert("æƒæåˆ°çš„å…§å®¹ä¸æ˜¯æœ‰æ•ˆçš„éŒ¢åŒ…åœ°å€");
                    }
                },
                (errorMessage) => {
                    // æƒæéŒ¯èª¤æˆ–ç„¡çµæœ (å¿½ç•¥)
                }
            ).catch(err => {
                alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ: " + err);
                toggleScanner();
            });

        } else {
            // é—œé–‰æƒæå™¨
            if(html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    modal.classList.add("hidden");
                }).catch(err => console.log(err));
            } else {
                modal.classList.add("hidden");
            }
        }
    }

    // ================= äº¤æ˜“åŠŸèƒ½ =================
    async function approveToken() {
        try {
            const tx = await tokenContract.approve(CONTRACT_ADDRESS, ethers.MaxUint256);
            log("æˆæ¬Šç™¼é€ä¸­...", "text-yellow-400");
            await tx.wait();
            log("æˆæ¬ŠæˆåŠŸï¼");
            loadData();
        } catch (e) { log(e.message, "text-red-500"); }
    }

    async function deposit() {
        const val = document.getElementById("depositInput").value;
        if (!val) return;
        try {
            const amount = ethers.parseUnits(val, tokenDecimals);
            const tx = await bankContract.deposit(amount);
            log("å­˜æ¬¾ç™¼é€ä¸­...");
            await tx.wait();
            log("å­˜æ¬¾æˆåŠŸï¼");
            loadData();
        } catch (e) { log(e.reason||e.message, "text-red-500"); }
    }

    async function withdraw() {
        const val = document.getElementById("withdrawInput").value;
        if (!val) return;
        try {
            const amount = ethers.parseUnits(val, tokenDecimals);
            const tx = await bankContract.withdraw(amount);
            log("ææ¬¾ç™¼é€ä¸­...");
            await tx.wait();
            log("ææ¬¾æˆåŠŸï¼");
            loadData();
        } catch (e) { log(e.reason||e.message, "text-red-500"); }
    }

    async function transfer() {
        const to = document.getElementById("transferTo").value;
        const val = document.getElementById("transferAmount").value;
        if (!to || !val) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");
        try {
            const amount = ethers.parseUnits(val, tokenDecimals);
            const tx = await bankContract.transfer(to, amount);
            log("è½‰å¸³ç™¼é€ä¸­...", "text-purple-400");
            await tx.wait();
            log("è½‰å¸³æˆåŠŸï¼");
            loadData();
        } catch (e) { log(e.reason||e.message, "text-red-500"); }
    }

    // ================= ç®¡ç†å“¡åŠŸèƒ½ =================

    async function queueFeeRate() {
        const rate = document.getElementById("newFeeRate").value;
        try {
            const tx = await bankContract.queueFeeRateUpdate(rate);
            log("å·²ç™¼é€æ’ç¨‹è«‹æ±‚...");
            await tx.wait();
            log("æ’ç¨‹æˆåŠŸï¼Œé€²å…¥é–å®šæœŸ");
            loadData();
        } catch (e) { log(e.message, "text-red-500"); }
    }

    async function executeFeeRate() {
        try {
            const tx = await bankContract.executeFeeRateUpdate();
            log("æ­£åœ¨åŸ·è¡Œè²»ç‡æ›´æ–°...");
            await tx.wait();
            log("è²»ç‡æ›´æ–°å®Œç•¢ï¼");
            loadData();
        } catch (e) { log(e.message, "text-red-500"); }
    }

    async function setBlacklist(status) {
        const addr = document.getElementById("blacklistAddr").value;
        if(!addr) return;
        try {
            const tx = await bankContract.setBlacklist(addr, status);
            log(`é»‘åå–®è¨­å®š: ${status}`);
            await tx.wait();
            loadData();
        } catch (e) { log(e.message, "text-red-500"); }
    }

    async function setVIP(status) {
        const addr = document.getElementById("vipAddr").value;
        if(!addr) return;
        try {
            const tx = await bankContract.setVIP(addr, status);
            await tx.wait();
            log("VIP è¨­å®šæˆåŠŸ");
            loadData();
        } catch (e) { log(e.message, "text-red-500"); }
    }

    async function setPaused(state) {
        try {
            const tx = await bankContract.setPaused(state);
            await tx.wait();
            log(state ? "ç³»çµ±å·²æš«åœ" : "ç³»çµ±å·²æ¢å¾©");
            loadData();
        } catch (e) { log(e.message, "text-red-500"); }
    }

    async function claimFees() {
        try {
            const tx = await bankContract.adminClaimFees();
            await tx.wait();
            log("æ”¶ç›Šæé ˜æˆåŠŸ");
            loadData();
        } catch (e) { log(e.message, "text-red-500"); }
    }

    async function triggerShutdown() {
        if(!confirm("âš ï¸ å±éšªï¼šç¢ºå®šè¦é€²å…¥æ¸…ç®—æ¨¡å¼å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼")) return;
        try {
            const tx = await bankContract.triggerShutdown();
            await tx.wait();
            log("å·²é€²å…¥æ¸…ç®—æ¨¡å¼", "text-red-500");
            loadData();
        } catch (e) { log(e.message, "text-red-500"); }
    }

    async function batchRefund() {
        const text = document.getElementById("refundList").value;
        if (!text) return;
        const addresses = text.split('\n').map(a => a.trim()).filter(a => a !== "");
        try {
            const tx = await bankContract.batchRefund(addresses);
            log("æ‰¹æ¬¡é€€æ¬¾åŸ·è¡Œä¸­...");
            await tx.wait();
            log("æ‰¹æ¬¡é€€æ¬¾å®Œç•¢");
            loadData();
        } catch (e) { log(e.message, "text-red-500"); }
    }

    function log(msg, colorClass = "text-green-400") {
        const el = document.getElementById("statusLog");
        const textEl = document.getElementById("logText");
        el.classList.remove("hidden");
        textEl.className = colorClass;
        textEl.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
    }
</script>

</body>
</html>