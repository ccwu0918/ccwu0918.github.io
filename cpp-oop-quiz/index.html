<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C++物件導向程式設計</title>
    <!-- Google Fonts: Noto Sans TC & Fira Code (IDE Font) -->
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Fira+Code:wght@400;500&display=swap"
        rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // 設定 PDF.js worker
        window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Prism.js (Syntax Highlighting) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-core.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }

        .fade-enter-active,
        .fade-leave-active {
            transition: opacity 0.3s ease;
        }

        .fade-enter-from,
        .fade-leave-to {
            opacity: 0;
        }

        /* 自定義捲軸 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* IDE Scrollbar */
        .ide-scroll::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        .ide-scroll::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .ide-scroll::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 5px;
            border: 2px solid #1e293b;
        }

        .ide-scroll::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        /* 動畫 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.3s ease-out forwards;
        }

        /* Modal 動畫 */
        .modal-enter-active,
        .modal-leave-active {
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .modal-enter-from,
        .modal-leave-to {
            opacity: 0;
            transform: scale(0.95);
        }

        /* 啟用狀態動畫 */
        @keyframes pulse-ring {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(34, 197, 94, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
            }
        }

        .active-pulse {
            animation: pulse-ring 2s infinite;
        }

        /* Details Summary Remove Marker */
        details>summary {
            list-style: none;
        }

        details>summary::-webkit-details-marker {
            display: none;
        }

        /* --- New Highlighter Styles --- */
        .passage-content mark {
            background-color: transparent;
            /* Remove default browser style */
            padding: 0;
            margin: 0;
            border-radius: 3px;
            color: black !important;
            /* Force black text for high contrast */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
            /* Subtle text shadow */
            border: 2px solid;
            /* Add a border */
        }

        /* IDE Mode overrides for highlighter */
        .ide-mode-content mark {
            color: #e2e8f0 !important;
            /* Light text for dark background */
            text-shadow: none;
            border-width: 0 0 2px 0;
            /* Underline style for cleaner look in code view */
        }

        .highlight-yellow {
            background-color: rgba(255, 255, 0, 0.4) !important;
            border-color: rgb(255, 255, 0);
        }

        .highlight-green {
            background-color: rgba(128, 255, 0, 0.4) !important;
            border-color: rgb(128, 255, 0);
        }

        .highlight-pink {
            background-color: rgba(255, 0, 150, 0.4) !important;
            border-color: rgb(255, 0, 150);
        }

        .passage-content .highlight-yellow,
        .passage-content .highlight-green,
        .passage-content .highlight-pink {
            cursor: pointer;
        }

        /* --- IDE Editor Styles --- */
        .ide-container {
            position: relative;
            background-color: #0f172a;
            /* slate-900 */
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid #334155;
            font-family: 'Fira Code', monospace;
        }

        .ide-header {
            background-color: #1e293b;
            /* slate-800 */
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #334155;
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .ide-dots {
            display: flex;
            gap: 6px;
            margin-right: 1rem;
        }

        .ide-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .dot-red {
            background-color: #ef4444;
        }

        .dot-yellow {
            background-color: #f59e0b;
        }

        .dot-green {
            background-color: #22c55e;
        }

        .ide-editor-wrapper {
            position: relative;
            min-height: 200px;
            height: 100%;
        }

        /* The transparent textarea for input */
        .ide-textarea {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 1rem;
            color: transparent;
            background: transparent;
            border: none;
            outline: none;
            resize: none;
            z-index: 2;
            caret-color: #fff;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            overflow: auto;
        }

        /* The code display layer */
        .ide-code {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 1rem;
            margin: 0;
            color: #e2e8f0;
            background-color: #0f172a;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            overflow: hidden;
            /* Scroll syncs with textarea */
            pointer-events: none;
            z-index: 1;
        }

        /* Syntax highlighting tweaks for Prism */
        code[class*="language-"],
        pre[class*="language-"] {
            text-shadow: none !important;
            font-family: 'Fira Code', monospace !important;
        }
    </style>
</head>

<body class="bg-indigo-50 min-h-screen text-slate-800">

    <div id="app" class="relative min-h-screen flex flex-col">

        <!-- 主內容區 -->
        <div class="flex-grow flex flex-col">
            <!-- Header -->
            <header class="bg-white/80 backdrop-blur-md sticky top-0 z-30 border-b border-slate-200">
                <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                    <div class="flex items-center gap-2 cursor-pointer" @click="goToView('landing')">
                        <div
                            class="w-8 h-8 bg-gradient-to-br from-pink-500 to-violet-600 rounded-lg flex items-center justify-center text-white font-bold">
                            Q</div>
                        <h1
                            class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-600 to-violet-600">
                            C++物件導向程式設計</h1>
                    </div>
                    <div class="flex items-center gap-3">
                        <button v-if="!isStudentView" @click="toggleSettings"
                            class="p-2 text-slate-500 hover:text-violet-600 transition" title="系統設定">
                            <i class="fa-solid fa-gear text-lg"></i>
                        </button>
                        <!-- 連線狀態指示燈 -->
                        <div v-if="isConfigured && user"
                            class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full flex items-center">
                            <i class="fa-solid fa-circle text-[8px] mr-1"></i>已連線
                        </div>
                        <button v-else @click="showSettingsModal = true"
                            class="text-xs px-2 py-1 bg-red-100 text-red-700 rounded-full flex items-center animate-pulse hover:bg-red-200 transition">
                            <i class="fa-solid fa-triangle-exclamation mr-1"></i>未連線 (點此設定)
                        </button>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="flex-grow w-full max-w-6xl mx-auto p-4 sm:p-6">

                <!-- VIEW: Landing Page -->
                <transition name="fade" mode="out-in">
                    <div v-if="currentView === 'landing'"
                        class="h-full flex flex-col items-center justify-center py-10">
                        <div class="text-center mb-12">
                            <h2 class="text-4xl md:text-5xl font-bold text-slate-800 mb-4">歡迎來到 C++物件導向程式設計</h2>
                            <p class="text-lg text-slate-500">老師輕鬆出題，學生快樂學習</p>
                        </div>

                        <div class="grid grid-cols-1 gap-8 w-full"
                            :class="isStudentView ? 'md:max-w-md' : 'md:grid-cols-2 md:max-w-4xl'">
                            <!-- 學生入口 -->
                            <div @click="checkConfigAndGo('student-login')"
                                class="group bg-white p-8 rounded-3xl shadow-xl hover:shadow-2xl transition cursor-pointer border border-slate-100 relative overflow-hidden">
                                <div
                                    class="absolute top-0 right-0 w-32 h-32 bg-sky-100 rounded-full -mr-16 -mt-16 group-hover:scale-110 transition duration-500">
                                </div>
                                <div class="relative z-10">
                                    <div
                                        class="w-16 h-16 bg-sky-100 text-sky-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-sky-600 group-hover:text-white transition">
                                        <i class="fa-solid fa-graduation-cap"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-slate-800 mb-2">我是學生</h3>
                                    <p class="text-slate-500">輸入姓名，立即加入老師的測驗</p>
                                </div>
                            </div>

                            <!-- 教師入口 -->
                            <div v-if="!isStudentView" @click="checkConfigAndGo('teacher-login')"
                                class="group bg-white p-8 rounded-3xl shadow-xl hover:shadow-2xl transition cursor-pointer border border-slate-100 relative overflow-hidden">
                                <div
                                    class="absolute top-0 right-0 w-32 h-32 bg-pink-100 rounded-full -mr-16 -mt-16 group-hover:scale-110 transition duration-500">
                                </div>
                                <div class="relative z-10">
                                    <div
                                        class="w-16 h-16 bg-pink-100 text-pink-600 rounded-2xl flex items-center justify-center text-3xl mb-6 group-hover:bg-pink-600 group-hover:text-white transition">
                                        <i class="fa-solid fa-chalkboard-user"></i>
                                    </div>
                                    <h3 class="text-2xl font-bold text-slate-800 mb-2">我是老師</h3>
                                    <p class="text-slate-500">AI 輔助出題，啟用測驗與分析</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VIEW: Teacher Login -->
                    <div v-else-if="currentView === 'teacher-login'" class="flex items-center justify-center py-20">
                        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full text-center">
                            <div class="mb-6 inline-block p-4 bg-pink-100 text-pink-500 rounded-full text-3xl">
                                <i class="fa-solid fa-lock"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-4">教師專用入口</h3>
                            <input type="password" v-model="teacherPassword" placeholder="請輸入密碼"
                                class="w-full p-3 border border-slate-200 rounded-xl mb-4 focus:ring-2 focus:ring-pink-500 outline-none text-center">
                            <button @click="verifyTeacher"
                                class="w-full py-3 bg-pink-500 text-white rounded-xl font-bold hover:bg-pink-600 transition">進入管理後台</button>
                            <button @click="goToView('landing')"
                                class="mt-4 text-slate-400 text-sm hover:text-slate-600">返回首頁</button>
                        </div>
                    </div>

                    <!-- VIEW: Teacher Dashboard -->
                    <div v-else-if="currentView === 'teacher-dashboard'" class="space-y-6">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h2 class="text-2xl font-bold text-slate-800">教師管理儀表板</h2>
                                <p class="text-slate-500">管理您的題庫與測驗狀態</p>
                            </div>
                            <div class="flex gap-2">
                                <button @click="openCreateModal"
                                    class="px-5 py-2.5 bg-violet-600 text-white rounded-xl font-medium shadow-lg shadow-violet-200 hover:bg-violet-700 transition">
                                    <i class="fa-solid fa-plus mr-2"></i>新增題庫
                                </button>
                            </div>
                        </div>

                        <!-- Active Quiz Banner (New Feature) -->
                        <div v-if="activeQuizId"
                            class="bg-gradient-to-r from-emerald-500 to-green-600 text-white p-5 rounded-2xl shadow-lg shadow-green-200 flex flex-col sm:flex-row justify-between items-start sm:items-center animate-fade-in-up border border-green-400 relative overflow-hidden">
                            <div
                                class="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white opacity-10 rounded-full blur-xl">
                            </div>
                            <div class="relative z-10 mb-3 sm:mb-0">
                                <p class="text-xs font-bold opacity-90 mb-1 flex items-center uppercase tracking-wider">
                                    <span class="relative flex h-2 w-2 mr-2">
                                        <span
                                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-white opacity-75"></span>
                                        <span class="relative inline-flex rounded-full h-2 w-2 bg-white"></span>
                                    </span>
                                    目前正在進行中
                                </p>
                                <h3 class="text-xl font-bold flex items-center gap-2">
                                    <i class="fa-solid fa-chalkboard-user"></i>
                                    {{ getActiveQuizTitle }}
                                </h3>
                            </div>
                            <button @click="deactivateQuiz"
                                class="relative z-10 bg-white text-green-700 px-5 py-2.5 rounded-xl text-sm font-bold hover:bg-green-50 transition shadow-md flex items-center whitespace-nowrap">
                                <i class="fa-solid fa-stop mr-2"></i> 結束測驗
                            </button>
                        </div>

                        <!-- 分類篩選器 -->
                        <div class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                            <button @click="selectedCategory = 'All'"
                                class="px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition border"
                                :class="selectedCategory === 'All' ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'">
                                全部
                            </button>
                            <button v-for="cat in uniqueCategories" :key="cat" @click="selectedCategory = cat"
                                class="px-4 py-1.5 rounded-full text-sm font-bold whitespace-nowrap transition border"
                                :class="selectedCategory === cat ? 'bg-violet-600 text-white border-violet-600' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'">
                                {{ cat }}
                            </button>
                        </div>

                        <!-- 題庫列表 -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <div v-for="quiz in filteredQuizzes" :key="quiz.id"
                                class="bg-white rounded-2xl p-6 shadow-sm border transition relative overflow-hidden group"
                                :class="{'border-green-400 shadow-lg ring-2 ring-green-100': activeQuizId === quiz.id, 'border-slate-100 hover:shadow-md': activeQuizId !== quiz.id}">

                                <!-- 進行中標籤 -->
                                <div v-if="activeQuizId === quiz.id"
                                    class="absolute top-0 right-0 bg-green-500 text-white text-xs font-bold px-3 py-1 rounded-bl-xl shadow-sm flex items-center z-10">
                                    <span class="w-2 h-2 bg-white rounded-full mr-2 animate-pulse"></span>
                                    進行中
                                </div>

                                <div class="flex justify-between items-start mb-2">
                                    <div class="flex gap-2">
                                        <span
                                            class="bg-violet-50 text-violet-600 px-2 py-1 rounded-md text-xs font-bold border border-violet-100">
                                            {{ quiz.category || '未分類' }}
                                        </span>
                                        <span
                                            class="bg-slate-100 text-slate-600 px-2 py-1 rounded-md text-xs font-bold">
                                            {{ quiz.questions.length }} 題
                                        </span>
                                    </div>
                                    <div class="flex gap-1">
                                        <button @click="editQuiz(quiz)"
                                            class="text-slate-300 hover:text-blue-500 transition p-1" title="編輯題庫內容"><i
                                                class="fa-solid fa-pen-to-square"></i></button>
                                        <button @click="deleteQuiz(quiz.id)"
                                            class="text-slate-300 hover:text-red-500 transition p-1" title="刪除題庫"><i
                                                class="fa-solid fa-trash"></i></button>
                                    </div>
                                </div>

                                <h3 class="text-xl font-bold text-slate-800 mb-1 truncate" :title="quiz.title">{{
                                    quiz.title }}</h3>
                                <p class="text-xs text-slate-400 mb-6">建立於: {{ formatDate(quiz.createdAt) }}</p>

                                <div class="flex gap-2">
                                    <button v-if="activeQuizId === quiz.id" disabled
                                        class="flex-1 py-2 bg-green-50 text-green-600 rounded-lg text-sm font-bold cursor-default border border-green-200">
                                        <i class="fa-solid fa-rss mr-1"></i> 已啟用
                                    </button>
                                    <button v-else @click="activateQuiz(quiz.id)"
                                        class="flex-1 py-2 bg-slate-800 text-white rounded-lg text-sm font-bold hover:bg-slate-900 transition shadow-md">
                                        <i class="fa-solid fa-play mr-1"></i> 啟用
                                    </button>
                                    <button @click="duplicateQuiz(quiz)"
                                        class="px-3 py-2 bg-blue-50 text-blue-600 rounded-lg text-sm font-medium hover:bg-blue-100"
                                        title="複製題庫">
                                        <i class="fa-regular fa-clone"></i>
                                    </button>
                                    <button @click="viewAnalytics(quiz)"
                                        class="px-3 py-2 bg-slate-100 text-slate-600 rounded-lg text-sm font-medium hover:bg-slate-200"
                                        title="查看分析">
                                        <i class="fa-solid fa-chart-pie"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Empty State -->
                            <div v-if="filteredQuizzes.length === 0"
                                class="col-span-full py-12 text-center text-slate-400 border-2 border-dashed border-slate-200 rounded-2xl">
                                <i class="fa-solid fa-folder-open text-4xl mb-3 opacity-30"></i>
                                <p>此分類下沒有題庫</p>
                            </div>
                        </div>

                        <!-- 創建/編輯題庫 Modal -->
                        <div v-if="showCreateQuiz"
                            class="fixed inset-0 z-40 bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm overflow-y-auto">
                            <div
                                class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto flex flex-col">
                                <div
                                    class="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
                                    <h3 class="text-xl font-bold">{{ editingQuizId ? '編輯題庫' : '建立新題庫' }}</h3>
                                    <button @click="showCreateQuiz = false"
                                        class="text-slate-400 hover:text-slate-600"><i
                                            class="fa-solid fa-xmark text-xl"></i></button>
                                </div>

                                <div class="p-6 space-y-6">
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div class="md:col-span-2">
                                            <label class="block text-sm font-medium text-slate-700 mb-1">測驗標題</label>
                                            <input v-model="newQuiz.title" type="text"
                                                class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-violet-500"
                                                placeholder="例如：國文第三課隨堂考">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700 mb-1">分類</label>
                                            <input v-model="newQuiz.category" list="category-list" type="text"
                                                class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-violet-500"
                                                placeholder="例如：國文">
                                            <datalist id="category-list">
                                                <option v-for="cat in uniqueCategories" :key="cat" :value="cat">
                                                </option>
                                            </datalist>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700 mb-1">題型</label>
                                            <select v-model="newQuiz.questionType"
                                                class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-violet-500">
                                                <option value="multiple-choice">一般選擇題</option>
                                                <option value="reading-comprehension">閱讀測驗</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- 閱讀測驗設定 (修改為 IDE 風格) -->
                                    <div v-if="newQuiz.questionType === 'reading-comprehension'"
                                        class="bg-blue-50 p-6 rounded-xl space-y-4 animate-fade-in">
                                        <div class="flex items-center mb-4">
                                            <i class="fa-solid fa-book-open text-blue-600 mr-3"></i>
                                            <h4 class="font-bold text-blue-800">閱讀測驗設定</h4>
                                        </div>

                                        <!-- 文本來源與語言選擇 -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-medium text-slate-700 mb-2">文本來源</label>
                                                <div class="space-y-2">
                                                    <label class="flex items-center">
                                                        <input type="radio" v-model="readingConfig.textSource"
                                                            value="paste" class="mr-2">
                                                        <span>直接貼上文本</span>
                                                    </label>
                                                    <label class="flex items-center">
                                                        <input type="radio" v-model="readingConfig.textSource"
                                                            value="upload" class="mr-2">
                                                        <span>上傳文本檔案</span>
                                                    </label>
                                                    <label class="flex items-center">
                                                        <input type="radio" v-model="readingConfig.textSource"
                                                            value="topic" class="mr-2">
                                                        <span>指定主題由AI生成</span>
                                                    </label>
                                                </div>
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-medium text-slate-700 mb-2">AI輸出語言</label>
                                                <div class="space-y-2">
                                                    <label class="flex items-center">
                                                        <input type="radio" v-model="readingConfig.language" value="繁中"
                                                            class="mr-2">
                                                        <span>繁體中文</span>
                                                    </label>
                                                    <label class="flex items-center">
                                                        <input type="radio" v-model="readingConfig.language" value="英文"
                                                            class="mr-2">
                                                        <span>English (英文)</span>
                                                    </label>
                                                    <label class="flex items-center">
                                                        <input type="radio" v-model="readingConfig.language" value="日文"
                                                            class="mr-2">
                                                        <span>日本語 (日文)</span>
                                                    </label>
                                                    <label class="flex items-center">
                                                        <input type="radio" v-model="readingConfig.language" value="韓文"
                                                            class="mr-2">
                                                        <span>한국어 (韓文)</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- 根據來源顯示對應操作 -->
                                        <div v-if="readingConfig.textSource === 'topic'" class="mb-3">
                                            <label class="block text-sm font-medium text-slate-700 mb-2">主題描述</label>
                                            <div class="flex gap-2">
                                                <input v-model="readingConfig.topic" type="text"
                                                    class="flex-1 p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500"
                                                    placeholder="例如：環保議題、科技發展、歷史事件...">
                                                <button @click="generatePassageFromTopic"
                                                    :disabled="!readingConfig.topic.trim() || isGenerating"
                                                    class="px-4 py-2 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed transition whitespace-nowrap">
                                                    <span v-if="isGenerating"><i
                                                            class="fa-solid fa-circle-notch fa-spin mr-2"></i>生成中...</span>
                                                    <span v-else><i class="fa-solid fa-sparkles mr-2"></i>由AI生成文本</span>
                                                </button>
                                            </div>
                                        </div>

                                        <div v-if="readingConfig.textSource === 'upload'" class="mb-3">
                                            <label class="block text-sm font-medium text-slate-700 mb-2">上傳文本檔案</label>
                                            <input type="file" @change="handleTextFileUpload" accept=".txt,.doc,.docx"
                                                class="w-full p-3 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500">
                                        </div>

                                        <!-- 統一的文本輸入框 (VS Code Style) -->
                                        <div class="mt-4">
                                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                                <i class="fa-solid fa-code text-violet-600 mr-1"></i>閱讀文本 (IDE 編輯模式)
                                            </label>
                                            <div class="ide-container shadow-xl">
                                                <div class="ide-header">
                                                    <div class="ide-dots">
                                                        <div class="ide-dot dot-red"></div>
                                                        <div class="ide-dot dot-yellow"></div>
                                                        <div class="ide-dot dot-green"></div>
                                                    </div>
                                                    <span>reading_passage.txt</span>
                                                </div>
                                                <div class="ide-editor-wrapper h-80">
                                                    <!-- 高亮顯示層 -->
                                                    <pre
                                                        class="ide-code ide-scroll"><code class="language-markdown">{{ newQuiz.readingPassage }}</code></pre>
                                                    <!-- 透明輸入層 -->
                                                    <textarea v-model="newQuiz.readingPassage" @input="highlightCode"
                                                        @scroll="syncScroll" class="ide-textarea ide-scroll"
                                                        placeholder="// 在此輸入閱讀測驗文本內容..." spellcheck="false"></textarea>
                                                </div>
                                            </div>
                                            <p class="text-xs text-slate-500 mt-1 text-right">支援 Markdown 語法高亮</p>
                                        </div>

                                        <!-- PIRLS閱讀理解四層次設定 -->
                                        <div class="border-t border-blue-200 pt-4">
                                            <h5 class="font-bold text-slate-700 mb-3">PIRLS閱讀理解層次設定</h5>
                                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                                <div>
                                                    <label
                                                        class="block text-xs font-medium text-slate-600 mb-1">提取訊息</label>
                                                    <input v-model.number="readingConfig.pirlsLevels.retrieval"
                                                        type="number" min="0" max="10"
                                                        class="w-full p-2 border border-slate-200 rounded-lg text-center">
                                                </div>
                                                <div>
                                                    <label
                                                        class="block text-xs font-medium text-slate-600 mb-1">推論理解</label>
                                                    <input v-model.number="readingConfig.pirlsLevels.inference"
                                                        type="number" min="0" max="10"
                                                        class="w-full p-2 border border-slate-200 rounded-lg text-center">
                                                </div>
                                                <div>
                                                    <label
                                                        class="block text-xs font-medium text-slate-600 mb-1">詮釋整合</label>
                                                    <input v-model.number="readingConfig.pirlsLevels.interpretation"
                                                        type="number" min="0" max="10"
                                                        class="w-full p-2 border border-slate-200 rounded-lg text-center">
                                                </div>
                                                <div>
                                                    <label
                                                        class="block text-xs font-medium text-slate-600 mb-1">評估鑑賞</label>
                                                    <input v-model.number="readingConfig.pirlsLevels.evaluation"
                                                        type="number" min="0" max="10"
                                                        class="w-full p-2 border border-slate-200 rounded-lg text-center">
                                                </div>
                                            </div>
                                            <p class="text-xs text-slate-500 mt-2">總題數：{{
                                                (readingConfig.pirlsLevels.retrieval || 0) +
                                                (readingConfig.pirlsLevels.inference || 0) +
                                                (readingConfig.pirlsLevels.interpretation || 0) +
                                                (readingConfig.pirlsLevels.evaluation || 0) }} 題</p>
                                        </div>

                                        <!-- 生成按鈕 -->
                                        <div class="flex justify-end">
                                            <button @click="generateReadingComprehension"
                                                :disabled="!canGenerateReading || isGenerating"
                                                class="px-6 py-2 bg-blue-600 text-white rounded-xl font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition">
                                                <span v-if="isGenerating"><i
                                                        class="fa-solid fa-circle-notch fa-spin mr-2"></i>AI
                                                    生成題目中...</span>
                                                <span v-else><i
                                                        class="fa-solid fa-wand-magic-sparkles mr-2"></i>生成閱讀測驗</span>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- Tabs (只在一般選擇題時顯示) -->
                                    <div v-if="newQuiz.questionType === 'multiple-choice'"
                                        class="flex border-b border-slate-200">
                                        <button @click="createMode = 'ai'"
                                            :class="{'border-violet-600 text-violet-600': createMode === 'ai', 'border-transparent text-slate-500': createMode !== 'ai'}"
                                            class="px-6 py-3 border-b-2 font-medium transition">AI 自動出題</button>
                                        <button @click="createMode = 'manual'"
                                            :class="{'border-violet-600 text-violet-600': createMode === 'manual', 'border-transparent text-slate-500': createMode !== 'manual'}"
                                            class="px-6 py-3 border-b-2 font-medium transition">手動/貼上題庫</button>
                                    </div>

                                    <!-- AI Mode (修改為 IDE 風格) -->
                                    <div v-if="newQuiz.questionType === 'multiple-choice' && createMode === 'ai'"
                                        class="space-y-4 animate-fade-in">
                                        <div class="bg-violet-50 p-4 rounded-xl text-sm text-violet-700">
                                            <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>AI 將自動從您提供的內容抓取重點並生成題目。
                                        </div>

                                        <div>
                                            <label class="block text-sm font-bold text-slate-700 mb-2">
                                                <i class="fa-solid fa-file-code text-violet-600 mr-1"></i>來源內容 (IDE
                                                編輯模式)
                                            </label>

                                            <div class="ide-container shadow-xl mb-4">
                                                <div class="ide-header">
                                                    <div class="ide-dots">
                                                        <div class="ide-dot dot-red"></div>
                                                        <div class="ide-dot dot-yellow"></div>
                                                        <div class="ide-dot dot-green"></div>
                                                    </div>
                                                    <span>source_material.txt</span>
                                                </div>
                                                <div class="ide-editor-wrapper h-48">
                                                    <!-- 高亮顯示層 -->
                                                    <pre
                                                        class="ide-code ide-scroll"><code class="language-markdown">{{ aiSourceText }}</code></pre>
                                                    <!-- 透明輸入層 -->
                                                    <textarea v-model="aiSourceText" @input="highlightCode"
                                                        @scroll="syncScroll" class="ide-textarea ide-scroll"
                                                        placeholder="// 貼上課文、文章內容，或使用下方按鈕上傳..."
                                                        spellcheck="false"></textarea>
                                                </div>
                                            </div>

                                            <div class="flex flex-wrap items-center gap-2">
                                                <!-- 上傳圖片 -->
                                                <label
                                                    class="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg cursor-pointer text-slate-600 text-sm font-medium transition border border-slate-200">
                                                    <i class="fa-solid fa-image mr-1"></i> 上傳圖片
                                                    <input type="file" accept="image/*" class="hidden"
                                                        @change="handleImageUpload">
                                                </label>

                                                <!-- 上傳 PDF (新增) -->
                                                <label
                                                    class="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg cursor-pointer text-slate-600 text-sm font-medium transition border border-slate-200"
                                                    :class="{'opacity-50 cursor-not-allowed': isPdfLoading}">
                                                    <i class="fa-solid fa-file-pdf mr-1 text-red-500"></i> 上傳 PDF 文本
                                                    <input type="file" accept="application/pdf" class="hidden"
                                                        @change="handlePdfUpload" :disabled="isPdfLoading">
                                                </label>

                                                <!-- 狀態顯示 -->
                                                <span v-if="aiImageBase64"
                                                    class="text-xs text-green-600 flex items-center bg-green-50 px-2 py-1 rounded"><i
                                                        class="fa-solid fa-check mr-1"></i>圖片已載入</span>
                                                <span v-if="isPdfLoading"
                                                    class="text-xs text-violet-600 flex items-center bg-violet-50 px-2 py-1 rounded"><i
                                                        class="fa-solid fa-circle-notch fa-spin mr-1"></i>PDF
                                                    解析中...</span>
                                            </div>
                                            <img v-if="aiImageBase64" :src="aiImageBase64"
                                                class="mt-2 h-32 object-contain rounded-lg border border-slate-200">
                                        </div>

                                        <div class="grid grid-cols-3 gap-4">
                                            <div>
                                                <label class="text-xs font-bold text-slate-500">簡單題數</label>
                                                <input v-model.number="aiConfig.easy" type="number" min="0"
                                                    class="w-full mt-1 p-2 border rounded-lg">
                                            </div>
                                            <div>
                                                <label class="text-xs font-bold text-slate-500">一般題數</label>
                                                <input v-model.number="aiConfig.medium" type="number" min="0"
                                                    class="w-full mt-1 p-2 border rounded-lg">
                                            </div>
                                            <div>
                                                <label class="text-xs font-bold text-slate-500">困難題數</label>
                                                <input v-model.number="aiConfig.hard" type="number" min="0"
                                                    class="w-full mt-1 p-2 border rounded-lg">
                                            </div>
                                        </div>

                                        <button @click="generateQuestions" :disabled="isGenerating || isPdfLoading"
                                            class="w-full py-3 bg-gradient-to-r from-violet-600 to-indigo-600 text-white rounded-xl font-bold hover:shadow-lg disabled:opacity-50 transition">
                                            <span v-if="isGenerating"><i
                                                    class="fa-solid fa-circle-notch fa-spin mr-2"></i>AI 正在思考中...</span>
                                            <span v-else><i class="fa-solid fa-robot mr-2"></i>開始 AI 出題 (覆蓋現有題目)</span>
                                        </button>
                                    </div>

                                    <!-- Manual Mode -->
                                    <div v-if="newQuiz.questionType === 'multiple-choice' && createMode === 'manual'"
                                        class="space-y-4 animate-fade-in">
                                        <div class="bg-yellow-50 p-4 rounded-xl text-sm text-yellow-800">
                                            <p class="font-bold mb-1">格式說明 (每行一題，用 Tab 或 逗號 分隔)：</p>
                                            <p>題目, 答案(1-4或a-d), 選項A, 選項B, 選項C, 選項D, 解析(選填)</p>
                                        </div>
                                        <textarea v-model="manualInput"
                                            class="w-full h-64 p-3 border border-slate-200 rounded-xl font-mono text-sm leading-relaxed"
                                            placeholder="範例：
台灣最高的山是哪一座？, 1, 玉山, 雪山, 阿里山, 陽明山, 玉山是東北亞最高峰
1+1等於多少？, b, 1, 2, 3, 4, 數學基本運算"></textarea>
                                        <button @click="parseManualInput"
                                            class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 transition">
                                            解析並加入題目 (Append)
                                        </button>
                                    </div>

                                    <!-- Preview & Edit Area -->
                                    <div class="mt-6 border-t border-slate-100 pt-6">
                                        <div class="flex justify-between items-center mb-4">
                                            <h4 class="font-bold text-slate-700">題目列表 ({{ newQuiz.questions.length }} 題)
                                            </h4>
                                            <button @click="addQuestion"
                                                class="text-sm bg-violet-100 text-violet-600 px-3 py-1.5 rounded-lg hover:bg-violet-200 font-bold transition">
                                                <i class="fa-solid fa-plus mr-1"></i> 新增題目
                                            </button>
                                        </div>

                                        <div class="space-y-4 max-h-80 overflow-y-auto pr-2 pb-2">
                                            <div v-for="(q, idx) in newQuiz.questions" :key="idx"
                                                class="p-4 bg-slate-50 rounded-xl border border-slate-100 group hover:border-violet-200 transition">
                                                <div class="flex justify-between items-start">
                                                    <span class="font-bold text-slate-800 flex-1">{{ idx + 1 }}. {{
                                                        q.title }}</span>
                                                    <div class="flex gap-2 ml-4">
                                                        <button @click="editQuestion(idx)"
                                                            class="text-slate-400 hover:text-blue-500 p-1" title="修改"><i
                                                                class="fa-solid fa-pen"></i></button>
                                                        <button @click="deleteQuestion(idx)"
                                                            class="text-slate-400 hover:text-red-500 p-1" title="刪除"><i
                                                                class="fa-solid fa-trash"></i></button>
                                                    </div>
                                                </div>
                                                <div class="flex items-center gap-2 mt-2">
                                                    <span
                                                        class="text-xs px-2 py-1 bg-white border rounded text-slate-500 inline-block">{{
                                                        q.difficulty || '一般' }}</span>
                                                    <span v-if="q.pirlsLevel"
                                                        class="text-xs px-2 py-1 bg-blue-100 text-blue-700 border border-blue-200 rounded inline-block font-medium">
                                                        <i class="fa-solid fa-layer-group mr-1"></i>{{
                                                        getPirlsLevelName(q.pirlsLevel) }}
                                                    </span>
                                                </div>

                                                <div class="grid grid-cols-2 gap-2 mt-2 text-sm text-slate-600 pl-4">
                                                    <div v-for="(opt, i) in q.options" :key="i"
                                                        :class="{'text-green-600 font-bold': (i + 1) == q.answer}">
                                                        {{ String.fromCharCode(65+i) }}. {{ opt }}
                                                    </div>
                                                </div>
                                                <p v-if="q.explanation"
                                                    class="mt-2 text-xs text-slate-400 border-t border-slate-200 pt-1">
                                                    💡 {{ q.explanation }}</p>
                                            </div>
                                            <div v-if="newQuiz.questions.length === 0"
                                                class="text-center text-slate-400 py-8">
                                                尚未加入任何題目
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div
                                    class="p-6 border-t border-slate-100 sticky bottom-0 bg-white flex justify-end gap-3">
                                    <button @click="showCreateQuiz = false"
                                        class="px-6 py-2 text-slate-500 font-medium hover:bg-slate-50 rounded-xl">取消</button>
                                    <button @click="saveQuiz" :disabled="newQuiz.questions.length === 0"
                                        class="px-6 py-2 bg-violet-600 text-white font-bold rounded-xl shadow-lg shadow-violet-200 hover:bg-violet-700 disabled:opacity-50 disabled:cursor-not-allowed">
                                        {{ editingQuizId ? '更新題庫' : '儲存新題庫' }}
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Single Question Editor Modal -->
                        <div v-if="showQuestionEditor"
                            class="fixed inset-0 z-[60] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div class="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl animate-fade-in-up">
                                <h3 class="text-lg font-bold mb-4">{{ currentEditingQuestionIndex === -1 ? '新增題目' :
                                    '編輯題目' }}</h3>

                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">題目敘述</label>
                                        <textarea v-model="currentEditingQuestion.title"
                                            class="w-full p-2 border border-slate-200 rounded-lg focus:ring-2 focus:ring-violet-500 h-20"></textarea>
                                    </div>

                                    <div class="grid grid-cols-1 gap-2">
                                        <div v-for="(opt, i) in currentEditingQuestion.options" :key="i"
                                            class="flex items-center gap-2">
                                            <span class="w-6 text-center text-sm font-bold text-slate-500">{{
                                                String.fromCharCode(65+i) }}</span>
                                            <input v-model="currentEditingQuestion.options[i]" type="text"
                                                class="flex-1 p-2 border border-slate-200 rounded-lg text-sm"
                                                placeholder="選項內容">
                                            <input type="radio" :name="'correct-ans'" :value="i+1"
                                                v-model="currentEditingQuestion.answer"
                                                class="accent-green-500 w-4 h-4 cursor-pointer" title="設為正確答案">
                                        </div>
                                    </div>

                                    <div class="flex gap-4">
                                        <div class="flex-1">
                                            <label class="block text-sm font-medium text-slate-700 mb-1">難易度</label>
                                            <select v-model="currentEditingQuestion.difficulty"
                                                class="w-full p-2 border border-slate-200 rounded-lg">
                                                <option value="簡單">簡單</option>
                                                <option value="一般">一般</option>
                                                <option value="困難">困難</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-medium text-slate-700 mb-1">解析 (選填)</label>
                                        <textarea v-model="currentEditingQuestion.explanation"
                                            class="w-full p-2 border border-slate-200 rounded-lg h-16 text-sm"></textarea>
                                    </div>
                                </div>

                                <div class="mt-6 flex justify-end gap-3">
                                    <button @click="showQuestionEditor = false"
                                        class="px-4 py-2 text-slate-500 hover:bg-slate-50 rounded-lg font-medium">取消</button>
                                    <button @click="saveQuestion"
                                        class="px-4 py-2 bg-slate-800 text-white rounded-lg font-bold hover:bg-slate-900">確認</button>
                                </div>
                            </div>
                        </div>

                        <!-- Analytics Modal -->
                        <div v-if="showAnalytics"
                            class="fixed inset-0 z-40 bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
                            <div class="bg-white rounded-2xl w-full max-w-5xl h-[90vh] flex flex-col p-6">
                                <!-- Header -->
                                <div
                                    class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                                    <div>
                                        <h3 class="text-2xl font-bold">{{ selectedAnalyticsQuiz.title }} - 分析報告</h3>
                                        <p class="text-slate-500">共 {{ analyticsData.length }} 位學生作答</p>
                                    </div>
                                    <div class="flex gap-2">
                                        <button v-if="selectedStudentResult" @click="closeStudentDetails"
                                            class="px-4 py-2 bg-slate-100 text-slate-600 rounded-lg hover:bg-slate-200 transition text-sm font-bold">
                                            <i class="fa-solid fa-arrow-left mr-2"></i>返回
                                        </button>
                                        <button v-if="!selectedStudentResult" @click="exportCSV"
                                            class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition text-sm font-bold shadow-md shadow-green-200">
                                            <i class="fa-solid fa-file-csv mr-2"></i>下載報表
                                        </button>
                                        <button @click="showAnalytics = false"
                                            class="text-slate-400 hover:text-slate-600 px-2"><i
                                                class="fa-solid fa-xmark text-xl"></i></button>
                                    </div>
                                </div>

                                <!-- Tabs -->
                                <div v-if="!selectedStudentResult" class="flex border-b border-slate-200 mb-6">
                                    <button @click="analyticsTab = 'score'"
                                        class="px-6 py-3 border-b-2 font-medium transition text-sm sm:text-base"
                                        :class="analyticsTab === 'score' ? 'border-violet-600 text-violet-600' : 'border-transparent text-slate-500 hover:text-slate-700'">
                                        <i class="fa-solid fa-chart-column mr-2"></i>成績分佈 & 列表
                                    </button>
                                    <button @click="analyticsTab = 'question'"
                                        class="px-6 py-3 border-b-2 font-medium transition text-sm sm:text-base"
                                        :class="analyticsTab === 'question' ? 'border-violet-600 text-violet-600' : 'border-transparent text-slate-500 hover:text-slate-700'">
                                        <i class="fa-solid fa-list-check mr-2"></i>試題分析
                                    </button>
                                </div>

                                <!-- Tab Content: Score Overview -->
                                <div v-if="!selectedStudentResult && analyticsTab === 'score'"
                                    class="flex-grow overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in">
                                    <!-- Chart Area -->
                                    <div
                                        class="bg-slate-50 p-4 rounded-xl flex flex-col items-center justify-center h-min">
                                        <canvas id="scoreChart"></canvas>
                                    </div>
                                    <!-- Student List -->
                                    <div class="bg-white border border-slate-100 rounded-xl overflow-hidden h-max">
                                        <table class="w-full text-sm text-left">
                                            <thead class="bg-slate-100 text-slate-600 font-bold">
                                                <tr>
                                                    <th class="p-3">學生姓名</th>
                                                    <th class="p-3">得分</th>
                                                    <th class="p-3 text-center">操作</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr v-for="res in analyticsData" :key="res.id"
                                                    class="border-b border-slate-50 hover:bg-slate-50 transition cursor-pointer"
                                                    @click="viewStudentDetails(res)">
                                                    <td class="p-3 font-medium">{{ res.studentName }}</td>
                                                    <td class="p-3 font-bold" :class="getScoreColor(res.score)">{{
                                                        res.score }}</td>
                                                    <td class="p-3 text-center">
                                                        <button
                                                            class="text-xs bg-violet-100 text-violet-600 px-2 py-1 rounded hover:bg-violet-200">
                                                            詳情
                                                        </button>
                                                    </td>
                                                </tr>
                                                <tr v-if="analyticsData.length === 0">
                                                    <td colspan="3" class="p-4 text-center text-slate-400">尚無學生作答記錄</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Tab Content: Question Analysis -->
                                <div v-if="!selectedStudentResult && analyticsTab === 'question'"
                                    class="flex-grow overflow-y-auto space-y-4 animate-fade-in">
                                    <div v-for="stat in questionStats" :key="stat.index"
                                        class="bg-white border border-slate-200 rounded-xl p-5 hover:shadow-sm transition">
                                        <div class="flex justify-between items-start mb-3">
                                            <h4 class="font-bold text-slate-800 text-lg flex-1 mr-4">
                                                <span
                                                    class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs mr-2">Q{{
                                                    stat.index + 1 }}</span>
                                                {{ stat.question.title }}
                                            </h4>
                                            <div class="text-right flex-shrink-0">
                                                <span class="text-xs text-slate-500 block mb-1">答對率</span>
                                                <span class="text-xl font-bold" :class="getScoreColor(stat.rate)">{{
                                                    stat.rate }}%</span>
                                            </div>
                                        </div>

                                        <!-- Progress Bar -->
                                        <div class="w-full bg-slate-100 rounded-full h-2 mb-4 overflow-hidden">
                                            <div class="h-2 rounded-full transition-all duration-1000"
                                                :class="stat.rate >= 60 ? 'bg-green-500' : 'bg-red-500'"
                                                :style="{ width: stat.rate + '%' }"></div>
                                        </div>

                                        <!-- Details (Expandable) -->
                                        <details class="group">
                                            <summary
                                                class="flex items-center text-sm font-medium text-slate-500 cursor-pointer hover:text-violet-600 select-none">
                                                <i
                                                    class="fa-solid fa-chevron-right text-xs mr-2 transition-transform group-open:rotate-90"></i>
                                                查看答錯名單 ({{ stat.wrongStudents.length }}人)
                                            </summary>
                                            <div
                                                class="mt-3 pl-6 pt-2 border-t border-slate-100 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                                                <div v-for="ws in stat.wrongStudents" :key="ws.name"
                                                    class="text-sm bg-red-50 text-red-700 px-3 py-2 rounded-lg flex justify-between items-center">
                                                    <span>{{ ws.name }}</span>
                                                    <span
                                                        class="font-bold bg-white px-2 rounded text-xs border border-red-100"
                                                        v-if="ws.choice">選了 {{ String.fromCharCode(64 +
                                                        parseInt(ws.choice)) }}</span>
                                                    <span
                                                        class="font-bold bg-white px-2 rounded text-xs border border-red-100"
                                                        v-else>未作答</span>
                                                </div>
                                                <div v-if="stat.wrongStudents.length === 0"
                                                    class="text-sm text-green-600 py-2">
                                                    <i class="fa-solid fa-check-circle mr-1"></i> 全班答對，太棒了！
                                                </div>
                                            </div>
                                        </details>
                                    </div>
                                    <div v-if="questionStats.length === 0" class="text-center p-10 text-slate-400">
                                        暫無試題數據
                                    </div>
                                </div>

                                <!-- Detail View: Specific Student -->
                                <div v-if="selectedStudentResult" class="flex-grow overflow-y-auto animate-fade-in">
                                    <div
                                        class="bg-slate-50 p-4 rounded-xl mb-6 border border-slate-200 flex justify-between items-center">
                                        <div>
                                            <span class="text-sm text-slate-500">學生姓名</span>
                                            <h4 class="text-xl font-bold text-slate-800">{{
                                                selectedStudentResult.studentName }}</h4>
                                        </div>
                                        <div class="text-right">
                                            <span class="text-sm text-slate-500">測驗得分</span>
                                            <div class="text-3xl font-bold"
                                                :class="getScoreColor(selectedStudentResult.score)">{{
                                                selectedStudentResult.score }}</div>
                                        </div>
                                    </div>

                                    <!-- NEW: Reading passage with highlights -->
                                    <div v-if="selectedAnalyticsQuiz.questionType === 'reading-comprehension'"
                                        class="mb-6">
                                        <h4
                                            class="text-lg font-bold text-slate-700 mb-3 border-l-4 border-blue-500 pl-3">
                                            學生畫記內容</h4>
                                        <div class="bg-white p-4 rounded-xl border border-slate-200 passage-content prose prose-sm max-w-none text-slate-700 leading-relaxed overflow-y-auto max-h-60 whitespace-pre-wrap"
                                            v-html="teacherHighlightedPassage"></div>
                                        <p class="text-xs text-slate-400 mt-2">此處僅為顯示學生畫記結果，無法編輯。</p>
                                    </div>

                                    <h4 class="text-lg font-bold text-slate-700 mb-3 border-l-4 border-violet-500 pl-3">
                                        學生答題詳情</h4>
                                    <div class="space-y-4">
                                        <div v-for="(q, idx) in selectedAnalyticsQuiz.questions" :key="idx"
                                            class="p-4 rounded-xl border bg-white"
                                            :class="selectedStudentResult.answers[idx] == q.answer ? 'border-green-100' : 'border-red-100'">

                                            <div class="flex gap-3 mb-2">
                                                <div class="mt-1 flex-shrink-0">
                                                    <i v-if="selectedStudentResult.answers[idx] == q.answer"
                                                        class="fa-solid fa-circle-check text-green-500 text-lg"></i>
                                                    <i v-else class="fa-solid fa-circle-xmark text-red-500 text-lg"></i>
                                                </div>
                                                <div class="flex-grow">
                                                    <h5 class="font-bold text-slate-800 text-base">{{ idx + 1 }}. {{
                                                        q.title }}</h5>
                                                </div>
                                            </div>

                                            <div class="ml-8 space-y-1 text-sm">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-slate-500 font-medium">學生回答：</span>
                                                    <span
                                                        :class="selectedStudentResult.answers[idx] == q.answer ? 'text-green-600 font-bold' : 'text-red-600 font-bold line-through'">
                                                        {{ q.options[selectedStudentResult.answers[idx]-1] || '未作答' }}
                                                    </span>
                                                </div>
                                                <div v-if="selectedStudentResult.answers[idx] != q.answer"
                                                    class="flex items-center gap-2">
                                                    <span class="text-slate-500 font-medium">正確答案：</span>
                                                    <span class="text-green-600 font-bold">
                                                        {{ q.options[q.answer-1] }}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VIEW: Student Login -->
                    <div v-else-if="currentView === 'student-login'" class="flex items-center justify-center py-20">
                        <div
                            class="bg-white p-8 rounded-3xl shadow-xl max-w-sm w-full text-center border-t-4 border-sky-500">
                            <div class="mb-6 inline-block p-4 bg-sky-100 text-sky-500 rounded-full text-3xl">
                                <i class="fa-regular fa-id-card"></i>
                            </div>
                            <h3 class="text-xl font-bold mb-2">準備測驗</h3>
                            <p class="text-slate-400 text-sm mb-6">請輸入您的姓名，系統將自動載入老師啟用的測驗</p>

                            <input type="text" v-model="studentName" placeholder="王小明"
                                class="w-full p-3 border border-slate-200 rounded-xl mb-4 focus:ring-2 focus:ring-sky-500 outline-none text-center">

                            <div v-if="activeQuizId" class="mb-4 text-center">
                                <span
                                    class="text-xs font-bold text-green-600 bg-green-50 px-3 py-1 rounded-full animate-pulse">
                                    <i class="fa-solid fa-wifi mr-1"></i> 已偵測到進行中的測驗
                                </span>
                            </div>
                            <div v-else class="mb-4 text-center">
                                <span class="text-xs font-bold text-slate-400 bg-slate-100 px-3 py-1 rounded-full">
                                    <i class="fa-solid fa-spinner fa-spin mr-1"></i> 等待老師啟用測驗...
                                </span>
                            </div>

                            <button @click="startQuiz" :disabled="!studentName"
                                class="w-full py-3 bg-sky-500 text-white rounded-xl font-bold hover:bg-sky-600 transition disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-sky-200">
                                進入作答
                            </button>
                            <button @click="goToView('landing')"
                                class="mt-4 text-slate-400 text-sm hover:text-slate-600">返回首頁</button>
                        </div>
                    </div>

                    <!-- VIEW: Quiz Taking -->
                    <div v-else-if="currentView === 'quiz'"
                        :class="activeQuiz.questionType === 'reading-comprehension' ? 'max-w-7xl mx-auto w-full' : 'max-w-2xl mx-auto w-full'">
                        <!-- Header (Same for both types) -->
                        <div class="mb-6 flex justify-between items-center">
                            <span class="text-slate-500 font-medium">考生：{{ studentName }}</span>
                            <div class="text-sky-600 font-bold bg-sky-50 px-3 py-1 rounded-lg">
                                第 {{ currentQuestionIndex + 1 }} / {{ activeQuiz.questions.length }} 題
                            </div>
                        </div>

                        <!-- Progress Bar (Same for both types) -->
                        <div class="w-full bg-slate-200 rounded-full h-2 mb-8">
                            <div class="bg-sky-500 h-2 rounded-full transition-all duration-500"
                                :style="{ width: progressPercent + '%' }"></div>
                        </div>

                        <!-- Reading Comprehension Layout (修改為 IDE 風格) -->
                        <div v-if="activeQuiz.questionType === 'reading-comprehension'"
                            class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <!-- Left Column: Reading Passage with Highlighter -->
                            <div class="ide-container shadow-2xl flex flex-col h-[500px]">
                                <!-- IDE Header -->
                                <div class="ide-header justify-between">
                                    <div class="flex items-center">
                                        <div class="ide-dots">
                                            <div class="ide-dot dot-red"></div>
                                            <div class="ide-dot dot-yellow"></div>
                                            <div class="ide-dot dot-green"></div>
                                        </div>
                                        <span class="font-bold text-sky-400"><i
                                                class="fa-solid fa-code mr-2"></i>Reading_Exam.md</span>
                                    </div>
                                    <!-- Highlighter Toolbar inside IDE Header -->
                                    <div class="flex items-center gap-2">
                                        <button @mousedown.prevent="applyHighlight('yellow')"
                                            @touchstart.prevent="applyHighlight('yellow')"
                                            class="w-4 h-4 bg-yellow-400 rounded-full hover:scale-125 transition shadow-sm border border-slate-600"
                                            title="黃色標記"></button>
                                        <button @mousedown.prevent="applyHighlight('green')"
                                            @touchstart.prevent="applyHighlight('green')"
                                            class="w-4 h-4 bg-green-400 rounded-full hover:scale-125 transition shadow-sm border border-slate-600"
                                            title="綠色標記"></button>
                                        <button @mousedown.prevent="applyHighlight('pink')"
                                            @touchstart.prevent="applyHighlight('pink')"
                                            class="w-4 h-4 bg-pink-400 rounded-full hover:scale-125 transition shadow-sm border border-slate-600"
                                            title="粉色標記"></button>
                                    </div>
                                </div>

                                <!-- Text Content (IDE Editor Style) -->
                                <div class="relative flex-grow bg-slate-900 overflow-hidden">
                                    <div
                                        class="absolute left-0 top-0 bottom-0 w-12 bg-slate-800 border-r border-slate-700 flex flex-col items-end pt-4 pr-2 text-slate-500 text-xs font-mono select-none">
                                        <div v-for="n in 25" :key="n" class="leading-6">{{n}}</div>
                                    </div>
                                    <div ref="passageContainer"
                                        class="passage-content ide-mode-content absolute left-12 right-0 top-0 bottom-0 p-4 text-slate-300 font-mono text-sm leading-6 whitespace-pre-wrap overflow-y-auto ide-scroll select-text"
                                        v-html="highlightedPassage" @click="handlePassageClick"></div>
                                </div>
                                <!-- Status Bar -->
                                <div class="bg-blue-600 text-white text-xs px-3 py-1 flex justify-between font-mono">
                                    <span>-- INSERT --</span>
                                    <span>UTF-8</span>
                                </div>
                            </div>

                            <!-- Right Column: Question -->
                            <div
                                class="bg-white p-6 rounded-3xl shadow-lg border border-slate-100 relative overflow-hidden">
                                <div class="absolute top-0 left-0 w-2 h-full bg-sky-500"></div>
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold text-slate-800">題目</h3>
                                    <span v-if="activeQuiz.questions[currentQuestionIndex].pirlsLevel"
                                        class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-medium">
                                        {{ getPirlsLevelName(activeQuiz.questions[currentQuestionIndex].pirlsLevel) }}
                                    </span>
                                </div>

                                <h4 class="text-xl font-bold text-slate-800 mb-6 leading-relaxed">
                                    {{ activeQuiz.questions[currentQuestionIndex].title }}
                                </h4>

                                <div class="space-y-3">
                                    <button v-for="(opt, idx) in activeQuiz.questions[currentQuestionIndex].options"
                                        :key="idx" @click="selectAnswer(idx + 1)"
                                        :class="{'bg-sky-500 text-white border-sky-500': currentAnswer === (idx + 1), 'bg-white text-slate-700 border-slate-200 hover:border-sky-300 hover:bg-sky-50': currentAnswer !== (idx + 1)}"
                                        class="w-full text-left p-4 rounded-xl border-2 transition-all duration-200 font-medium flex items-center group">
                                        <span
                                            class="w-8 h-8 rounded-full border-2 flex items-center justify-center mr-4 text-sm font-bold"
                                            :class="{'border-white text-white': currentAnswer === (idx + 1), 'border-slate-300 text-slate-400 group-hover:border-sky-400 group-hover:text-sky-400': currentAnswer !== (idx + 1)}">
                                            {{ String.fromCharCode(65+idx) }}
                                        </span>
                                        {{ opt }}
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Regular Multiple Choice Layout -->
                        <div v-else
                            class="bg-white p-6 sm:p-10 rounded-3xl shadow-lg border border-slate-100 mb-8 relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-2 h-full bg-sky-500"></div>
                            <h3 class="text-xl sm:text-2xl font-bold text-slate-800 mb-8 leading-relaxed">
                                {{ activeQuiz.questions[currentQuestionIndex].title }}
                            </h3>

                            <div class="space-y-3">
                                <button v-for="(opt, idx) in activeQuiz.questions[currentQuestionIndex].options"
                                    :key="idx" @click="selectAnswer(idx + 1)"
                                    :class="{'bg-sky-500 text-white border-sky-500': currentAnswer === (idx + 1), 'bg-white text-slate-700 border-slate-200 hover:border-sky-300 hover:bg-sky-50': currentAnswer !== (idx + 1)}"
                                    class="w-full text-left p-4 rounded-xl border-2 transition-all duration-200 font-medium flex items-center group">
                                    <span
                                        class="w-8 h-8 rounded-full border-2 flex items-center justify-center mr-4 text-sm font-bold"
                                        :class="{'border-white text-white': currentAnswer === (idx + 1), 'border-slate-300 text-slate-400 group-hover:border-sky-400 group-hover:text-sky-400': currentAnswer !== (idx + 1)}">
                                        {{ String.fromCharCode(65+idx) }}
                                    </span>
                                    {{ opt }}
                                </button>
                            </div>
                        </div>

                        <!-- Navigation Buttons (Same for both types) -->
                        <div class="flex justify-between">
                            <button @click="prevQuestion" :disabled="currentQuestionIndex === 0"
                                class="px-6 py-3 rounded-xl font-bold text-slate-500 hover:bg-slate-200 disabled:opacity-0 transition">上一題</button>

                            <button v-if="currentQuestionIndex < activeQuiz.questions.length - 1" @click="nextQuestion"
                                class="px-8 py-3 bg-sky-500 text-white rounded-xl font-bold shadow-lg shadow-sky-200 hover:bg-sky-600 transition">
                                下一題 <i class="fa-solid fa-arrow-right ml-2"></i>
                            </button>
                            <button v-else @click="submitQuiz"
                                class="px-8 py-3 bg-green-500 text-white rounded-xl font-bold shadow-lg shadow-green-200 hover:bg-green-600 transition">
                                提交試卷 <i class="fa-solid fa-check ml-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- VIEW: Quiz Result -->
                    <div v-else-if="currentView === 'result'" class="max-w-3xl mx-auto w-full pb-10">
                        <div class="bg-white rounded-3xl shadow-xl overflow-hidden border border-slate-100 mb-8">
                            <div class="bg-slate-800 text-white p-8 text-center relative overflow-hidden">
                                <div class="absolute inset-0 bg-gradient-to-r from-violet-600 to-indigo-600 opacity-90">
                                </div>
                                <div class="relative z-10">
                                    <p class="text-indigo-200 mb-2">{{ activeQuiz.title }}</p>
                                    <h2 class="text-5xl font-bold mb-2">{{ score }} <span
                                            class="text-2xl font-normal opacity-70">分</span></h2>
                                    <p class="text-indigo-100">做的好，{{ studentName }}！</p>
                                </div>
                            </div>

                            <div class="p-8">
                                <h3 class="font-bold text-slate-700 mb-6 text-lg border-l-4 border-indigo-500 pl-3">詳細解析
                                </h3>
                                <div class="space-y-6">
                                    <div v-for="(q, idx) in activeQuiz.questions" :key="idx"
                                        class="p-5 rounded-2xl border"
                                        :class="studentAnswers[idx] == q.answer ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'">
                                        <div class="flex gap-3 mb-3">
                                            <div class="mt-1">
                                                <i v-if="studentAnswers[idx] == q.answer"
                                                    class="fa-solid fa-circle-check text-green-500 text-xl"></i>
                                                <i v-else class="fa-solid fa-circle-xmark text-red-500 text-xl"></i>
                                            </div>
                                            <div>
                                                <h4 class="font-bold text-slate-800 text-lg">{{ idx + 1 }}. {{ q.title
                                                    }}</h4>
                                            </div>
                                        </div>

                                        <div class="ml-8 space-y-2 text-sm">
                                            <div class="flex items-center gap-2">
                                                <span class="font-bold text-slate-500">您的答案：</span>
                                                <span
                                                    :class="studentAnswers[idx] == q.answer ? 'text-green-700 font-bold' : 'text-red-700 font-bold line-through'">
                                                    {{ q.options[studentAnswers[idx]-1] }}
                                                </span>
                                            </div>
                                            <div v-if="studentAnswers[idx] != q.answer" class="flex items-center gap-2">
                                                <span class="font-bold text-slate-500">正確答案：</span>
                                                <span class="text-green-700 font-bold">
                                                    {{ q.options[q.answer-1] }}
                                                </span>
                                            </div>
                                            <div class="mt-3 p-3 bg-white/60 rounded-lg text-slate-600 text-sm">
                                                <i class="fa-regular fa-lightbulb mr-1 text-yellow-500"></i>
                                                {{ q.explanation || '無解析' }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="p-6 bg-slate-50 border-t border-slate-100 text-center">
                                <button @click="goToView('landing')"
                                    class="px-8 py-3 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900 transition">
                                    返回首頁
                                </button>
                            </div>
                        </div>
                    </div>

                </transition>
            </main>

            <!-- Footer -->
            <footer
                class="bg-white/80 backdrop-blur-md border-t border-slate-200 py-4 text-center text-sm text-slate-500">
                Made by <a href="https://kentxchang.blogspot.com/" target="_blank"
                    class="text-violet-600 hover:underline font-bold">佳駿老師</a>
            </footer>
        </div>

        <!-- Settings Modal -->
        <div v-if="showSettingsModal"
            class="fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl flex flex-col">
                <!-- Header -->
                <div class="p-6 border-b border-slate-100 flex justify-between items-center sticky top-0 bg-white z-10">
                    <h3 class="text-xl font-bold flex items-center gap-2">
                        <i class="fa-solid fa-gear text-slate-400"></i> 系統設定
                    </h3>
                    <button @click="showSettingsModal = false" class="text-slate-400 hover:text-slate-600">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>

                <div class="p-6 space-y-8">
                    <!-- 區塊 1: 資料庫連線設定 -->
                    <div>
                        <h4
                            class="text-sm font-bold text-slate-500 mb-4 uppercase tracking-wider border-l-4 border-violet-500 pl-2">
                            資料庫連接</h4>

                        <!-- 若未設定或處於編輯模式，顯示輸入框 -->
                        <div v-if="!isConfigured || showConfigEdit" class="space-y-4">
                            <div
                                class="bg-slate-50 p-4 rounded-xl border border-slate-200 text-sm text-slate-600 relative">
                                <div class="flex justify-between items-start mb-2">
                                    <h4 class="font-bold text-slate-800 flex items-center"><i
                                            class="fa-solid fa-circle-info mr-2 text-violet-500"></i> 設定方式說明</h4>
                                    <button @click="showTutorialModal = true"
                                        class="text-xs bg-violet-600 text-white px-3 py-1.5 rounded-lg hover:bg-violet-700 transition shadow-md shadow-violet-200 flex items-center">
                                        <i class="fa-solid fa-book-open mr-1.5"></i>查看圖文教學
                                    </button>
                                </div>
                                <div class="space-y-3">
                                    <div>
                                        <p class="font-bold text-slate-700 mb-1">方式一：本機暫存 (適合測試)</p>
                                        <p class="text-xs">將 Config 貼在下方，設定僅存在此瀏覽器。若清除快取需重新輸入。</p>
                                    </div>
                                    <div>
                                        <p class="font-bold text-slate-700 mb-1">方式二：永久寫入 (適合發布)</p>
                                        <p class="text-xs">直接編輯 <code>index.html</code> 原始碼，將內容填入
                                            <code>manualConfig</code> 變數。學生開啟網頁即可直接使用，無需任何設定。</p>
                                    </div>
                                </div>
                            </div>
                            <textarea v-model="configInput"
                                placeholder='const firebaseConfig = {&#10;  apiKey: "AIza...",&#10;  authDomain: "...",&#10;  ...&#10;};'
                                class="w-full h-32 p-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-violet-500 font-mono text-sm bg-slate-50"></textarea>

                            <button @click="parseAndSaveConfig"
                                class="w-full py-3 bg-violet-600 hover:bg-violet-700 text-white rounded-xl font-bold shadow-lg shadow-violet-200 transition">
                                儲存並連線
                            </button>
                            <button v-if="isConfigured" @click="showConfigEdit = false"
                                class="w-full py-2 text-slate-400 text-sm hover:text-slate-600">取消編輯</button>
                        </div>

                        <!-- 若已設定，顯示狀態 -->
                        <div v-else
                            class="bg-green-50 p-4 rounded-xl border border-green-100 flex flex-col sm:flex-row gap-4 justify-between items-center">
                            <div class="flex items-center text-green-700 font-bold">
                                <i class="fa-solid fa-check-circle text-xl mr-2"></i>
                                已連接 Firebase 資料庫
                            </div>
                            <div class="flex gap-2 w-full sm:w-auto">
                                <button @click="clearFirebaseConfig"
                                    class="flex-1 sm:flex-none px-4 py-2 text-sm bg-white border border-red-200 text-red-500 rounded-lg hover:bg-red-50 transition font-medium">
                                    清除連線 (Clear)
                                </button>
                                <button @click="showConfigEdit = true"
                                    class="flex-1 sm:flex-none px-4 py-2 text-sm bg-white border border-slate-200 text-slate-600 rounded-lg hover:text-violet-600 hover:border-violet-200 transition font-medium">
                                    重新設定
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 區塊 1.5: AI API 設定 -->
                    <div>
                        <h4
                            class="text-sm font-bold text-slate-500 mb-4 uppercase tracking-wider border-l-4 border-blue-500 pl-2">
                            AI API 設定</h4>
                        <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 space-y-3">
                            <div class="text-xs text-slate-500 bg-blue-100 p-3 rounded-lg space-y-2">
                                <p class="font-bold text-slate-600">如何取得及設定 API Key:</p>
                                <p><i class="fa-solid fa-lightbulb mr-1 text-yellow-500"></i> 您可以透過 Google AI Studio
                                    取得免費的 Gemini API Key。</p>
                                <p><i class="fa-solid fa-link mr-1"></i> <a
                                        href="https://aistudio.google.com/app/apikey" target="_blank"
                                        class="text-blue-600 hover:underline font-bold">點此前往 Google AI Studio 申請 API
                                        Key</a></p>
                                <p><i class="fa-solid fa-gear mr-1"></i> 申請後，將 API Key 貼到下方的輸入框即可自動儲存。</p>
                            </div>
                            <div class="relative">
                                <input type="text" v-model="customApiKey" placeholder="在此貼上您的 Gemini API Key"
                                    class="w-full p-2 text-sm border border-blue-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 pr-16">
                                <transition name="fade">
                                    <span v-if="isApiKeySaved"
                                        class="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-green-600 font-bold flex items-center pointer-events-none">
                                        <i class="fa-solid fa-check mr-1.5"></i>已儲存
                                    </span>
                                </transition>
                            </div>
                        </div>
                    </div>

                    <!-- 區塊 2: 分享 (僅在已設定時顯示) -->
                    <div v-if="isConfigured">
                        <h4
                            class="text-sm font-bold text-slate-500 mb-4 uppercase tracking-wider border-l-4 border-sky-500 pl-2">
                            分享應用程式</h4>
                        <div class="space-y-4">
                            <!-- 教師用 -->
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <p class="font-bold text-slate-700 mb-2">教師用分享 (完整功能)</p>
                                <div class="flex flex-col sm:flex-row gap-6 items-center">
                                    <div class="bg-white p-2 rounded-lg border shadow-sm cursor-pointer hover:shadow-lg hover:ring-2 hover:ring-sky-500 transition"
                                        @click="openQrModal('teacher')">
                                        <div id="qrcode"></div>
                                    </div>
                                    <div class="flex-1 w-full">
                                        <p class="text-xs text-slate-500 mb-2">此連結包含設定檔，供其他教師或您自己在其他裝置上使用。</p>
                                        <div class="flex gap-2">
                                            <input type="text" :value="shareUrl" readonly
                                                class="flex-1 p-2 text-xs border rounded bg-white text-slate-500">
                                            <button @click="copyShareUrl('teacher')"
                                                class="px-3 py-2 bg-slate-200 rounded hover:bg-slate-300 text-slate-600 text-xs font-bold whitespace-nowrap">複製</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- 學生用 -->
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <p class="font-bold text-blue-800 mb-2">學生專用分享 (簡化介面)</p>
                                <div class="flex flex-col sm:flex-row gap-6 items-center">
                                    <div class="bg-white p-2 rounded-lg border shadow-sm cursor-pointer hover:shadow-lg hover:ring-2 hover:ring-blue-500 transition"
                                        @click="openQrModal('student')">
                                        <div id="studentQrcode"></div>
                                    </div>
                                    <div class="flex-1 w-full">
                                        <p class="text-xs text-slate-500 mb-2">學生將只能看到學生登入畫面，無法進入教師後台或更改設定。</p>
                                        <div class="flex gap-2">
                                            <input type="text" :value="studentShareUrl" readonly
                                                class="flex-1 p-2 text-xs border rounded bg-white text-slate-500">
                                            <button @click="copyShareUrl('student')"
                                                class="px-3 py-2 bg-blue-200 rounded hover:bg-blue-300 text-blue-800 text-xs font-bold whitespace-nowrap">複製</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 區塊 2.5: 更新日誌 -->
                    <div class="mb-6">
                        <details>
                            <summary
                                class="text-sm font-bold text-slate-500 uppercase tracking-wider cursor-pointer border-l-4 border-violet-300 pl-2 select-none hover:text-violet-600 transition">
                                <i class="fa-solid fa-clock-rotate-left mr-1"></i> 更新日誌
                            </summary>
                            <div class="mt-3 space-y-2 max-h-48 overflow-y-auto pr-2">
                                <div v-for="log in updateLog" :key="log.date + log.desc"
                                    class="text-xs p-2 bg-slate-50 rounded-lg border border-slate-100">
                                    <span class="font-bold text-slate-700">{{ log.date }}</span>: {{ log.desc }}
                                </div>
                            </div>
                        </details>
                    </div>

                    <!-- 區塊 3: 重置 -->
                    <div>
                        <h4
                            class="text-sm font-bold text-slate-500 mb-4 uppercase tracking-wider border-l-4 border-red-500 pl-2">
                            危險區域</h4>
                        <button @click="resetConfig"
                            class="w-full py-3 border border-red-200 text-red-600 rounded-xl text-sm hover:bg-red-50 font-bold transition">
                            <i class="fa-solid fa-trash-can mr-2"></i>清除所有設定並登出 (Reset All)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tutorial Modal (詳細教學圖層) -->
        <div v-if="showTutorialModal"
            class="fixed inset-0 z-[60] bg-slate-900/95 backdrop-blur flex items-center justify-center p-4">
            <div
                class="bg-white rounded-2xl w-full max-w-4xl h-[90vh] flex flex-col shadow-2xl relative animate-fade-in-up">
                <!-- Header -->
                <div class="p-6 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 bg-orange-100 text-orange-600 rounded-lg flex items-center justify-center text-xl">
                            <i class="fa-brands fa-google-fire"></i>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-slate-800">Firebase 設定詳細教學</h3>
                            <p class="text-xs text-slate-500">請依照步驟完成專案建置</p>
                        </div>
                    </div>
                    <button @click="showTutorialModal = false"
                        class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-200 hover:bg-slate-300 text-slate-600 transition">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>

                <!-- Content -->
                <div class="flex-1 overflow-y-auto p-6 space-y-8 bg-white">
                    <!-- Step 1 -->
                    <section class="flex gap-4">
                        <div
                            class="flex-shrink-0 w-8 h-8 bg-violet-100 text-violet-600 rounded-full flex items-center justify-center font-bold">
                            1</div>
                        <div>
                            <h4 class="text-lg font-bold text-slate-800 mb-2">建立專案</h4>
                            <p class="text-slate-600 mb-2 text-sm">前往 <a href="https://console.firebase.google.com"
                                    target="_blank" class="text-blue-500 underline font-medium">Firebase
                                    Console</a>，點擊「新增專案 (Create a project)」，輸入專案名稱並完成建立。</p>
                        </div>
                    </section>

                    <!-- Step 2 -->
                    <section class="flex gap-4">
                        <div
                            class="flex-shrink-0 w-8 h-8 bg-violet-100 text-violet-600 rounded-full flex items-center justify-center font-bold">
                            2</div>
                        <div>
                            <h4 class="text-lg font-bold text-slate-800 mb-2">新增 Web 應用程式 & 取得 Config</h4>
                            <p class="text-slate-600 mb-2 text-sm">進入專案後，點擊首頁上方的 Web 圖示 ( <code>&lt;/&gt;</code> )。</p>
                            <ul
                                class="list-disc list-inside text-slate-500 ml-1 space-y-1 text-sm bg-slate-50 p-3 rounded-lg border border-slate-100">
                                <li>輸入 App 暱稱 (例如: Quiz App)。</li>
                                <li>點擊「註冊應用程式 (Register app)」。</li>
                                <li><strong class="text-violet-600">關鍵步驟：</strong>複製出現的
                                    <code>const firebaseConfig = { ... }</code> 程式碼區塊。</li>
                            </ul>
                        </div>
                    </section>

                    <!-- Step 2.5 (New) -->
                    <section class="flex gap-4 bg-indigo-50 p-4 rounded-xl border border-indigo-100">
                        <div
                            class="flex-shrink-0 w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center font-bold text-lg">
                            <i class="fa-solid fa-code"></i></div>
                        <div>
                            <h4 class="text-lg font-bold text-slate-800 mb-2">進階：如何寫死設定 (Hardcode)</h4>
                            <p class="text-slate-600 mb-2 text-sm">若您希望學生打開網頁即可直接使用，無需掃描 QR Code 或輸入設定，請執行此步驟：</p>
                            <ol class="list-decimal list-inside text-slate-600 text-sm space-y-2">
                                <li>使用文字編輯器 (如 Notepad, VS Code) 開啟 <code>index.html</code> 檔案。</li>
                                <li>搜尋關鍵字 <code>const manualConfig = {</code>。</li>
                                <li>將剛剛複製的 <code>apiKey</code> 等內容，貼入該物件的大括號中。</li>
                                <li>儲存檔案，將此 HTML 檔案傳送給學生或部署到網站即可。</li>
                            </ol>
                        </div>
                    </section>

                    <!-- Step 3 -->
                    <section class="flex gap-4">
                        <div
                            class="flex-shrink-0 w-8 h-8 bg-violet-100 text-violet-600 rounded-full flex items-center justify-center font-bold">
                            3</div>
                        <div>
                            <h4 class="text-lg font-bold text-slate-800 mb-2">開啟 Authentication (驗證)</h4>
                            <p class="text-slate-600 mb-2 text-sm">在左側選單點擊「建置 (Build)」>「Authentication」。</p>
                            <ul
                                class="list-disc list-inside text-slate-500 ml-1 space-y-1 text-sm bg-slate-50 p-3 rounded-lg border border-slate-100">
                                <li>點擊「開始使用 (Get started)」。</li>
                                <li>切換到「Sign-in method」頁籤。</li>
                                <li>選擇「匿名 (Anonymous)」，將開關 <strong class="text-green-600">啟用</strong> 並儲存。</li>
                            </ul>
                        </div>
                    </section>

                    <!-- Step 4 -->
                    <section class="flex gap-4">
                        <div
                            class="flex-shrink-0 w-8 h-8 bg-violet-100 text-violet-600 rounded-full flex items-center justify-center font-bold">
                            4</div>
                        <div>
                            <h4 class="text-lg font-bold text-slate-800 mb-2">建立 Firestore 資料庫</h4>
                            <p class="text-slate-600 mb-2 text-sm">在左側選單點擊「建置 (Build)」>「Firestore Database」。</p>
                            <ul
                                class="list-disc list-inside text-slate-500 ml-1 space-y-1 text-sm bg-slate-50 p-3 rounded-lg border border-slate-100">
                                <li>點擊「建立資料庫 (Create database)」。</li>
                                <li>選擇「以測試模式啟動 (Start in test mode)」(方便快速測試)。</li>
                                <li>選擇位置 (Location)，通常選預設即可，等待建立完成。</li>
                            </ul>
                        </div>
                    </section>

                    <!-- Step 5 -->
                    <section class="flex gap-4">
                        <div
                            class="flex-shrink-0 w-8 h-8 bg-violet-100 text-violet-600 rounded-full flex items-center justify-center font-bold">
                            5</div>
                        <div class="w-full">
                            <h4 class="text-lg font-bold text-slate-800 mb-2">設定安全性規則 (建議)</h4>
                            <p class="text-slate-600 mb-2 text-sm">在 Firestore 頁面上方切換到「規則 (Rules)」頁籤，貼上以下規則以確保權限正確：</p>
                            <div
                                class="bg-slate-800 text-slate-200 p-4 rounded-lg font-mono text-xs overflow-x-auto relative group mt-2 border border-slate-700 shadow-inner">
                                <pre>rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /config/quizStatus {
      allow read, write: if true;
    }
    match /quizzes/{quizId} {
      allow read: if true;
      allow create, delete: if request.auth != null;
    }
    match /results/{resultId} {
      allow create, read: if true;
    }
  }
}</pre>
                                <button @click="copyRules"
                                    class="absolute top-2 right-2 bg-white/10 hover:bg-white/20 text-white px-2 py-1 rounded text-xs transition">複製</button>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Footer -->
                <div class="p-4 border-t bg-slate-50 text-center rounded-b-2xl">
                    <button @click="showTutorialModal = false"
                        class="px-8 py-3 bg-violet-600 text-white font-bold rounded-xl hover:bg-violet-700 transition shadow-lg shadow-violet-200">
                        我了解了，開始設定
                    </button>
                </div>
            </div>
        </div>

        <!-- 全域訊息 Modal (取代 alert/confirm) -->
        <transition name="modal">
            <div v-if="modalState.show"
                class="fixed inset-0 z-[100] bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4">
                <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden transform transition-all">
                    <div class="p-6 text-center">
                        <div class="mx-auto mb-4 w-16 h-16 flex items-center justify-center rounded-full" :class="{
                            'bg-green-100 text-green-500': modalState.type === 'success',
                            'bg-red-100 text-red-500': modalState.type === 'error',
                            'bg-yellow-100 text-yellow-500': modalState.type === 'warning',
                            'bg-blue-100 text-blue-500': modalState.type === 'info' || modalState.type === 'confirm'
                        }">
                            <i class="fa-solid text-3xl" :class="{
                               'fa-check': modalState.type === 'success',
                               'fa-xmark': modalState.type === 'error',
                               'fa-exclamation': modalState.type === 'warning',
                               'fa-info': modalState.type === 'info',
                               'fa-question': modalState.type === 'confirm'
                           }"></i>
                        </div>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">{{ modalState.title }}</h3>
                        <p class="text-slate-500 text-sm">{{ modalState.message }}</p>
                    </div>
                    <div class="bg-slate-50 px-6 py-4 flex gap-3 justify-center">
                        <template v-if="modalState.type === 'confirm'">
                            <button @click="handleCancel"
                                class="flex-1 py-2.5 bg-white border border-slate-300 text-slate-700 font-bold rounded-xl hover:bg-slate-50 transition">取消</button>
                            <button @click="handleConfirm"
                                class="flex-1 py-2.5 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-200">確認</button>
                        </template>
                        <template v-else>
                            <button @click="handleConfirm"
                                class="w-full py-2.5 text-white font-bold rounded-xl transition shadow-lg" :class="{
                                'bg-green-500 hover:bg-green-600 shadow-green-200': modalState.type === 'success',
                                'bg-red-500 hover:bg-red-600 shadow-red-200': modalState.type === 'error',
                                'bg-yellow-500 hover:bg-yellow-600 shadow-yellow-200 text-white': modalState.type === 'warning',
                                'bg-blue-500 hover:bg-blue-600 shadow-blue-200': modalState.type === 'info'
                             }">
                                確定
                            </button>
                        </template>
                    </div>
                </div>
            </div>
        </transition>

        <!-- AI 生成中 Loading Overlay -->
        <transition name="fade">
            <div v-if="isGenerating"
                class="fixed inset-0 z-[99] bg-gradient-to-br from-violet-900/80 to-indigo-900/80 backdrop-blur-sm flex items-center justify-center">
                <div
                    class="bg-white/95 rounded-3xl shadow-2xl p-8 max-w-sm w-full mx-4 text-center transform transition-all">
                    <div class="mb-6">
                        <div
                            class="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-violet-500 to-indigo-600 rounded-full mb-4 animate-pulse">
                            <i class="fa-solid fa-robot text-white text-3xl"></i>
                        </div>
                        <div class="flex justify-center gap-2 mb-4">
                            <div class="w-3 h-3 bg-violet-500 rounded-full animate-bounce" style="animation-delay: 0ms">
                            </div>
                            <div class="w-3 h-3 bg-indigo-500 rounded-full animate-bounce"
                                style="animation-delay: 150ms"></div>
                            <div class="w-3 h-3 bg-purple-500 rounded-full animate-bounce"
                                style="animation-delay: 300ms"></div>
                        </div>
                    </div>
                    <h3 class="text-2xl font-bold text-slate-800 mb-2">AI 生成中</h3>
                    <p class="text-slate-600 text-sm">正在使用 AI 為您生成內容，請稍候...</p>
                    <div class="mt-4 text-xs text-slate-400">
                        <i class="fa-solid fa-circle-notch fa-spin mr-1"></i>
                        這可能需要幾秒鐘時間
                    </div>
                </div>
            </div>
        </transition>

        <!-- Large QR Code Modal -->
        <transition name="fade">
            <div v-if="showQrModal" @click="closeQrModal"
                class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4 cursor-pointer">
                <div @click.stop
                    class="bg-white p-6 sm:p-8 rounded-2xl shadow-2xl flex flex-col items-center gap-4 cursor-default">
                    <h3 class="text-xl font-bold text-slate-800">{{ qrModalTitle }}</h3>
                    <div id="modal-qrcode-large"></div>
                    <p class="text-sm text-slate-500">點擊畫面任意處關閉</p>
                </div>
            </div>
        </transition>

    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Using IIFE (Immediately Invoked Function Expression) to avoid global scope pollution
        // This fixes the "Identifier 'createApp' has already been declared" error when script re-runs.
        (function () {
            const { createApp, ref, reactive, computed, onMounted, nextTick, watch } = Vue;

            createApp({
                setup() {
                    // --- 程式碼設定區 ---
                    const manualConfig = {
                        //在這裡貼上六行firebase設定好的程式碼

                    };

                    // --- Global Message Modal State ---
                    const modalState = reactive({
                        show: false,
                        title: '',
                        message: '',
                        type: 'info', // success, error, warning, info, confirm
                        resolve: null,
                        reject: null
                    });

                    // Helper: Show Alert
                    const showAlert = (title, message, type = 'info') => {
                        modalState.title = title;
                        modalState.message = message;
                        modalState.type = type;
                        modalState.show = true;
                        modalState.resolve = null;
                    };

                    // Helper: Show Confirm
                    const showConfirm = (title, message) => {
                        return new Promise((resolve, reject) => {
                            modalState.title = title;
                            modalState.message = message;
                            modalState.type = 'confirm';
                            modalState.show = true;
                            modalState.resolve = resolve;
                            modalState.reject = reject;
                        });
                    };

                    const handleConfirm = () => {
                        modalState.show = false;
                        if (modalState.resolve) modalState.resolve(true);
                    };

                    const handleCancel = () => {
                        modalState.show = false;
                        if (modalState.resolve) modalState.resolve(false);
                    };


                    // --- State ---
                    const configInput = ref('');
                    const isConfigured = ref(false);
                    const currentView = ref('landing');

                    // Settings & AI
                    const customApiKey = ref(localStorage.getItem('custom_api_key') || '');
                    const showSettingsModal = ref(false);
                    const showConfigEdit = ref(false);
                    const showTutorialModal = ref(false);
                    const shareUrl = ref('');
                    const studentShareUrl = ref('');
                    const isStudentView = ref(false);

                    // QR Code Modal
                    const showQrModal = ref(false);
                    const qrModalContent = ref('');
                    const qrModalTitle = ref('');

                    // Teacher
                    const teacherPassword = ref('');
                    const quizzes = ref([]);
                    const showCreateQuiz = ref(false);
                    const editingQuizId = ref(null); // Track which quiz is being edited
                    const createMode = ref('ai');
                    const aiSourceText = ref('');
                    const aiImageBase64 = ref('');
                    const isPdfLoading = ref(false);
                    const isGenerating = ref(false);
                    const manualInput = ref('');
                    const aiConfig = reactive({ easy: 2, medium: 2, hard: 1 });
                    const newQuiz = reactive({
                        title: '',
                        category: '',
                        questions: [],
                        questionType: 'multiple-choice',
                        readingPassage: '' // For reading comprehension
                    });

                    // Reading comprehension configuration
                    const readingConfig = reactive({
                        textSource: 'paste', // 'paste', 'upload', 'topic'
                        topic: '',
                        language: '繁中', // '繁中', '英文', '日文', '韓文'
                        pirlsLevels: {
                            retrieval: 2, // 提取訊息
                            inference: 2, // 推論理解
                            interpretation: 1, // 詮釋整合
                            evaluation: 1 // 評估鑑賞
                        }
                    });

                    // Question Editor
                    const showQuestionEditor = ref(false);
                    const currentEditingQuestion = reactive({ title: '', options: ['', '', '', ''], answer: 1, difficulty: '一般', explanation: '' });
                    const currentEditingQuestionIndex = ref(-1);

                    // Category Filter
                    const selectedCategory = ref('All');

                    // Analytics
                    const showAnalytics = ref(false);
                    const analyticsTab = ref('score'); // 'score' or 'question'
                    const selectedAnalyticsQuiz = ref(null);
                    const analyticsData = ref([]);
                    const selectedStudentResult = ref(null);

                    // Student & Global State
                    const studentName = ref('');
                    const selectedQuizId = ref(''); // 保留變數但主要依賴 activeQuizId
                    const activeQuizId = ref(null); // 全域啟用中的 Quiz ID
                    const activeQuiz = ref(null);
                    const currentQuestionIndex = ref(0);
                    const studentAnswers = ref([]);
                    const currentAnswer = ref(null);
                    const score = ref(0);

                    // Firebase Refs
                    let db = null;
                    let auth = null;
                    let user = ref(null);
                    let appId = null;

                    // --- 更新日誌 ---
                    const updateLog = ref([
                        { date: '2025/12/05', desc: '新增手動清除 Firebase 連線設定的功能。' },
                        { date: '2025/12/04', desc: '新增學生專用分享連結，開啟後將隱藏教師入口與設定；修復 iPad 螢光筆功能；簡化 AI API 設定。' },
                        { date: '2025/12/04', desc: '教師儀表板增加顯示目前啟用題庫及結束測驗按鈕。' },
                        { date: '2025/12/04', desc: '新增題庫內容編輯及刪除單題功能。' },
                        { date: '2025/12/04', desc: '新增分類篩選及題庫複製功能。' },
                        { date: '2025/12/04', desc: '分析報告新增試題分析頁面 (答對率及答錯名單)。' },
                        { date: '2025/12/04', desc: '新增成績報表 CSV 下載功能。' },
                        { date: '2025/12/04', desc: '修復 Firestore 複合查詢索引錯誤，改為客戶端排序。' },
                        { date: '2025/12/04', desc: '所有警告及確認訊息改為圖層 Modal 顯示 (移除 alert/confirm)。' },
                        { date: '2025/12/03', desc: '新增 PDF 上傳解析功能。' },
                        { date: '2025/12/03', desc: '將 Firebase Config 設置改為手動/寫死模式，移除初始化遮罩。' },
                        { date: '2025/12/02', desc: '專案建立，包含 Firebase 匿名登入、AI 出題、師生介面及成績分析圖表。' }
                    ]);

                    // --- Initialization ---
                    onMounted(async () => {
                        const urlParams = new URLSearchParams(window.location.search);
                        if (urlParams.has('mode') && urlParams.get('mode') === 'student') {
                            isStudentView.value = true;
                        }
                        await initApp();
                        // If in student view and app is ready, go directly to student login
                        if (isStudentView.value && isConfigured.value) {
                            goToView('student-login');
                        }

                        // Highlight code on mount and updates
                        nextTick(() => {
                            Prism.highlightAll();
                        });
                    });

                    const initApp = async () => {
                        if (manualConfig && manualConfig.apiKey) {
                            initializeFirebase(manualConfig);
                            return;
                        }

                        const urlParams = new URLSearchParams(window.location.search);
                        const encryptedConfig = urlParams.get('config');

                        if (encryptedConfig) {
                            try {
                                const decoded = atob(encryptedConfig);
                                const configObj = JSON.parse(decoded);
                                localStorage.setItem('firebase_config', JSON.stringify(configObj));
                                // Clean URL, but preserve student mode
                                const cleanUrl = window.location.pathname + (urlParams.has('mode') ? '?mode=student' : '');
                                window.history.replaceState({}, document.title, cleanUrl);
                            } catch (e) { console.error("Config decode failed", e); }
                        }

                        const storedConfig = localStorage.getItem('firebase_config');
                        if (storedConfig) {
                            try {
                                const config = JSON.parse(storedConfig);
                                if (config && config.apiKey) {
                                    initializeFirebase(config);
                                }
                            } catch (e) { localStorage.removeItem('firebase_config'); }
                        }
                    };

                    const initializeFirebase = (config) => {
                        try {
                            if (!firebase.apps.length) {
                                firebase.initializeApp(config);
                            }
                            auth = firebase.auth();
                            db = firebase.firestore();
                            appId = config.appId;

                            auth.onAuthStateChanged((u) => {
                                if (u) {
                                    user.value = u;
                                } else {
                                    auth.signInAnonymously().catch((error) => {
                                        console.error("Auth Failed", error);
                                        showAlert("錯誤", "Firebase 連線失敗", "error");
                                        isConfigured.value = false;
                                    });
                                }
                            });

                            // 監聽全域啟用題庫狀態
                            db.collection('config').doc('quizStatus').onSnapshot(doc => {
                                if (doc.exists) {
                                    activeQuizId.value = doc.data().activeQuizId;
                                } else {
                                    activeQuizId.value = null;
                                }
                            });

                            isConfigured.value = true;
                            showConfigEdit.value = false;
                            generateShareUrls(config);
                        } catch (e) {
                            console.error(e);
                            showAlert("錯誤", "Firebase 初始化失敗", "error");
                            localStorage.removeItem('firebase_config');
                            isConfigured.value = false;
                        }
                    };

                    const checkConfigAndGo = (view) => {
                        if (!isConfigured.value) {
                            showAlert("系統未就緒", "請先完成系統設定！\n請點擊右上角的「未連線」按鈕或齒輪圖示進行設定。", "warning");
                            showSettingsModal.value = true;
                            return;
                        }
                        goToView(view);
                    };

                    const parseAndSaveConfig = () => {
                        const text = configInput.value;
                        const keys = ['apiKey', 'authDomain', 'projectId', 'storageBucket', 'messagingSenderId', 'appId'];
                        const config = {};
                        let found = false;

                        keys.forEach(key => {
                            const regex = new RegExp(`${key}\\s*[:=]\\s*["']([^"']+)["']`);
                            const match = text.match(regex);
                            if (match) {
                                config[key] = match[1];
                                found = true;
                            }
                        });

                        if (found && config.apiKey) {
                            localStorage.setItem('firebase_config', JSON.stringify(config));
                            window.location.reload();
                        } else {
                            showAlert("設定錯誤", "無法解析 Config，請確保複製完整的 firebaseConfig 物件內容。", "error");
                        }
                    };

                    const clearFirebaseConfig = async () => {
                        const confirm = await showConfirm("清除連線設定", "確定要清除本機的 Firebase 連線設定嗎？\n(這不會清除其他資料)");
                        if (confirm) {
                            localStorage.removeItem('firebase_config');
                            window.location.reload();
                        }
                    };

                    let debounceTimer = null;
                    const isApiKeySaved = ref(false);

                    watch(customApiKey, (newValue) => {
                        clearTimeout(debounceTimer);
                        isApiKeySaved.value = false;
                        debounceTimer = setTimeout(() => {
                            localStorage.setItem('custom_api_key', newValue);
                            isApiKeySaved.value = true;
                            setTimeout(() => isApiKeySaved.value = false, 2000);
                        }, 500);
                    });

                    const generateShareUrls = (config) => {
                        const jsonStr = JSON.stringify(config);
                        const b64 = btoa(jsonStr);
                        const baseUrl = `${window.location.protocol}//${window.location.host}${window.location.pathname}`;

                        shareUrl.value = `${baseUrl}?config=${b64}`;
                        studentShareUrl.value = `${baseUrl}?config=${b64}&mode=student`;
                    };

                    const toggleSettings = () => {
                        if (isStudentView.value) return; // Safeguard
                        showSettingsModal.value = !showSettingsModal.value;
                        if (showSettingsModal.value && isConfigured.value) {
                            nextTick(() => {
                                const teacherQrContainer = document.getElementById("qrcode");
                                if (teacherQrContainer) {
                                    teacherQrContainer.innerHTML = "";
                                    new QRCode(teacherQrContainer, { text: shareUrl.value, width: 100, height: 100 });
                                }
                                const studentQrContainer = document.getElementById("studentQrcode");
                                if (studentQrContainer) {
                                    studentQrContainer.innerHTML = "";
                                    new QRCode(studentQrContainer, { text: studentShareUrl.value, width: 100, height: 100 });
                                }
                            });
                        }
                    };

                    const resetConfig = async () => {
                        const confirm = await showConfirm("危險操作", "確定要清除所有設定並重置嗎？此動作無法復原。");
                        if (confirm) {
                            localStorage.clear();
                            window.location.reload();
                        }
                    };

                    const copyShareUrl = (type = 'teacher') => {
                        const urlToCopy = type === 'student' ? studentShareUrl.value : shareUrl.value;
                        navigator.clipboard.writeText(urlToCopy);
                        showAlert("成功", "連結已複製到剪貼簿", "success");
                    };

                    const copyRules = () => {
                        const rules = `rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /config/quizStatus {
      allow read, write: if true;
    }
    match /quizzes/{quizId} {
      allow read: if true;
      allow create, delete: if request.auth != null;
    }
    match /results/{resultId} {
      allow create, read: if true;
    }
  }
}`;
                        navigator.clipboard.writeText(rules);
                        showAlert("成功", "規則已複製到剪貼簿", "success");
                    };

                    const openQrModal = (type) => {
                        if (type === 'student') {
                            qrModalTitle.value = '學生專用分享 (簡化介面)';
                            qrModalContent.value = studentShareUrl.value;
                        } else {
                            qrModalTitle.value = '教師用分享 (完整功能)';
                            qrModalContent.value = shareUrl.value;
                        }
                        showQrModal.value = true;

                        nextTick(() => {
                            const qrContainer = document.getElementById('modal-qrcode-large');
                            if (qrContainer) {
                                qrContainer.innerHTML = ''; // Clear previous QR code
                                new QRCode(qrContainer, {
                                    text: qrModalContent.value,
                                    width: 300,
                                    height: 300,
                                    colorDark: "#000000",
                                    colorLight: "#ffffff",
                                    correctLevel: QRCode.CorrectLevel.H
                                });
                            }
                        });
                    };

                    const closeQrModal = () => {
                        showQrModal.value = false;
                        qrModalContent.value = '';
                        qrModalTitle.value = '';
                    };

                    // --- Navigation & Helper ---
                    const goToView = (view) => {
                        currentView.value = view;
                        if (view === 'teacher-dashboard') fetchQuizzes();
                        if (view === 'landing') {
                            studentName.value = '';
                            teacherPassword.value = '';
                        }
                        // Re-highlight when view changes
                        nextTick(() => Prism.highlightAll());
                    };

                    const formatDate = (ts) => {
                        if (!ts) return '';
                        return new Date(ts.seconds * 1000).toLocaleString('zh-TW');
                    };

                    // --- Teacher Logic ---
                    const verifyTeacher = () => {
                        if (teacherPassword.value === 'ccwu0918@nqu') {
                            goToView('teacher-dashboard');
                        } else {
                            showAlert("登入失敗", "密碼錯誤", "error");
                        }
                    };

                    const fetchQuizzes = () => {
                        if (!db) return;
                        db.collection('quizzes').orderBy('createdAt', 'desc').onSnapshot(snap => {
                            quizzes.value = snap.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data(),
                                category: doc.data().category || '未分類' // Default category
                            }));
                        });
                    };

                    const uniqueCategories = computed(() => {
                        const cats = new Set(quizzes.value.map(q => q.category));
                        return Array.from(cats).sort();
                    });

                    const filteredQuizzes = computed(() => {
                        if (selectedCategory.value === 'All') return quizzes.value;
                        return quizzes.value.filter(q => q.category === selectedCategory.value);
                    });

                    // Computed property to get the active quiz title
                    const getActiveQuizTitle = computed(() => {
                        const activeQ = quizzes.value.find(q => q.id === activeQuizId.value);
                        return activeQ ? activeQ.title : '未知測驗';
                    });

                    // 新增：啟用題庫功能
                    const activateQuiz = async (quizId) => {
                        try {
                            await db.collection('config').doc('quizStatus').set({ activeQuizId: quizId });
                            showAlert("啟用成功", "此題庫已設定為進行中，學生現在可以進入作答。", "success");
                        } catch (e) {
                            console.error(e);
                            showAlert("啟用失敗", "無法設定題庫狀態", "error");
                        }
                    };

                    // 新增：停止題庫功能
                    const deactivateQuiz = async () => {
                        const confirm = await showConfirm("確認結束", "確定要結束目前的測驗嗎？學生將無法再進入作答。");
                        if (confirm) {
                            try {
                                await db.collection('config').doc('quizStatus').set({ activeQuizId: null });
                                showAlert("已結束", "測驗已結束。", "success");
                            } catch (e) {
                                console.error(e);
                                showAlert("錯誤", "操作失敗", "error");
                            }
                        }
                    };

                    const handleImageUpload = (e) => {
                        const file = e.target.files[0];
                        if (!file) return;

                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const img = new Image();
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const MAX_WIDTH = 800;
                                let width = img.width;
                                let height = img.height;

                                if (width > MAX_WIDTH) {
                                    height *= MAX_WIDTH / width;
                                    width = MAX_WIDTH;
                                }
                                canvas.width = width;
                                canvas.height = height;
                                const ctx = canvas.getContext('2d');
                                ctx.drawImage(img, 0, 0, width, height);
                                aiImageBase64.value = canvas.toDataURL('image/jpeg', 0.8);
                            };
                            img.src = event.target.result;
                        };
                        reader.readAsDataURL(file);
                    };

                    const handlePdfUpload = async (e) => {
                        const file = e.target.files[0];
                        if (!file) return;
                        if (file.type !== 'application/pdf') {
                            showAlert("格式錯誤", "請上傳 PDF 檔案", "warning");
                            return;
                        }

                        isPdfLoading.value = true;
                        try {
                            const arrayBuffer = await file.arrayBuffer();
                            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                            let fullText = "";

                            for (let i = 1; i <= pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                const pageText = textContent.items.map(item => item.str).join(" ");
                                fullText += pageText + "\n\n";
                            }

                            if (aiSourceText.value) {
                                aiSourceText.value += "\n\n" + fullText.trim();
                            } else {
                                aiSourceText.value = fullText.trim();
                            }

                            showAlert("解析成功", `成功讀取 PDF 共 ${pdf.numPages} 頁內容`, "success");
                            nextTick(() => Prism.highlightAll()); // Refresh highlight
                        } catch (error) {
                            console.error("PDF 解析失敗", error);
                            showAlert("解析失敗", "PDF 解析失敗，可能是檔案加密或格式不支援", "error");
                        } finally {
                            isPdfLoading.value = false;
                            e.target.value = '';
                        }
                    };

                    const generateQuestions = async () => {
                        if (!aiSourceText.value && !aiImageBase64.value) {
                            showAlert("缺少內容", "請輸入文字或上傳圖片/PDF", "warning");
                            return;
                        }

                        isGenerating.value = true;
                        newQuiz.questions = [];

                        const key = customApiKey.value;
                        if (!key) {
                            showAlert("API Key 缺失", "請先在設定中輸入您的 Gemini API Key", "warning");
                            isGenerating.value = false;
                            return;
                        }

                        const prompt = `
                你是一位專業教師。請根據提供的內容，生成一份選擇題測驗。
                
                需求設定:
                - 簡單題數: ${aiConfig.easy}
                - 一般題數: ${aiConfig.medium}
                - 困難題數: ${aiConfig.hard}
                - 語言: 繁體中文 (Traditional Chinese)
                
                輸出格式必須是嚴格的 JSON Array，不要 Markdown 標記，格式如下:
                [
                    {
                        "title": "題目內容",
                        "options": ["選項A", "選項B", "選項C", "選項D"],
                        "answer": 1, // 1代表A, 2代表B...
                        "difficulty": "簡單",
                        "explanation": "解析內容"
                    }
                ]
            `;

                        const contents = [{
                            parts: [{ text: prompt }]
                        }];

                        if (aiSourceText.value) contents[0].parts.push({ text: `文本內容:\n${aiSourceText.value}` });
                        if (aiImageBase64.value) {
                            const base64Data = aiImageBase64.value.split(',')[1];
                            contents[0].parts.push({
                                inlineData: { mimeType: "image/jpeg", data: base64Data }
                            });
                        }

                        try {
                            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                            const resp = await fetch(url, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ contents })
                            });

                            const data = await resp.json();

                            if (data.error) throw new Error(data.error.message);

                            let text = data.candidates[0].content.parts[0].text;
                            text = text.replace(/```json/g, '').replace(/```/g, '').trim();

                            const questions = JSON.parse(text);
                            newQuiz.questions = questions;
                        } catch (e) {
                            console.error(e);
                            showAlert("生成失敗", "AI 出題失敗: " + e.message, "error");
                        } finally {
                            isGenerating.value = false;
                        }
                    };

                    const parseManualInput = () => {
                        const lines = manualInput.value.split('\n').filter(l => l.trim());
                        const parsedQuestions = [];

                        lines.forEach(line => {
                            const parts = line.split(/[\t,]/).map(p => p.trim());
                            if (parts.length >= 6) {
                                const title = parts[0];
                                let ansRaw = parts[1].toLowerCase();
                                const options = parts.slice(2, 6);
                                const explanation = parts[6] || '';

                                let answer = 1;
                                if (['a', '1'].includes(ansRaw)) answer = 1;
                                else if (['b', '2'].includes(ansRaw)) answer = 2;
                                else if (['c', '3'].includes(ansRaw)) answer = 3;
                                else if (['d', '4'].includes(ansRaw)) answer = 4;

                                parsedQuestions.push({
                                    title, options, answer, explanation, difficulty: '一般'
                                });
                            }
                        });

                        if (parsedQuestions.length === 0) {
                            showAlert("解析錯誤", "格式無法解析，請檢查分隔符號", "error");
                        } else {
                            newQuiz.questions.push(...parsedQuestions);
                            showAlert("解析成功", `成功加入 ${parsedQuestions.length} 題`, "success");
                            manualInput.value = ''; // Clear input after adding
                        }
                    };

                    const openCreateModal = () => {
                        editingQuizId.value = null; // Reset editing state
                        newQuiz.title = '';
                        newQuiz.category = '';
                        newQuiz.questions = [];
                        newQuiz.questionType = 'multiple-choice';
                        newQuiz.readingPassage = '';
                        aiSourceText.value = '';
                        aiImageBase64.value = '';
                        manualInput.value = '';
                        // Reset reading config
                        readingConfig.textSource = 'paste';
                        readingConfig.topic = '';
                        readingConfig.language = '繁中';
                        readingConfig.pirlsLevels = { retrieval: 2, inference: 2, interpretation: 1, evaluation: 1 };
                        showCreateQuiz.value = true;
                        nextTick(() => Prism.highlightAll());
                    };

                    // Reading comprehension functions
                    const canGenerateReading = computed(() => {
                        const hasContent = newQuiz.readingPassage.trim();
                        const hasQuestions = Object.values(readingConfig.pirlsLevels).some(level => level > 0);
                        return hasContent && hasQuestions;
                    });

                    const handleTextFileUpload = async (event) => {
                        const file = event.target.files[0];
                        if (!file) return;

                        try {
                            const text = await file.text();
                            newQuiz.readingPassage = text;
                            showAlert("上傳成功", "文本檔案已上傳", "success");
                            nextTick(() => Prism.highlightAll());
                        } catch (error) {
                            showAlert("上傳失敗", "無法讀取檔案內容", "error");
                        }
                    };

                    const generateReadingComprehension = async () => {
                        if (!canGenerateReading.value) return;

                        const passageText = newQuiz.readingPassage.trim();

                        if (!passageText) {
                            showAlert("錯誤", "請先提供閱讀文本", "warning");
                            return;
                        }

                        // Generate questions using AI
                        await generateReadingQuestions(passageText);
                    };

                    const generatePassageFromTopic = async () => {
                        isGenerating.value = true;
                        try {
                            const key = customApiKey.value;
                            if (!key) {
                                showAlert("API Key 缺失", "請先在設定中輸入您的 Gemini API Key", "warning");
                                isGenerating.value = false;
                                return;
                            }

                            // 語言映射
                            const languageMap = {
                                '繁中': 'Traditional Chinese (繁體中文)',
                                '英文': 'English',
                                '日文': 'Japanese (日本語)',
                                '韓文': 'Korean (한국어)'
                            };
                            const targetLanguage = languageMap[readingConfig.language] || 'Traditional Chinese (繁體中文)';

                            const prompt = `Please generate a reading passage about "${readingConfig.topic}" in ${targetLanguage}. The passage should be suitable for middle school students, approximately 300-500 words, educational and engaging. Output only the text content without any title or explanation.`;

                            const contents = [{
                                parts: [{ text: prompt }]
                            }];

                            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                            const response = await fetch(url, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ contents })
                            });

                            const data = await response.json();

                            if (data.error) throw new Error(data.error.message);

                            const result = data.candidates[0].content.parts[0].text.trim();
                            newQuiz.readingPassage = result;
                            showAlert("生成成功", "閱讀文本已生成，您可以查看和修改後再生成題目", "success");
                            nextTick(() => Prism.highlightAll());

                        } catch (error) {
                            console.error('Generate passage error:', error);
                            showAlert("生成失敗", "無法生成文本: " + error.message, "error");
                        } finally {
                            isGenerating.value = false;
                        }
                    };

                    const generateReadingQuestions = async (passageText) => {
                        isGenerating.value = true;

                        try {
                            const key = customApiKey.value;
                            if (!key) {
                                showAlert("API Key 缺失", "請先在設定中輸入您的 Gemini API Key", "warning");
                                isGenerating.value = false;
                                return;
                            }

                            // 語言映射
                            const languageMap = {
                                '繁中': 'Traditional Chinese (繁體中文)',
                                '英文': 'English',
                                '日文': 'Japanese (日本語)',
                                '韓文': 'Korean (한국어)'
                            };
                            const targetLanguage = languageMap[readingConfig.language] || 'Traditional Chinese (繁體中文)';

                            // PIRLS層次說明（英文版本，讓AI理解）
                            const pirlsPrompts = {
                                retrieval: "Retrieval: Finding explicitly stated information, facts, and details from the text",
                                inference: "Inference: Making simple inferences and logical reasoning based on the text",
                                interpretation: "Interpretation: Integrating information from different parts of the text to understand main ideas and meanings",
                                evaluation: "Evaluation: Evaluating the content, critically thinking about the author's viewpoint and writing techniques"
                            };

                            const totalQuestions = Object.values(readingConfig.pirlsLevels).reduce((sum, count) => sum + count, 0);

                            let prompt = `Generate ${totalQuestions} multiple-choice questions based on the following reading passage in ${targetLanguage}. Follow the PIRLS reading comprehension framework:

Text:
${passageText}

Question distribution by PIRLS levels:
`;

                            for (const [level, count] of Object.entries(readingConfig.pirlsLevels)) {
                                if (count > 0) {
                                    prompt += `- ${pirlsPrompts[level]}: ${count} questions\n`;
                                }
                            }

                            prompt += `
IMPORTANT: Output must be in ${targetLanguage}. All questions, options, and explanations must be in ${targetLanguage}.

Output format must be a strict JSON Array without Markdown markers:
[
  {
    "title": "Question content in ${targetLanguage}",
    "options": ["Option A in ${targetLanguage}", "Option B in ${targetLanguage}", "Option C in ${targetLanguage}", "Option D in ${targetLanguage}"],
    "answer": Correct answer number (1-4),
    "difficulty": "簡單/一般/困難" (or equivalent in ${targetLanguage}),
    "explanation": "Detailed explanation in ${targetLanguage}",
    "pirlsLevel": "retrieval/inference/interpretation/evaluation"
  }
]`;

                            const contents = [{
                                parts: [{ text: prompt }]
                            }];

                            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                            const response = await fetch(url, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ contents })
                            });

                            const data = await response.json();

                            if (data.error) throw new Error(data.error.message);

                            let text = data.candidates[0].content.parts[0].text;
                            text = text.replace(/```json/g, '').replace(/```/g, '').trim();

                            const questions = JSON.parse(text);
                            newQuiz.questions = questions;

                            showAlert("生成成功", `已生成${questions.length}道閱讀測驗題目`, "success");

                        } catch (error) {
                            console.error('Generate questions error:', error);
                            showAlert("生成失敗", "無法生成題目: " + error.message, "error");
                        } finally {
                            isGenerating.value = false;
                        }
                    };

                    // Helper function for PIRLS level names
                    const getPirlsLevelName = (level) => {
                        const levelNames = {
                            'retrieval': '提取訊息',
                            'inference': '推論理解',
                            'interpretation': '詮釋整合',
                            'evaluation': '評估鑑賞'
                        };
                        return levelNames[level] || level;
                    };

                    // 新增：編輯題庫功能
                    const editQuiz = (quiz) => {
                        editingQuizId.value = quiz.id;
                        newQuiz.title = quiz.title;
                        newQuiz.category = quiz.category;
                        newQuiz.questionType = quiz.questionType || 'multiple-choice';
                        newQuiz.readingPassage = quiz.readingPassage || '';
                        newQuiz.questions = JSON.parse(JSON.stringify(quiz.questions)); // Deep copy to prevent mutating original before save

                        // Clear source inputs as we are editing existing result
                        aiSourceText.value = '';
                        aiImageBase64.value = '';
                        manualInput.value = '';

                        showCreateQuiz.value = true;
                        nextTick(() => Prism.highlightAll());
                    };

                    const duplicateQuiz = (quiz) => {
                        editingQuizId.value = null; // duplicating creates a NEW quiz
                        newQuiz.title = quiz.title + ' (副本)';
                        newQuiz.category = quiz.category;
                        newQuiz.questionType = quiz.questionType || 'multiple-choice';
                        newQuiz.readingPassage = quiz.readingPassage || '';
                        newQuiz.questions = JSON.parse(JSON.stringify(quiz.questions));
                        showCreateQuiz.value = true;
                        aiSourceText.value = '';
                        aiImageBase64.value = '';
                        manualInput.value = '';
                        nextTick(() => Prism.highlightAll());
                    };

                    const saveQuiz = async () => {
                        if (!newQuiz.title) { showAlert("欄位缺失", "請輸入測驗標題", "warning"); return; }

                        try {
                            const quizData = {
                                title: newQuiz.title,
                                category: newQuiz.category || '未分類',
                                questionType: newQuiz.questionType,
                                readingPassage: newQuiz.readingPassage,
                                questions: newQuiz.questions,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(), // Update timestamp on edit? Maybe better to keep original created, add updated. For simplicity, just update.
                                teacherId: user.value.uid
                            };

                            if (editingQuizId.value) {
                                // Update existing
                                await db.collection('quizzes').doc(editingQuizId.value).update(quizData);
                                showAlert("成功", "題庫更新成功！", "success");
                            } else {
                                // Create new
                                await db.collection('quizzes').add(quizData);
                                showAlert("成功", "題庫建立成功！", "success");
                            }

                            showCreateQuiz.value = false;
                            // Reset form
                            newQuiz.title = '';
                            newQuiz.category = '';
                            newQuiz.questions = [];
                        } catch (e) {
                            showAlert("儲存失敗", e.message, "error");
                        }
                    };

                    // Question Editor Logic
                    const addQuestion = () => {
                        currentEditingQuestionIndex.value = -1;
                        // Reset to default blank question
                        Object.assign(currentEditingQuestion, {
                            title: '',
                            options: ['', '', '', ''],
                            answer: 1,
                            difficulty: '一般',
                            explanation: ''
                        });
                        showQuestionEditor.value = true;
                    };

                    const editQuestion = (index) => {
                        currentEditingQuestionIndex.value = index;
                        // Copy question data to editor
                        Object.assign(currentEditingQuestion, JSON.parse(JSON.stringify(newQuiz.questions[index])));
                        showQuestionEditor.value = true;
                    };

                    const saveQuestion = () => {
                        if (!currentEditingQuestion.title) { showAlert("錯誤", "請輸入題目", "warning"); return; }
                        if (currentEditingQuestion.options.some(o => !o)) { showAlert("錯誤", "請填寫所有選項", "warning"); return; }

                        const questionData = JSON.parse(JSON.stringify(currentEditingQuestion));

                        if (currentEditingQuestionIndex.value === -1) {
                            // Add new
                            newQuiz.questions.push(questionData);
                        } else {
                            // Update existing
                            newQuiz.questions[currentEditingQuestionIndex.value] = questionData;
                        }
                        showQuestionEditor.value = false;
                    };

                    const deleteQuestion = async (index) => {
                        const confirm = await showConfirm("刪除確認", "確定刪除此題目？");
                        if (confirm) {
                            newQuiz.questions.splice(index, 1);
                        }
                    };

                    const deleteQuiz = async (id) => {
                        const confirm = await showConfirm("刪除確認", "確定要刪除此題庫嗎？此動作無法復原。");
                        if (confirm) {
                            await db.collection('quizzes').doc(id).delete();
                        }
                    };

                    const copyQuizLink = (id) => {
                        showAlert("提示", `測驗 ID: ${id}\n學生選擇時可識別。`, "info");
                    };

                    // --- Analytics ---
                    const viewAnalytics = async (quiz) => {
                        selectedAnalyticsQuiz.value = quiz;
                        showAnalytics.value = true;
                        selectedStudentResult.value = null; // Reset detail view
                        analyticsTab.value = 'score'; // Reset tab

                        // Fix: Remove orderBy to avoid index error. Sort in client side.
                        const snap = await db.collection('results')
                            .where('quizId', '==', quiz.id)
                            .get();

                        const results = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        // Sort by score descending
                        analyticsData.value = results.sort((a, b) => b.score - a.score);

                        nextTick(renderChart);
                    };

                    const exportCSV = () => {
                        if (!analyticsData.value.length || !selectedAnalyticsQuiz.value) return;

                        const quiz = selectedAnalyticsQuiz.value;
                        const results = analyticsData.value;

                        // 1. Calculate Summary
                        const totalStudents = results.length;
                        const totalScore = results.reduce((acc, cur) => acc + cur.score, 0);
                        const avgScore = totalStudents > 0 ? (totalScore / totalStudents).toFixed(1) : 0;

                        // 2. Build CSV Content
                        let csvContent = "\uFEFF"; // BOM for Excel Chinese support

                        // Title & Summary
                        csvContent += `測驗名稱,${quiz.title}\n`;
                        csvContent += `總人數,${totalStudents},平均分數,${avgScore}\n\n`;

                        // Headers
                        let headers = ["學生姓名", "得分", "交卷時間"];
                        quiz.questions.forEach((q, i) => {
                            headers.push(`Q${i + 1} (正確:${String.fromCharCode(64 + parseInt(q.answer))})`);
                        });
                        csvContent += headers.join(",") + "\n";

                        // Rows
                        results.forEach(res => {
                            let row = [
                                res.studentName,
                                res.score,
                                formatDate(res.timestamp).replace(',', ' ') // Avoid comma issues
                            ];

                            quiz.questions.forEach((q, i) => {
                                const studentAnsIdx = res.answers[i]; // 1-based index
                                if (!studentAnsIdx) {
                                    row.push("未作答");
                                } else {
                                    const letter = String.fromCharCode(64 + parseInt(studentAnsIdx));
                                    const isCorrect = studentAnsIdx == q.answer;
                                    row.push(isCorrect ? letter : `${letter} (X)`);
                                }
                            });
                            csvContent += row.join(",") + "\n";
                        });

                        // 3. Download
                        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                        const link = document.createElement("a");
                        const url = URL.createObjectURL(blob);
                        link.setAttribute("href", url);
                        link.setAttribute("download", `${quiz.title}_成績報表.csv`);
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    };

                    const viewStudentDetails = (result) => {
                        selectedStudentResult.value = result;
                    };

                    const closeStudentDetails = () => {
                        selectedStudentResult.value = null;
                    };

                    const getScoreColor = (s) => {
                        if (s >= 80) return 'text-green-600';
                        if (s >= 60) return 'text-yellow-600';
                        return 'text-red-600';
                    };

                    // --- Question Statistics Logic ---
                    const questionStats = computed(() => {
                        if (!selectedAnalyticsQuiz.value || !analyticsData.value.length) return [];

                        return selectedAnalyticsQuiz.value.questions.map((q, idx) => {
                            let correctCount = 0;
                            const wrongStudents = [];

                            analyticsData.value.forEach(res => {
                                // answers[idx] is 1-based answer index from student
                                const studentAns = res.answers ? res.answers[idx] : null;
                                if (studentAns == q.answer) {
                                    correctCount++;
                                } else {
                                    wrongStudents.push({
                                        name: res.studentName,
                                        choice: studentAns
                                    });
                                }
                            });

                            const total = analyticsData.value.length;
                            const rate = total === 0 ? 0 : Math.round((correctCount / total) * 100);

                            return {
                                question: q,
                                index: idx,
                                rate,
                                wrongStudents
                            };
                        });
                    });

                    const teacherHighlightedPassage = computed(() => {
                        if (!selectedAnalyticsQuiz.value || !selectedAnalyticsQuiz.value.readingPassage) {
                            return '';
                        }
                        const text = selectedAnalyticsQuiz.value.readingPassage;

                        if (!selectedStudentResult.value || !selectedStudentResult.value.highlights || selectedStudentResult.value.highlights.length === 0) {
                            return escapeHtml(text);
                        }

                        const studentHighlights = selectedStudentResult.value.highlights;

                        const sortedHighlights = [...studentHighlights].sort((a, b) => a.start - b.start);

                        let lastIndex = 0;
                        let output = '';

                        sortedHighlights.forEach(h => {
                            output += escapeHtml(text.substring(lastIndex, h.start));
                            output += `<mark id="teacher-highlight-${h.id}" class="highlight-${h.color}">${escapeHtml(text.substring(h.start, h.end))}</mark>`;
                            lastIndex = h.end;
                        });

                        output += escapeHtml(text.substring(lastIndex));

                        return output;
                    });

                    const renderChart = () => {
                        const ctx = document.getElementById('scoreChart');
                        if (!ctx) return;

                        const scores = analyticsData.value.map(d => d.score);
                        const ranges = [0, 0, 0, 0, 0]; // 0-20, 21-40, 41-60, 61-80, 81-100
                        scores.forEach(s => {
                            if (s <= 20) ranges[0]++;
                            else if (s <= 40) ranges[1]++;
                            else if (s <= 60) ranges[2]++;
                            else if (s <= 80) ranges[3]++;
                            else ranges[4]++;
                        });

                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['0-20分', '21-40分', '41-60分', '61-80分', '81-100分'],
                                datasets: [{
                                    label: '人數分佈',
                                    data: ranges,
                                    backgroundColor: ['#ef4444', '#f97316', '#eab308', '#84cc16', '#22c55e'],
                                    borderRadius: 5
                                }]
                            },
                            options: {
                                responsive: true,
                                scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                            }
                        });
                    };



                    // --- New Highlighter State ---
                    const passageContainer = ref(null);
                    const highlights = ref([]); // {start, end, color, id}
                    const nextHighlightId = ref(0);

                    // --- New Highlighter Functions ---
                    const highlightedPassage = computed(() => {
                        if (!activeQuiz.value || !activeQuiz.value.readingPassage) return '';

                        const text = activeQuiz.value.readingPassage;
                        // Sort highlights by start index to process them in order
                        const sortedHighlights = [...highlights.value].sort((a, b) => a.start - b.start);

                        let lastIndex = 0;
                        let output = '';

                        sortedHighlights.forEach(h => {
                            // Append text before the current highlight
                            output += escapeHtml(text.substring(lastIndex, h.start));
                            // Append the highlighted text, wrapped in a <mark> tag
                            output += `<mark id="highlight-${h.id}" data-highlight-id="${h.id}" class="highlight-${h.color}">${escapeHtml(text.substring(h.start, h.end))}</mark>`;
                            lastIndex = h.end;
                        });

                        // Append the remaining text after the last highlight
                        output += escapeHtml(text.substring(lastIndex));

                        return output;
                    });

                    const escapeHtml = (unsafe) => {
                        if (typeof unsafe !== 'string') return '';
                        return unsafe
                            .replace(/&/g, "&amp;")
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;")
                            .replace(/"/g, "&quot;")
                            .replace(/'/g, "&#039;");
                    }

                    const getSelectionDetails = () => {
                        const selection = window.getSelection();
                        if (!selection || selection.rangeCount === 0 || selection.isCollapsed) {
                            return null;
                        }

                        const range = selection.getRangeAt(0);
                        const container = passageContainer.value;

                        // Ensure the selection is within the passage container
                        if (!container || !container.contains(range.commonAncestorContainer)) {
                            return null;
                        }

                        // Calculate the start and end offsets relative to the container's text content
                        const preSelectionRange = document.createRange();
                        preSelectionRange.selectNodeContents(container);
                        preSelectionRange.setEnd(range.startContainer, range.startOffset);
                        const start = preSelectionRange.toString().length;
                        const end = start + range.toString().length;

                        return { start, end };
                    };

                    const applyHighlight = (color) => {
                        const details = getSelectionDetails();
                        if (!details) {
                            showAlert("提示", "請先選取您要畫記的文字。", "info");
                            return;
                        }

                        let { start, end } = details;

                        // Merge overlapping or adjacent highlights
                        let merged = false;
                        highlights.value.forEach(h => {
                            // Check for overlap or adjacency
                            if (Math.max(h.start, start) <= Math.min(h.end, end) && h.color === color) {
                                h.start = Math.min(h.start, start);
                                h.end = Math.max(h.end, end);
                                merged = true;
                            }
                        });

                        if (!merged) {
                            // If no merge happened, add as a new highlight
                            highlights.value.push({
                                id: nextHighlightId.value++,
                                start,
                                end,
                                color
                            });
                        }

                        // After adding, clean up highlights that are fully contained within others
                        const cleanedHighlights = [];
                        highlights.value.sort((a, b) => a.start - b.start).forEach(h => {
                            const last = cleanedHighlights[cleanedHighlights.length - 1];
                            if (last && last.end >= h.end) {
                                // Current highlight is contained, do nothing
                            } else if (last && last.end >= h.start && last.color === h.color) {
                                // Overlapping or adjacent, merge them
                                last.end = Math.max(last.end, h.end);
                            } else {
                                cleanedHighlights.push(h);
                            }
                        });
                        highlights.value = cleanedHighlights;


                        // Deselect text
                        window.getSelection().removeAllRanges();
                    };

                    const handlePassageClick = async (event) => {
                        // Check if a highlight mark was clicked
                        if (event.target.tagName === 'MARK') {
                            const id = parseInt(event.target.dataset.highlightId, 10);
                            const confirm = await showConfirm('移除重點', '您確定要移除這個畫記嗎？');
                            if (confirm) {
                                // Remove the highlight with the matching ID
                                highlights.value = highlights.value.filter(h => h.id !== id);
                            }
                        }
                    };


                    // --- Student Logic (Updated with Randomization) ---

                    // 1. 新增：洗牌演算法 (Fisher-Yates Shuffle)
                    const generateShuffledIndices = (length) => {
                        const indices = Array.from({ length }, (_, i) => i);
                        for (let i = indices.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [indices[i], indices[j]] = [indices[j], indices[i]];
                        }
                        return indices;
                    };

                    const startQuiz = async () => {
                        if (!activeQuizId.value) {
                            showAlert("無法開始", "目前沒有正在進行中的測驗，請等待老師啟用。", "warning");
                            return;
                        }

                        try {
                            const doc = await db.collection('quizzes').doc(activeQuizId.value).get();
                            if (doc.exists) {
                                const quizData = doc.data();
                                
                                // --- 修改開始：題目隨機排序邏輯 ---
                                
                                // 1. 取得原始題目陣列
                                const originalQuestions = quizData.questions || [];
                                
                                // 2. 產生不重複的亂數索引陣列 (例如: [2, 0, 1, 3])
                                const shuffledIndices = generateShuffledIndices(originalQuestions.length);
                                
                                // 3. 根據亂數陣列重新排列題目，並加入 _originalIndex 標記
                                // 這樣我們既改變了顯示順序，又保留了它原本是第幾題的資訊
                                const randomizedQuestions = shuffledIndices.map(originalIndex => {
                                    // 複製原題目物件，並塞入 _originalIndex
                                    return {
                                        ...originalQuestions[originalIndex],
                                        _originalIndex: originalIndex
                                    };
                                });

                                // 4. 將洗牌後的題目放回 quizData
                                quizData.questions = randomizedQuestions;
                                
                                // --- 修改結束 ---

                                activeQuiz.value = { id: doc.id, ...quizData };
                                currentQuestionIndex.value = 0;
                                studentAnswers.value = [];
                                currentAnswer.value = null;
                                highlights.value = []; // Clear highlights
                                nextHighlightId.value = 0; // Reset ID counter
                                goToView('quiz');
                            } else {
                                showAlert("錯誤", "找不到該測驗，可能已被刪除。", "error");
                            }
                        } catch (e) {
                            console.error(e);
                            showAlert("錯誤", "載入測驗失敗", "error");
                        }
                    };

                    const selectAnswer = (idx) => {
                        currentAnswer.value = idx;
                    };

                    const prevQuestion = () => {
                        if (currentQuestionIndex.value > 0) {
                            currentQuestionIndex.value--;
                            // studentAnswers 記錄的是當下(亂序後)的順序，這在作答時是正確的 UI 行為
                            currentAnswer.value = studentAnswers.value[currentQuestionIndex.value] || null;
                        }
                    };

                    const nextQuestion = () => {
                        if (currentAnswer.value === null) { showAlert("請選擇", "請先選擇一個答案再繼續", "warning"); return; }
                        
                        // 儲存答案 (此時 studentAnswers 的順序是對應到亂序後的題目)
                        studentAnswers.value[currentQuestionIndex.value] = currentAnswer.value;

                        currentQuestionIndex.value++;
                        currentAnswer.value = studentAnswers.value[currentQuestionIndex.value] || null;
                    };

                    const progressPercent = computed(() => {
                        if (!activeQuiz.value) return 0;
                        return ((currentQuestionIndex.value + 1) / activeQuiz.value.questions.length) * 100;
                    });

                    const submitQuiz = async () => {
                        if (currentAnswer.value === null) { showAlert("請選擇", "請先選擇一個答案", "warning"); return; }
                        
                        // 儲存最後一題的答案
                        studentAnswers.value[currentQuestionIndex.value] = currentAnswer.value;

                        // --- 修改開始：成績計算與答案還原 ---

                        let correctCount = 0;
                        // 這裡的 activeQuiz.value.questions 已經是亂序過的
                        // studentAnswers.value 也是對應亂序過的
                        // 所以直接比對 (idx 對 idx) 是正確的
                        activeQuiz.value.questions.forEach((q, idx) => {
                            if (q.answer == studentAnswers.value[idx]) correctCount++;
                        });

                        score.value = Math.round((correctCount / activeQuiz.value.questions.length) * 100);

                        // 關鍵步驟：還原答案順序
                        // 為了讓老師看到的報表順序正確，我們必須把學生亂序的答案填回原始的索引位置
                        const originalOrderAnswers = new Array(activeQuiz.value.questions.length);
                        
                        activeQuiz.value.questions.forEach((q, currentIdx) => {
                            // q._originalIndex 是我們在 startQuiz 加入的原始索引
                            // studentAnswers.value[currentIdx] 是學生針對這題的回答
                            originalOrderAnswers[q._originalIndex] = studentAnswers.value[currentIdx];
                        });

                        // 儲存到資料庫
                        await db.collection('results').add({
                            quizId: activeQuiz.value.id,
                            studentName: studentName.value,
                            score: score.value,
                            answers: originalOrderAnswers, // 這裡存入還原順序後的答案
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            highlights: activeQuiz.value.questionType === 'reading-comprehension' ? highlights.value : []
                        });

                        // --- 修改結束 ---

                        goToView('result');
                    };

                    // --- IDE Editor Helpers ---
                    const highlightCode = () => {
                        nextTick(() => {
                            Prism.highlightAll();
                        });
                    };

                    const syncScroll = (event) => {
                        const textarea = event.target;
                        const pre = textarea.previousElementSibling;
                        if (pre) {
                            pre.scrollTop = textarea.scrollTop;
                            pre.scrollLeft = textarea.scrollLeft;
                        }
                    };

                    return {
                        configInput, isConfigured, parseAndSaveConfig, clearFirebaseConfig,
                        customApiKey, showSettingsModal, showConfigEdit, showTutorialModal, shareUrl, studentShareUrl, isStudentView, openQrModal, closeQrModal, showQrModal, qrModalTitle, toggleSettings, resetConfig, copyShareUrl, copyRules, isApiKeySaved, checkConfigAndGo,
                        user, currentView, goToView,
                        // Modal
                        modalState, showAlert, showConfirm, handleConfirm, handleCancel,
                        // Teacher
                        teacherPassword, verifyTeacher, quizzes, showCreateQuiz, createMode, openCreateModal, duplicateQuiz, editQuiz, editingQuizId,
                        aiSourceText, aiImageBase64, isPdfLoading, isGenerating, manualInput, aiConfig, newQuiz, activeQuizId, selectedCategory, uniqueCategories, filteredQuizzes, getActiveQuizTitle,
                        // Reading Comprehension
                        readingConfig, canGenerateReading, handleTextFileUpload, generateReadingComprehension, generatePassageFromTopic, generateReadingQuestions, getPirlsLevelName,
                        // Question Editor
                        showQuestionEditor, currentEditingQuestion, currentEditingQuestionIndex, addQuestion, editQuestion, saveQuestion, deleteQuestion,
                        handleImageUpload, handlePdfUpload, generateQuestions, parseManualInput, saveQuiz, deleteQuiz, activateQuiz, deactivateQuiz, formatDate,
                        // Analytics
                        viewAnalytics, showAnalytics, selectedAnalyticsQuiz, analyticsData, analyticsTab, questionStats, teacherHighlightedPassage, getScoreColor, selectedStudentResult, viewStudentDetails, closeStudentDetails, exportCSV,
                        // Student
                        studentName, selectedQuizId, startQuiz,
                        activeQuiz, currentQuestionIndex, currentAnswer, selectAnswer, nextQuestion, prevQuestion, submitQuiz,
                        progressPercent, score, studentAnswers,
                        // Highlighter
                        passageContainer, highlights, highlightedPassage, applyHighlight, handlePassageClick,
                        // Logs
                        updateLog,
                        // IDE Helper
                        highlightCode, syncScroll
                    };
                }
            }).mount('#app');
        })(); // End of IIFE
    </script>

</body>


</html>
